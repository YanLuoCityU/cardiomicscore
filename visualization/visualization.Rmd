---
title: "CardiOmicScore"
author: "Yan Luo"
date: '2025-08-04'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "/your path/cardiomicscore")

# data processing
library(skimr)
library(tidyverse)
library(gtsummary)
library(flextable)
library(stringr)
library(arrow)
library(scales)
library(janitor)
library(tictoc)
library(tidytext)

# visualization
library(ggplot2)
library(ggtext)
library(ggsci)
library(glue)
library(patchwork)
library(MetBrewer)
library(geomtextpath)
library(showtext)

# analysis
library(dcurves)
library(pracma)

# --- Custom Facet Function ---
FacetEqualWrap <- ggproto(
  "FacetEqualWrap", FacetWrap,
  train_scales = function(self, x_scales, y_scales, layout, data, params) {
    if (is.null(x_scales) || is.null(y_scales)) {
      stop("X and Y scales required for facet_equal_wrap")
    }
    ggproto_parent(FacetWrap, self)$train_scales(x_scales, y_scales, layout, data, params)
    for (layer_data in data) {
      match_id <- match(layer_data$PANEL, layout$PANEL)
      x_vars <- intersect(x_scales[[1]]$aesthetics, names(layer_data))
      y_vars <- intersect(y_scales[[1]]$aesthetics, names(layer_data))
      SCALE_X <- layout$SCALE_X[match_id]
      ggplot2:::scale_apply(layer_data, y_vars, "train", SCALE_X, x_scales)
      SCALE_Y <- layout$SCALE_Y[match_id]
      ggplot2:::scale_apply(layer_data, x_vars, "train", SCALE_Y, y_scales)
    }
  }
)
facet_wrap_equal <- function(...) {
  facet_super <- facet_wrap(...)
  ggproto(NULL, FacetEqualWrap,
    shrink = facet_super$shrink,
    params = facet_super$params
  )
}

```

------------------------------------------------------------------------------------

# Transform gwas summary statistics from txt to word

```{r}

# -----------------------------------------------------------------------------
# 1. CONVERSION SCRIPT
# -----------------------------------------------------------------------------
input_dir <- "data/gwas_summary_statistics"
files_to_convert <- list.files(
  path = input_dir, 
  pattern = "\\.txt$", 
  full.names = TRUE
)

if (length(files_to_convert) == 0) {
  print(paste("No .txt files found in the directory:", input_dir))
} else {
  print(paste("Found", length(files_to_convert), "files to convert. Starting process..."))
  for (file_path in files_to_convert) {
    print(paste("Processing:", basename(file_path)))
    gwas_data <- readr::read_tsv(file_path, col_types = cols(.default = "c"))
    ft <- flextable(gwas_data)
    ft <- autofit(ft)
    ft <- theme_box(ft)
    output_path <- stringr::str_replace(file_path, "\\.txt$", ".docx")
    save_as_docx(ft, path = output_path)
    
    print(paste(" -> Successfully saved to:", basename(output_path)))
  }
  
  print("--- All files have been converted successfully! ---")
}

```

------------------------------------------------------------------------------------

# Descriptive statistics

## Supplementary Table 1: Clinical predictors

```{r}

# =============================================================================
# 1. SETUP
# =============================================================================
categorical_vars <- c(
  "male", "ethnicity", "current_smoking", "daily_drinking", "healthy_sleep", 
  "physical_act", "healthy_diet", "social_active", "family_heart_hist", 
  "family_stroke_hist", "family_hypt_hist", "family_diab_hist", "diab_hist", 
  "hypt_hist", "lipidlower", "antihypt",
  "cad", "stroke", "hf", "af", "pad", "vte"
)

var_need <- c(
  "age", "male", "ethnicity", "townsend", "current_smoking", "daily_drinking",  "healthy_sleep", "physical_act", "healthy_diet", "social_active", "family_heart_hist", "family_stroke_hist", "family_hypt_hist", "family_diab_hist", "hypt_hist", "diab_hist", "lipidlower", "antihypt", "sbp", "dbp", "height", "weight", "waist_cir", "waist_hip_ratio", "bmi", "wbc", "lc", "mc", "nc", "eos", "baso", "plt", "hb", "hct", "cad", "stroke", "hf", "af", "pad", "vte"
)

variable_labels <- list(
  age ~ "Age (years)", male ~ "Male", ethnicity ~ "Ethnicity",
  townsend ~ "Townsend deprivation index", current_smoking ~ "Current smoking",
  daily_drinking ~ "Daily alcohol intake", healthy_sleep ~ "Healthy sleep",
  physical_act ~ "Physical activity", healthy_diet ~ "Healthy diet",
  social_active ~ "Social connection", family_heart_hist ~ "Family history of heart disease",
  family_stroke_hist ~ "Family history of stroke", family_hypt_hist ~ "Family history of hypertension",
  family_diab_hist ~ "Family history of diabetes", sbp ~ "Systolic blood pressure",
  dbp ~ "Diastolic blood pressure", height ~ "Height", weight ~ "Weight",
  waist_cir ~ "Waist circumference", waist_hip_ratio ~ "Waist-hip ratio",
  bmi ~ "Body mass index", lipidlower ~ "Lipid-lowering medication",
  antihypt ~ "Antihypertensive medication", diab_hist ~ "Diabetes",
  hypt_hist ~ "Hypertension", baso ~ "Basophill count", eos ~ "Eosinophill count",
  hct ~ "Haematocrit percentage", hb ~ "Haemoglobin concentration",
  lc ~ "Lymphocyte count", mc ~ "Monocyte count", nc ~ "Neutrophill count",
  plt ~ "Platelet count", wbc ~ "Leukocyte count", 
  cad ~ "Coronary artery disease", stroke ~ "Stroke", hf ~ "Heart failure",
  af ~ "Atrial fibrillation", pad ~ "Peripheral artery disease", vte ~ "Venous thromboembolism"
)

format_p_exact <- function(p) {
  ifelse(p < 0.001, scales::scientific(p, digits = 3), scales::pvalue(p, accuracy = 0.001))
}

# =============================================================================
# 2. FUNCTION: To Create the Baseline COMPARISON Table
# =============================================================================
create_baseline_table <- function(file_group, group_name) {
  # --- Load and Combine Data ---
  all_data <- map_dfr(file_group, ~read_csv(.x, col_types = cols(.default = "d")) %>% mutate(dataset = str_extract(basename(.x), "(train|val|internal_test|external_test)")))

  # --- Pre-process Data ---
  processed_data <- all_data %>%
    select(dataset, all_of(var_need)) %>%
    mutate(
      dataset = case_when(
        dataset == "train" ~ "Train",
        dataset == "val" ~ "Validation",
        dataset == "internal_test" ~ "Geographic testing",
        dataset == "external_test" ~ "Hold-out testing",
        TRUE ~ NA_character_
      ),
      dataset = factor(dataset), 
      ethnicity = case_when(
        ethnicity == 0 ~ "White", ethnicity == 1 ~ "Asian",
        ethnicity == 2 ~ "Black", ethnicity == 3 ~ "Others",
        TRUE ~ NA_character_
      ) %>% factor(levels = c("White", "Black", "Asian", "Others")),
      across(
        .cols = all_of(setdiff(categorical_vars, "ethnicity")),
        .fns = ~factor(ifelse(. == 1, "Yes", "No"), levels = c("No", "Yes"))
      )
    )

  # --- Create Summary Table ---
  final_table <- processed_data %>%
    tbl_summary(
      by = dataset, 
      statistic = list(all_continuous() ~ "{median} ({p25}, {p75})", all_categorical() ~ "{n} ({p}%)"), 
      label = variable_labels, 
      digits = list(all_continuous() ~ 1, all_categorical() ~ c(0, 1), baso ~ 2), 
      missing = "no"
    ) %>%
    add_p(test = list(all_continuous() ~ "wilcox.test", all_categorical() ~ "chisq.test"), pvalue_fun = format_p_exact) %>%
    modify_header(label = "**Characteristic**", p.value = "**P-value**") %>%
    bold_p(t = 0.05) %>% bold_labels()

  # --- Save Table to Word Document ---
  output_dir <- file.path("results", "Table")
  if (!dir.exists(output_dir)) {dir.create(output_dir, recursive = TRUE)}
  output_path <- file.path(output_dir, paste0("Baseline_Table_", group_name, ".docx"))
  final_table %>% as_flex_table() %>% flextable::save_as_docx(path = output_path)
  print(paste("Successfully generated comparison table:", output_path))
  return(final_table)
}

# =============================================================================
# 3. EXECUTION: Generate All Requested Tables
# =============================================================================
data_folder <- "data/split_seed_raw-250901"

# --- Task 1: Generate Standalone Table for Hold-out Test Set ---
print("--- Generating standalone hold-out set table... ---")
holdout_file <- file.path(data_folder, "external_test_Clinical.csv")

holdout_data <- read_csv(holdout_file, col_types = cols(.default = "d")) %>%
  select(all_of(var_need)) %>%
  mutate(
    ethnicity = case_when(
      ethnicity == 0 ~ "White", ethnicity == 1 ~ "Asian",
      ethnicity == 2 ~ "Black", ethnicity == 3 ~ "Others", TRUE ~ NA_character_
    ) %>% factor(levels = c("White", "Black", "Asian", "Others")),
    across(
      .cols = all_of(setdiff(categorical_vars, "ethnicity")),
      .fns = ~factor(ifelse(. == 1, "Yes", "No"), levels = c("No", "Yes"))
    )
  )

holdout_table <- holdout_data %>%
  tbl_summary(
    statistic = list(all_continuous() ~ "{median} ({p25}, {p75})", all_categorical() ~ "{n} ({p}%)"),
    label = variable_labels, 
    digits = list(all_continuous() ~ 1, all_categorical() ~ c(0, 1), baso ~ 2), 
    missing = "no"
  ) %>%
  bold_labels() %>%
  modify_header(label = "**Characteristic**", stat_0 = "**Hold-out testing**")

output_dir <- file.path("results", "Table")
if (!dir.exists(output_dir)) {dir.create(output_dir, recursive = TRUE)}
holdout_output_path <- file.path(output_dir, "Baseline_Table_Multiomics_cohort.docx")
holdout_table %>% as_flex_table() %>% flextable::save_as_docx(path = holdout_output_path)
print(paste("Successfully generated standalone table:", holdout_output_path))

# --- Task 2: Generate Focused Comparison Tables for Each Omics Group ---
print("--- Generating focused comparison tables... ---")

omics_files <- list(
  Metabolomics = list(
    train = file.path(data_folder, "train_Metabolomics.csv"),
    val = file.path(data_folder, "val_Metabolomics.csv"),
    internal = file.path(data_folder, "internal_test_Metabolomics.csv")
  ),
  Proteomics = list(
    train = file.path(data_folder, "train_Proteomics.csv"),
    val = file.path(data_folder, "val_Proteomics.csv"),
    internal = file.path(data_folder, "internal_test_Proteomics.csv")
  )
)

for (omics_name in names(omics_files)) {
  current_files <- omics_files[[omics_name]]
  
  # Comparison 1: Train vs Validation
  create_baseline_table(
    file_group = c(current_files$train, current_files$val),
    group_name = paste0(omics_name, "_Train_vs_Val")
  )
  
  # Comparison 2: Train vs Geographic testing
  create_baseline_table(
    file_group = c(current_files$train, current_files$internal),
    group_name = paste0(omics_name, "_Train_vs_GeoTest")
  )
}

print("--- All tables generated successfully. ---")

# =============================================================================
# 4. CLEAN UP ENVIRONMENT
# =============================================================================
rm(categorical_vars, var_need, variable_labels, create_baseline_table, data_folder, holdout_file, holdout_data, holdout_table, output_dir, holdout_output_path, omics_files, omics_name, current_files)
   
print("--- Script finished and environment cleaned. ---")

```

## Supplementary Table 11: Metabolomics

```{r}

# =============================================================================
# 1. SETUP
# =============================================================================
load("data/dictionary/nmr_info.rda")
data_folder <- "data/split_seed_raw-250901"
external_test_data <- readr::read_csv(
  file.path(data_folder, "external_test_Metabolomics.csv"),
  col_types = cols(.default = "d")
)

# Get the list of metabolites to analyze
met_list <- nmr_info %>% 
  filter(Nightingale == TRUE & Type %in% c("Non-derived", "Composite") & !Description %in% c("Spectrometer-corrected alanine", "Glucose-lactate")) %>%
  pull(Biomarker)

dat <- external_test_data %>% 
  select(any_of(met_list))

# Calculate summary statistics
summary_stats <- dat %>%
  summarise(across(everything(), 
                   list(
                     missing = ~mean(is.na(.)) * 100,
                     median = ~median(., na.rm = TRUE),
                     Q25 = ~quantile(., 0.25, na.rm = TRUE),
                     Q75 = ~quantile(., 0.75, na.rm = TRUE)
                   ), .names = "{col}_{fn}")) %>%
  pivot_longer(cols = everything(),
               names_to = c("variable", "statistic"),
               names_pattern = "(.*)_(.*)",
               values_to = "value") %>%
  pivot_wider(names_from = "statistic", values_from = "value") %>%
  mutate(
    median_iqr = sprintf("%0.3f (%0.3f, %0.3f)", median, Q25, Q75),
    missing_rate = missing
  ) %>% 
  select(variable, median_iqr, missing_rate)

# Define the metabolite subgroup order
subgroup_order <- c(
  "Amino acids", "Branched-chain amino acids", "Aromatic amino acids",
  "Fluid balance", "Inflammation", "Fatty acids", 
  "Glycolysis related metabolites", "Ketone bodies", "Total lipids",
  "Cholesterol", "Free cholesterol", "Cholesteryl esters", "Phospholipids",
  "Triglycerides", "Other lipids", "Lipoprotein particle sizes", 
  "Lipoprotein particle concentrations", "Chylomicrons and extremely large VLDL",
  "Very large VLDL", "Large VLDL", "Medium VLDL", "Small VLDL", "Very small VLDL",
  "Large LDL", "Medium LDL", "Small LDL", "IDL", "Very large HDL", "Large HDL",
  "Medium HDL", "Small HDL", "Apolipoproteins"
)

# Combine summary stats with metabolite info
metabolites <- nmr_info %>% 
  filter(Nightingale == TRUE & Type %in% c("Non-derived", "Composite") & !Description %in% c("Spectrometer-corrected alanine", "Glucose-lactate")) %>%
  mutate(
    Sub.Group = ifelse(Sub.Group == "", Group, Sub.Group),
    Sub.Group = sub("\\s*\\(.*\\)", "", Sub.Group),
    Sub.Group = factor(Sub.Group, levels = subgroup_order)
  ) %>%
  select(Biomarker, Description, Units, Sub.Group, UKB.Field.ID) %>%
  arrange(Sub.Group, Biomarker) %>%
  left_join(summary_stats, by = c("Biomarker" = "variable"))


output_dir <- file.path("results", "Table")
if (!dir.exists(output_dir)) {dir.create(output_dir, recursive = TRUE)}
ft <- flextable(metabolites)
ft <- ft %>% 
  autofit() %>%
  theme_box() %>%
  bold(part = "header") %>%
  align(align = "left", part = "all") %>%
  colformat_double(j = "missing_rate", digits = 1) %>%
  set_caption(caption = "Supplementary Table 11: Descriptive statistics of metabolites in the external test set.")
output_path <- file.path(
  output_dir, 
  "Supplementary_Table_11_metabolomics_Multiomics_cohort.docx"
)
save_as_docx(ft, path = output_path)
print(paste("Analysis complete. Word table saved to:", output_path))

# =============================================================================
# 2. CLEAN UP ENVIRONMENT
# =============================================================================
rm(data_folder, external_test_data, met_list, dat, summary_stats, subgroup_order, metabolites, output_dir, ft, output_path, nmr_info)

```

## Supplementary Table 12: Proteomics

```{r}

# =============================================================================
# 1. SETUP
# =============================================================================
olink_assay <- read_delim(
  "data/dictionary/olink_assay.dat", 
  show_col_types = FALSE, 
  quote = "\t"
)

data_folder <- "data/split_seed_raw-250901"
external_test_data <- readr::read_csv(
  file.path(data_folder, "external_test_Proteomics.csv"),
  col_types = cols(.default = "d")
)

pro_list <- olink_assay %>% 
  filter(!Assay %in% c("GLIPR1", "NPM1", "PCOLCE")) %>%
  pull(Assay)

dat <- external_test_data %>% 
  select(any_of(pro_list))

# Calculate summary statistics
summary_stats <- dat %>%
  summarise(across(everything(), 
                   list(
                     missing = ~mean(is.na(.)) * 100,
                     median = ~median(., na.rm = TRUE),
                     Q25 = ~quantile(., 0.25, na.rm = TRUE),
                     Q75 = ~quantile(., 0.75, na.rm = TRUE)
                   ), .names = "{col}_{fn}")) %>%
  pivot_longer(cols = everything(),
               names_to = c("variable", "statistic"),
               names_pattern = "(.*)_(.*)",
               values_to = "value") %>%
  pivot_wider(names_from = "statistic", values_from = "value") %>%
  mutate(
    median_iqr = sprintf("%0.3f (%0.3f, %0.3f)", median, Q25, Q75),
    missing_rate = missing
  ) %>% 
  select(variable, median_iqr, missing_rate)

# Combine summary stats with protein info
proteins <- olink_assay %>% 
  filter(!Assay %in% c("GLIPR1", "NPM1", "PCOLCE")) %>%
  select(Assay, Panel) %>%
  arrange(Panel, Assay) %>%
  left_join(summary_stats, by = c("Assay" = "variable"))

output_dir <- file.path("results", "Table")
if (!dir.exists(output_dir)) {dir.create(output_dir, recursive = TRUE)}
ft <- flextable(proteins)
ft <- ft %>% 
  autofit() %>%
  theme_box() %>%
  bold(part = "header") %>%
  align(align = "left", part = "all") %>%
  colformat_double(j = "missing_rate", digits = 1) %>%
  set_caption(caption = "Supplementary Table 12: Descriptive statistics of proteins in the external test set.")
output_path <- file.path(
  output_dir, 
  "Supplementary_Table_12_proteomics_Multiomics_cohort.docx"
)
save_as_docx(ft, path = output_path)
print(paste("Analysis complete. Word table saved to:", output_path))

# =============================================================================
# 2. CLEAN UP ENVIRONMENT
# =============================================================================
rm(olink_assay, data_folder, external_test_data, pro_list, dat, summary_stats, proteins, output_dir, ft, output_path)

```

## Followup information

### Observation time

```{r}

# =============================================================================
# 1. SETUP: Define file paths
# =============================================================================
data_folder <- "data/split_seed_raw-250901"

file_metadata <- tibble(
  cohort = c(rep("Metabolomics-only cohort", 4), rep("Proteomics-only cohort", 4)),
  dataset_group = rep(c("Train", "Validation", "Geographic testing", "Multiomics cohort"), 2),
  file_name = c(
    "train_Metabolomics.csv", "val_Metabolomics.csv", "internal_test_Metabolomics.csv", "external_test_Metabolomics.csv",
    "train_Proteomics.csv", "val_Proteomics.csv", "internal_test_Proteomics.csv", "external_test_Proteomics.csv"
  )
) %>%
  mutate(full_path = file.path(data_folder, file_name))

# Define the follow-up time columns
time_vars <- c("bl2cad_yrs", "bl2stroke_yrs", "bl2hf_yrs", "bl2af_yrs", "bl2pad_yrs", "bl2vte_yrs")

# =============================================================================
# 2. LOAD & PROCESS: Read all files and calculate Follow-up Duration
# =============================================================================
combined_data <- pmap_dfr(
  .l = file_metadata,
  .f = function(full_path, cohort, dataset_group, file_name) {
    read_csv(full_path, col_types = cols(.default = "d")) %>%
      select(any_of(time_vars)) %>%
      mutate(
        follow_up_duration = pmin(!!!syms(time_vars), na.rm = TRUE),
        cohort = cohort,
        dataset_group = dataset_group
      )
  }
)

dataset_order <- c("Train", "Validation", "Geographic testing", "Multiomics cohort")
combined_data <- combined_data %>%
  mutate(dataset_group = factor(dataset_group, levels = dataset_order))

# =============================================================================
# 3. SUMMARY STATISTICS
# =============================================================================
summary_table <- combined_data %>%
  group_by(dataset_group, cohort) %>%
  summarise(
    sample_size = n(),
    median_follow_up_yrs = median(follow_up_duration, na.rm = TRUE),
    q1_follow_up_yrs = quantile(follow_up_duration, probs = 0.25, na.rm = TRUE),
    q3_follow_up_yrs = quantile(follow_up_duration, probs = 0.75, na.rm = TRUE),
    person_yrs = sum(follow_up_duration, na.rm = TRUE),
    .groups = "drop"
  )
print("--- Summary of Sample Size and Follow-up Time ---")
print(summary_table)

# =============================================================================
# 4. PREPARE FOR PLOTTING: All changes are in this section
# =============================================================================
plot_data <- combined_data %>%
  filter(!(dataset_group == "Multiomics cohort" & cohort == "Proteomics-only cohort")) %>%
  mutate(
    plot_group = if_else(dataset_group == "Multiomics cohort", "Multiomics cohort", cohort)
  )

# Calculate summary stats for the plot annotations
annotation_stats <- plot_data %>%
  group_by(dataset_group, plot_group) %>%
  summarise(
    median_follow_up = median(follow_up_duration, na.rm = TRUE),
    total_n = n(),
    .groups = "drop"
  )

omics_color_map <- c(
  "Metabolomics-only cohort" = "#9E9AC8",
  "Proteomics-only cohort"   = "#FD8D3C",
  "Multiomics cohort"     = "#A9A9A9"
)

annotation_labels <- annotation_stats %>%
  mutate(
    line1 = glue::glue("Median: {round(median_follow_up, 1)} yrs"),
    line2 = glue::glue("N = {format(total_n, big.mark=',')}")
  ) %>%
  group_by(dataset_group) %>%
  summarise(
    full_richtext_label = paste0(
      "<span style='color:", omics_color_map[plot_group], ";'>",
      line1, "<br>", line2,
      "</span>",
      collapse = "<br><br>"
    ),
    .groups = "drop"
  )

# =============================================================================
# 5. VISUALIZATION: Create the final density plot
# =============================================================================
density_plot <- ggplot(plot_data, aes(x = follow_up_duration, fill = plot_group)) +
  geom_density(alpha = 0.8) +
  facet_wrap(~dataset_group, nrow = 1) +
  scale_fill_manual(
    name = NULL, 
    values = omics_color_map,
    breaks = c("Metabolomics-only cohort", "Proteomics-only cohort")
  ) +
  geom_richtext(
    data = annotation_labels,
    aes(x = -Inf, y = Inf, label = full_richtext_label),
    inherit.aes = FALSE,
    hjust = -0.05,
    vjust = 1.05,
    size = 3.5,
    lineheight = 1.3,
    fill = NA,
    label.color = NA
  ) +
  labs(
    x = "Observation time (years)",
    y = "Density"
  ) +
  coord_cartesian(clip = "off") +
  theme_classic(base_size = 12) +
  theme(
    panel.grid = element_blank(),
    axis.text = element_text(colour = "black"),
    strip.background = element_rect(fill = "#A3AFBF", color = "black", linewidth = 0.5),
    strip.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = margin(25, 6, 6, 6, "pt")
  )

# =============================================================================
# 6. CLEAN UP ENVIRONMENT
# =============================================================================
rm(data_folder, file_metadata, time_vars, combined_data, dataset_order, summary_table, plot_data, annotation_stats, omics_color_map, annotation_labels)
   
print("--- Script finished and environment cleaned. ---")

```

### Incident cases

```{r}

# =============================================================================
# 1. SETUP: Define file paths
# =============================================================================
data_folder <- "data/split_seed_raw-250901"

file_metadata <- tibble(
  cohort = c(rep("Metabolomics-only cohort", 4), rep("Proteomics-only cohort", 4)),
  dataset_group = rep(c("Train", "Validation", "Geographic testing", "Multiomics cohort"), 2),
  file_name = c(
    "train_Metabolomics.csv", "val_Metabolomics.csv", "internal_test_Metabolomics.csv", "external_test_Metabolomics.csv",
    "train_Proteomics.csv", "val_Proteomics.csv", "internal_test_Proteomics.csv", "external_test_Proteomics.csv"
  )
) %>%
  mutate(full_path = file.path(data_folder, file_name))

# Define the disease columns to analyze
disease_vars <- c("cad", "stroke", "hf", "af", "pad", "vte")
disease_labels <- toupper(disease_vars)

# =============================================================================
# 2. CALCULATE CASE COUNTS AND INCIDENCE RATES
# =============================================================================
incidence_summary <- pmap_dfr(
  .l = file_metadata,
  .f = function(full_path, cohort, dataset_group, file_name) {
    data <- read_csv(full_path, col_types = cols(.default = "d")) %>%
      select(any_of(disease_vars))
    total_n <- nrow(data)
    data %>%
      summarise(across(all_of(disease_vars), ~sum(.x == 1, na.rm = TRUE))) %>%
      pivot_longer(
        cols = everything(),
        names_to = "disease",
        values_to = "case_count"
      ) %>%
      mutate(
        cohort = cohort,
        dataset_group = dataset_group,
        total_n = total_n
      )
  }
)

# Calculate the incidence rate and map disease names to uppercase
incidence_summary <- incidence_summary %>%
  mutate(
    incidence_rate_percent = (case_count / total_n) * 100,
    disease = toupper(disease)
  )
print("--- Summary of Incident Cases and Rates per Dataset ---")
print(incidence_summary)

# =============================================================================
# 3. PREPARE DATA FOR PLOTTING
# =============================================================================
plot_data <- incidence_summary %>%
  mutate(
    plot_group = if_else(dataset_group == "Multiomics cohort", "Multiomics cohort", cohort),
    rate_label = sprintf("%.1f", incidence_rate_percent)
  ) %>%
  filter(!(dataset_group == "Multiomics cohort" & cohort == "Proteomics-only cohort"))

dataset_order <- c("Train", "Validation", "Geographic testing", "Multiomics cohort")
plot_data$dataset_group <- factor(plot_data$dataset_group, levels = dataset_order)
plot_data$disease <- factor(plot_data$disease, levels = disease_labels)

# =============================================================================
# 5. VISUALIZATION: Create the bar chart of incident cases
# =============================================================================
color_map <- c(
  "Metabolomics-only cohort" = "#9E9AC8",
  "Proteomics-only cohort"   = "#FD8D3C",
  "Multiomics cohort"     = "#A9A9A9"
)

incident_rate_plot <- ggplot(plot_data, aes(x = disease, y = incidence_rate_percent, fill = plot_group)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.9)) +
  facet_wrap(~dataset_group, nrow = 1) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.15))) +
  scale_fill_manual(
    name = NULL,
    values = color_map,
    breaks = c("Metabolomics-only cohort", "Proteomics-only cohort")
  ) +
  labs(
    title = NULL,
    x = NULL,
    y = "Proportion (%)"
  ) +
  theme_classic(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 30, hjust = 1, color = "black"),
    axis.text.y = element_text(color = "black"),
    strip.background = element_rect(fill = "#A3AFBF", color = "black"),
    strip.text = element_text(size = 12),
    legend.position = "legend",
    plot.title = element_text(hjust = 0.5, face = "bold")
  )

# =============================================================================
# 5. CLEAN UP ENVIRONMENT
# =============================================================================
rm(data_folder, file_metadata, disease_vars, disease_labels, incidence_summary, plot_data, dataset_order, color_map)

print("--- Script finished and environment cleaned. ---")

```

#### Incident cases for va and aaa ()

```{r}

# =============================================================================
# 1. SETUP
# =============================================================================
data_folder <- "data/split_seed_raw_with_va_aaa-250901"
files_to_analyze <- c(
  "train_Metabolomics.csv",
  "val_Metabolomics.csv",
  "internal_test_Metabolomics.csv",
  "external_test_Metabolomics.csv",
  "train_Proteomics.csv",
  "val_Proteomics.csv",
  "internal_test_Proteomics.csv"
)
full_paths <- file.path(data_folder, files_to_analyze)

# =============================================================================
# 2. LOOP THROUGH FILES AND CALCULATE METRICS
# =============================================================================
event_summary_all <- map_dfr(full_paths, function(path) {
  read_csv(path, show_col_types = FALSE) %>%
    summarise(
      total_samples = n(),
      aaa_incident_cases = sum(aaa, na.rm = TRUE),
      va_incident_cases = sum(va, na.rm = TRUE),
      aaa_incidence_rate_percent = (aaa_incident_cases / total_samples) * 100,
      va_incidence_rate_percent = (va_incident_cases / total_samples) * 100
    ) %>%
    mutate(dataset = basename(path))
  
})

# =============================================================================
# 3. DISPLAY RESULTS
# =============================================================================
final_summary_table <- event_summary_all %>%
  select(dataset, total_samples, everything())

print("--- Summary for AAA and VA Events Across All Datasets ---")
print(final_summary_table)

# =============================================================================
# 4. CLEAN UP ENVIRONMENT
# =============================================================================
rm(data_folder, files_to_analyze, full_paths, event_summary_all, final_summary_table)

print("--- Script finished and environment cleaned. ---")

```

### Proportion of incident multiple CVDs

```{r}

# =============================================================================
# 1. SETUP
# =============================================================================
data_folder <- "data/split_seed_raw-250901"

file_metadata <- tibble(
  cohort = c(rep("Metabolomics-only cohort", 4), rep("Proteomics-only cohort", 4)),
  dataset_group = rep(c("Train", "Validation", "Geographic testing", "Multiomics cohort"), 2),
  file_name = c(
    "train_Metabolomics.csv", "val_Metabolomics.csv", "internal_test_Metabolomics.csv", "external_test_Metabolomics.csv",
    "train_Proteomics.csv", "val_Proteomics.csv", "internal_test_Proteomics.csv", "external_test_Proteomics.csv"
  )
) %>%
  mutate(full_path = file.path(data_folder, file_name))

disease_vars <- c("cad", "stroke", "hf", "af", "pad", "vte")


# =============================================================================
# 2. CALCULATE TOTAL DISEASE COUNTS PER PERSON
# =============================================================================
print("--- Calculating total disease counts for each dataset... ---")

disease_counts <- pmap_dfr(
  .l = file_metadata,
  .f = function(full_path, cohort, dataset_group, file_name) {
    read_csv(full_path, col_types = cols(.default = "d")) %>%
      select(all_of(disease_vars)) %>%
      mutate(total_diseases = rowSums(across(all_of(disease_vars)), na.rm = TRUE)) %>%
      mutate(
        cohort = cohort,
        dataset_group = dataset_group
      ) %>%
      select(total_diseases, cohort, dataset_group)
  }
)

disease_counts_grouped <- disease_counts %>%
  mutate(
    disease_group = case_when(
      total_diseases >= 2 ~ ">=2",
      TRUE ~ as.character(total_diseases)
    )
  )

# --- Calculate the percentage of people for each new disease group ---
count_summary <- disease_counts_grouped %>%
  count(dataset_group, cohort, disease_group, name = "n_individuals") %>%
  group_by(dataset_group, cohort) %>%
  mutate(percentage = (n_individuals / sum(n_individuals)) * 100) %>%
  ungroup()

# =============================================================================
# 3. PREPARE DATA FOR PLOTTING
# =============================================================================
plot_data <- count_summary %>%
  mutate(
    plot_group = if_else(dataset_group == "Multiomics cohort", "Multiomics cohort", cohort)
  ) %>%
  group_by(dataset_group, plot_group, disease_group) %>%
  summarise(percentage = mean(percentage), .groups = "drop")

dataset_order <- c("Train", "Validation", "Geographic testing", "Multiomics cohort")
disease_group_order <- c("0", "1", ">=2")
plot_data <- plot_data %>%
  mutate(
    dataset_group = factor(dataset_group, levels = dataset_order),
    disease_group = factor(disease_group, levels = disease_group_order)
  )

# =============================================================================
# 4. VISUALIZATION: Create the bar chart
# =============================================================================
color_map <- c(
  "Metabolomics-only cohort" = "#9E9AC8",
  "Proteomics-only cohort"   = "#FD8D3C",
  "Multiomics cohort"     = "#A9A9A9"
)

disease_count_plot <- ggplot(
    plot_data, 
    aes(x = disease_group, y = percentage, fill = plot_group)
  ) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.9)) +
  facet_wrap(~dataset_group, nrow = 1) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.05))) +
  scale_fill_manual(
    name = NULL,
    values = color_map,
    breaks = c("Metabolomics-only cohort", "Proteomics-only cohort")
  ) +
  labs(
    title = NULL,
    x = "Number of incident diseases",
    y = "Proportion (%)"
  ) +
  theme_classic(base_size = 12) +
  theme(
    axis.text.x = element_text(color = "black", size = 12),
    axis.text.y = element_text(color = "black"),
    strip.background = element_rect(fill = "#A3AFBF", color = "black"),
    strip.text = element_text(size = 12),
    legend.position = "bottom",
    plot.title = element_text(hjust = 0.5, face = "bold")
  )

# =============================================================================
# 5. CLEAN UP ENVIRONMENT
# =============================================================================
rm(data_folder, file_metadata, disease_vars, disease_counts, disease_counts_grouped, count_summary, plot_data, dataset_order, disease_group_order, color_map)

print("--- Script finished and environment cleaned. ---")

```

### Pool

```{r}

# =============================================================================
# 1. COMBINE PLOTS
# =============================================================================
followup_plot <- (density_plot / incident_rate_plot / disease_count_plot) + 
  plot_annotation(tag_levels = "a") &
  theme(plot.tag = element_text(face = "bold"))

# =============================================================================
# 2. SAVE AND CLEAN UP
# =============================================================================
ggsave(
  str_c(getwd(), "/results/Figure/Followup_information_plot.svg"), 
  plot = followup_plot, 
  width = 12, height = 9, unit = "in", dpi = 300, device = "svg"
)

print("--- Combined plot saved successfully. ---")

rm(density_plot, incident_rate_plot, disease_count_plot, followup_plot)

print("--- Script finished and environment cleaned. ---")

```

------------------------------------------------------------------------------------

# Survival analysis

## Observed event rates

```{r}

# =============================================================================
# 1. SETUP
# =============================================================================
file_path <- "saved/results/Survival_Analysis/summary_observed_event_rate.csv"

# =============================================================================
# 2. LOAD AND PREPARE DATA
# =============================================================================
event_rate_data <- read_csv(file_path, show_col_types = FALSE)

plot_data <- event_rate_data %>%
  mutate(
    event_rate_percent = event_rate * 100,
    score_type = factor(
      score_type,
      levels = c("prs", "metscore", "proscore"),
      labels = c("PRS", "MetScore", "ProScore")
    ),
    outcome = factor(
      outcome,
      levels = c("cad", "stroke", "hf", "af", "pad", "vte"),
      labels = c("CAD", "Stroke", "HF", "AF", "PAD", "VTE")
    )
  )

# =============================================================================
# 3. CREATE THE SCATTER PLOT
# =============================================================================
color_palette <- c(
  "PRS"      = "#74C476",
  "MetScore" = "#9E9AC8",
  "ProScore" = "#FD8D3C"
)

scatter_plot <- ggplot(plot_data, aes(x = percentile, y = event_rate_percent, color = score_type)) +
  geom_point(size = 2.5, alpha = 0.7) +
  facet_wrap(~ outcome, scales = "free_y", axes = "all") +
  scale_color_manual(values = color_palette) +
  labs(
    x = "Predicted risk score percentile",
    y = "Observed event rate (%)",
    color = "Score"
  ) +
  theme_classic() +
  theme(
    axis.text = element_text(size = 12, colour = "black"),
    axis.title = element_text(size = 12, colour = "black"),
    legend.title = element_text(size = 12),
    legend.text = element_text(size = 12),
    legend.position = "bottom",
    strip.background = element_blank(),
    strip.text = element_text(size = 12),
    panel.spacing = unit(1, "lines")
  )

ggsave(str_c(getwd(), "/results/Figure/Observed_events.svg"), plot = scatter_plot, width = 12, height = 6, unit = "in", dpi = 300, device = "svg")

# =============================================================================
# 5. CLEAN UP ENVIRONMENT
# =============================================================================
rm(file_path, event_rate_data, plot_data, color_palette, scatter_plot)

print("--- Script finished and environment cleaned. ---")

```

## Kaplan-Meier curve

```{r}

# =============================================================================
# 1. SETUP
# =============================================================================
km_data_path <- "saved/results/Survival_Analysis/summary_survival_km_data.csv"
logrank_path <- "saved/results/Survival_Analysis/summary_logrank_test_results.csv"

# --- Load and prepare Kaplan-Meier data for curves ---
km_data <- read_csv(km_data_path, show_col_types = FALSE) %>%
  mutate(
    group = factor(group, levels = c("Low", "Medium", "High")),
    outcome = factor(
      outcome,
      levels = c("cad", "stroke", "hf", "af", "pad", "vte"),
      labels = c("CAD", "Stroke", "HF", "AF", "PAD", "VTE")
    ),
    survival_prob_pct = survival_prob * 100,
    ci_lower_pct = ci_lower * 100,
    ci_upper_pct = ci_upper * 100
  )

# --- Load and prepare Log-rank test data for annotations ---
logrank_data <- read_csv(logrank_path, show_col_types = FALSE) %>%
  mutate(
    p_label = if_else(
      p < 0.001, 
      glue::glue("Log-rank *P* = {scales::scientific(p, digits = 3)}"),
      glue::glue("Log-rank *P* = {sprintf('%.3f', p)}")
    ),
    outcome = factor(
      outcome,
      levels = c("cad", "stroke", "hf", "af", "pad", "vte"),
      labels = c("CAD", "Stroke", "HF", "AF", "PAD", "VTE")
    )
  )

# =============================================================================
# 2. DEFINE A REUSABLE PLOTTING FUNCTION
# =============================================================================
create_km_plot <- function(data, annotation_df, color_palette, legend_title) {
  ggplot(data, aes(x = time, y = survival_prob_pct, color = group, fill = group)) +
    geom_line(linewidth = 0.5) + 
    geom_ribbon(aes(ymin = ci_lower_pct, ymax = ci_upper_pct), alpha = 0.2, colour = "white") + 
    geom_richtext(
      data = annotation_df,
      aes(x = 0, y = -Inf, label = p_label),
      inherit.aes = FALSE,
      hjust = -0.1,
      vjust = -0.5,
      size = 3.5,
      color = "black",
      fill = NA, label.color = NA
    ) +
    facet_wrap(~ outcome, scales = "free_y", axes = "all") +
    scale_colour_manual(values = color_palette, name = legend_title) +
    scale_fill_manual(values = color_palette, name = legend_title) +
    labs(
      x = "Observation time (years)",
      y = "Survival probability (%)"
    ) +
    theme_classic() +
    theme(
      axis.text = element_text(size = 12, colour = "black"),
      axis.title = element_text(size = 12, colour = "black"),
      legend.title = element_text(size = 12),
      legend.text = element_text(size = 12),
      legend.position = "bottom",
      strip.background = element_blank(),
      strip.text = element_text(size = 12),
      panel.spacing = unit(1, "lines")
    )
}

# =============================================================================
# 3. GENERATE EACH OF THE THREE PLOTS
# =============================================================================
# --- Plot 1: PRS ---
prs_colors <- c("#A1D99B", "#41AB5D", "#00441B")
km_plot_prs <- create_km_plot(
  data = km_data %>% filter(score_type == "prs"),
  annotation_df = logrank_data %>% filter(score_type == "prs"),
  color_palette = prs_colors,
  legend_title = "PRS"
)
print("--- Generating PRS Survival Plot with P-values ---")

# --- Plot 2: MetScore ---
metscore_colors <- c("#BCBDDC", "#807DBA", "#3F007D")
km_plot_metscore <- create_km_plot(
  data = km_data %>% filter(score_type == "metscore"),
  annotation_df = logrank_data %>% filter(score_type == "metscore"),
  color_palette = metscore_colors,
  legend_title = "MetScore"
)
print("--- Generating MetScore Survival Plot with P-values ---")

# --- Plot 3: ProScore ---
proscore_colors <- c("#FDAE6B", "#F16913", "#7F2704")
km_plot_proscore <- create_km_plot(
  data = km_data %>% filter(score_type == "proscore"),
  annotation_df = logrank_data %>% filter(score_type == "proscore"),
  color_palette = proscore_colors,
  legend_title = "ProScore"
)
print("--- Generating ProScore Survival Plot with P-values ---")

# =============================================================================
# 4. CLEAN UP ENVIRONMENT
# =============================================================================
rm(km_data_path, logrank_path, km_data, logrank_data, prs_colors, metscore_colors, proscore_colors)

print("--- Script finished and environment cleaned. ---")

```

## Hazard ratio

```{r}

# =============================================================================
# 1. SETUP
# =============================================================================
continuous_hr_path <- "saved/results/Survival_Analysis/summary_hazard_ratio_continuous.csv"
categorical_hr_path <- "saved/results/Survival_Analysis/summary_hazard_ratio_categorical.csv"

# =============================================================================
# 2. LOAD, CLEAN, AND COMBINE DATA
# =============================================================================
# --- Process Continuous HR Data ---
hr_continuous <- read_csv(continuous_hr_path, show_col_types = FALSE) %>%
  clean_names() %>%
  mutate(y_label = "per 1-SD increase")

# --- Process Categorical HR Data ---
hr_categorical <- read_csv(categorical_hr_path, show_col_types = FALSE) %>%
  clean_names() %>%
  mutate(y_label = paste(str_extract(covariate, "(?<=_group_)[^_]+"), "vs Low"))

# --- Combine into a single data frame for plotting ---
plot_data <- bind_rows(hr_continuous, hr_categorical) %>%
  mutate(
    score_type = factor(
      score_type,
      levels = c("prs", "metscore", "proscore"),
      labels = c("PRS", "MetScore", "ProScore")
    ),
    outcome = factor(
      outcome,
      levels = c("cad", "stroke", "hf", "af", "pad", "vte"),
      labels = c("CAD", "Stroke", "HF", "AF", "PAD", "VTE")
    ),
    y_label = factor(y_label, levels = c("per 1-SD increase", "Medium vs Low", "High vs Low" ))
  )

# =============================================================================
# 3. DEFINE A REUSABLE PLOTTING FUNCTION
# =============================================================================
create_forest_plot <- function(data_subset) {
  
  color_palette <- c(
    "PRS"      = "#74C476",
    "MetScore" = "#9E9AC8",
    "ProScore" = "#FD8D3C"
  )

  if (all(unique(data_subset$score_type) == "PRS")) {
    legend_pos <- "none"
  } else {
    legend_pos <- "bottom"
  }
  
  forest_plot <- ggplot(data_subset, aes(x = exp_coef, y = y_label, color = score_type)) +
    geom_point(position = position_dodge(width = 0.7), size = 2.5) +
    geom_linerange(
      aes(xmin = exp_coef_lower_95_percent, xmax = exp_coef_upper_95_percent),
      linewidth = 1,
      position = position_dodge(width = 0.7)) +
    geom_vline(xintercept = 1, linetype = "dashed", color = "grey40") +
    facet_wrap(~ outcome, scales = "free_x") +
    scale_color_manual(values = color_palette) +
    labs(
      title = NULL,
      x = "Hazard ratio (95% confidence interval)",
      y = NULL,
      color = "Score"
    ) +
    theme_classic(base_size = 12) +
    theme(
      axis.text = element_text(size = 12, colour = "black"),
      axis.title = element_text(size = 12, colour = "black"),
      legend.title = element_text(size = 12),
      legend.text = element_text(size = 11),
      legend.position = legend_pos,
      strip.background = element_blank(),
      strip.text = element_text(size = 12),
      panel.spacing = unit(1, "lines")
    )
  
  return(forest_plot)
}

# =============================================================================
# 4. GENERATE THE SIX SPLIT PLOTS
# =============================================================================
all_forest_plots <- list()

model_types <- c("Unadjusted", "Adjusted (Age+Sex)", "Adjusted (All Clinical)")

for (model_name in model_types) {
  # --- Create and Store Plot A: PRS only ---
  data_subset_prs <- plot_data %>%
    filter(model == model_name, score_type == "PRS")
  plot_prs <- create_forest_plot(data_subset = data_subset_prs)
  plot_name_prs <- paste0(model_name, "_PRS")
  all_forest_plots[[plot_name_prs]] <- plot_prs

  # --- Create and Store Plot B: MetScore & ProScore ---
  data_subset_met_pro <- plot_data %>%
    filter(model == model_name, score_type %in% c("MetScore", "ProScore"))
  plot_met_pro <- create_forest_plot(data_subset = data_subset_met_pro)
  plot_name_met_pro <- paste0(model_name, "_MetScore_ProScore")
  all_forest_plots[[plot_name_met_pro]] <- plot_met_pro
}

# --- Final Confirmation ---
print("--- All 6 plots have been generated and stored in the 'all_forest_plots' list. ---")
print("You can access them by name, for example: all_forest_plots$Unadjusted_PRS")
print(names(all_forest_plots))

# =============================================================================
# Create a Clean Summary Table for the Fully Adjusted Model
# =============================================================================
final_hr_table <- plot_data %>%
  filter(model == "Adjusted (All Clinical)") %>%
  mutate(
    hr_ci = sprintf(
      "%.2f (%.2f, %.2f)",
      exp_coef, 
      exp_coef_lower_95_percent, 
      exp_coef_upper_95_percent
    )
  ) %>%
  select(outcome, score_type, y_label, hr_ci) %>%
  arrange(outcome, score_type, y_label)

# Print the resulting table to the console
print("--- Hazard Ratio Summary for the 'Adjusted (All Clinical)' Model ---")
# Continuous
print(final_hr_table %>% filter(y_label == "per 1-SD increase") %>% arrange(hr_ci))

# Categorical
final_hr_table %>% filter(y_label == "High vs Low" & score_type == "ProScore") %>% arrange(hr_ci) # ProScore
final_hr_table %>% filter(y_label == "High vs Low" & score_type == "MetScore") %>% arrange(hr_ci) # MetScore
final_hr_table %>% filter(y_label == "High vs Low" & score_type == "PRS") %>% arrange(hr_ci) # PRS

# =============================================================================
# 6. CLEAN UP ENVIRONMENT
# =============================================================================
rm(continuous_hr_path, categorical_hr_path, hr_continuous, hr_categorical, plot_data, model_types, model_name, data_subset_prs, plot_prs, plot_name_prs, data_subset_met_pro, plot_met_pro, plot_name_met_pro, final_hr_table)
   
print("--- Script finished and environment cleaned. ---")

```

## Pool

```{r}

# =============================================================================
# 1. CREATE AND SAVE METSCORE + PROSCORE FIGURE
# =============================================================================
print("--- Assembling MetScore + ProScore figure... ---")

surv_plot <- 
  (km_plot_metscore / km_plot_proscore / all_forest_plots[["Adjusted (All Clinical)_MetScore_ProScore"]]) +
  plot_annotation(tag_levels = "a") &
  theme(plot.tag = element_text(face = "bold"))

ggsave(
  str_c(getwd(), "/results/Figure/Survival_analysis_plot.pdf"), 
  plot = surv_plot, width = 12, height = 14, unit = "in", dpi = 300, device = "pdf"
)
ggsave(
  str_c(getwd(), "/results/Figure/Survival_analysis_plot.svg"), 
  plot = surv_plot, width = 12, height = 14, unit = "in", dpi = 300, device = "svg"
)
print("--- MetScore + ProScore figure saved successfully. ---")

# =============================================================================
# 2. CREATE AND SAVE PRS FIGURE
# =============================================================================
print("--- Assembling PRS figure... ---")

surv_plot_prs <- 
  (km_plot_prs / all_forest_plots[["Adjusted (All Clinical)_PRS"]]) +
  plot_annotation(tag_levels = "a") &
  theme(plot.tag = element_text(face = "bold"))

ggsave(
  str_c(getwd(), "/results/Figure/Survival_analysis_plot_prs.svg"), 
  plot = surv_plot_prs, width = 12, height = 10, unit = "in", dpi = 300, device = "svg"
)
print("--- PRS figure saved successfully. ---")

# =============================================================================
# 3. CLEAN UP ENVIRONMENT
# =============================================================================
rm(final_hr_trable, surv_plot, surv_plot_prs, km_plot_metscore, km_plot_proscore, km_plot_prs, all_forest_plots)

print("--- Script finished and environment cleaned. ---")

```

------------------------------------------------------------------------------------

# Correlation for omics scores

```{r}

# =============================================================================
# 2. DEFINE A REUSABLE PLOTTING FUNCTION
# =============================================================================
create_correlation_heatmap <- function(file_path) {
  
  # --- Step A: Load and prepare the data ---
  score_vars <- c("cad", "stroke", "hf", "af", "pad", "vte")
  
  score_data <- read_csv(file_path) %>%
    select(all_of(score_vars))
  
  # --- Step B: Calculate Spearman correlation and reshape for plotting ---
  cor_matrix <- cor(score_data, method = "pearson")
  
  cor_matrix[upper.tri(cor_matrix)] <- NA
  
  cor_long <- as.data.frame(cor_matrix) %>%
    rownames_to_column("var1") %>%
    pivot_longer(-var1, names_to = "var2", values_to = "cor") %>%
    filter(!is.na(cor)) %>%
    mutate(
      var1 = toupper(var1),
      var2 = toupper(var2)
    ) %>%
    mutate(
      var1 = factor(var1, levels = toupper(rev(score_vars))),
      var2 = factor(var2, levels = toupper(score_vars))
    )
    
  # --- Step C: Create the heatmap using ggplot2 ---
  heatmap_plot <- ggplot(cor_long, aes(x = var2, y = var1, fill = cor)) +
    geom_tile(color = "white", linewidth = 1) +
    geom_text(aes(label = sprintf("%.2f", cor)), color = "black", size = 4) +
    scale_fill_gradientn(
      colours = c("#2E5A87", "#7BA8CC", "#FFFFFF", "#F78171", "#A90C38"),
      breaks = c(0.7, 0.8, 0.9, 1.0),
      limits = c(0.7, 1),
      name = "Spearman\ncorrelation"
    ) +
    theme_void() + 
    theme(
      axis.text.y = element_text(size = 12, hjust = 1, color = "black"),
      axis.text.x = element_text(size = 12, angle = 90, hjust = 1, color = "black"),
      legend.title = element_text(size = 12),
      legend.text = element_text(size = 11),
      legend.position = "right",
      plot.title = element_text(size = 14, face = "bold", hjust = 0, vjust = 1)
    ) +
    labs(title = NULL) +
    coord_fixed()
  
  return(heatmap_plot)
}

# =============================================================================
# 3. EXECUTE: Generate the plots for Metabolomics and Proteomics
# =============================================================================
metabolomics_file <- "saved/results/Scores/OmicsNet/Final/external_test_scores_Metabolomics.csv"
proteomics_file <- "saved/results/Scores/OmicsNet/Final/external_test_scores_Proteomics.csv"

# --- Create the Metabolomics Plot ---
cor_plot_metscore <- create_correlation_heatmap(file_path = metabolomics_file)

# --- Create the Proteomics Plot ---
cor_plot_proscore <- create_correlation_heatmap(file_path = proteomics_file)

# =============================================================================
# 4. COMBINE PLOTS: Create a final figure with a shared legend
# =============================================================================
combined_plot <- (cor_plot_metscore | cor_plot_proscore) + 
  plot_layout(guides = "collect") +
  plot_annotation(tag_levels = "a") &
  theme(plot.tag = element_text(face = "bold"))

print("--- Displaying combined plot ---")

ggsave(str_c(getwd(), "/results/Figure/Omics_score_correlation_plot.svg"), plot = combined_plot, width = 14, height = 6, unit = "in", dpi = 300, device = "svg")

# =============================================================================
# 5. CLEAN UP ENVIRONMENT
# =============================================================================
rm(create_correlation_heatmap, metabolomics_file, proteomics_file, cor_plot_metscore, cor_plot_proscore, combined_plot)

print("--- Script finished and environment cleaned. ---")

```

------------------------------------------------------------------------------------

# C-index comparison

## Main

### C-index forest plot

```{r}

# =============================================================================
# 1. SETUP
# =============================================================================
cindex_path <- "saved/results/Cindex/Merge/cindex_final.csv"
clinical_scores_path <- "saved/results/Cindex/Merge/clinical_scores_final.csv"

# =============================================================================
# 2. LOAD AND PREPARE DATA
# =============================================================================
print("--- Loading and preparing C-index data... ---")

# --- Load both data files ---
cindex_data_raw <- read_csv(cindex_path, show_col_types = FALSE) %>% 
  filter(metric == "c_index")
clinical_scores_data_raw <- read_csv(clinical_scores_path, show_col_types = FALSE)

# --- Create model_group and format labels ---
cindex_data_formatted <- cindex_data_raw %>%
  mutate(
    model_group = case_when(
      str_starts(comparison_model, "AgeSex") ~ "AgeSex-based",
      str_starts(comparison_model, "Clinical") ~ "Clinical-based",
      str_starts(comparison_model, "PANEL") ~ "PANEL-based",
      comparison_model %in% c("Genomics", "Metabolomics", "Proteomics") ~ "Omics-based",
      TRUE ~ "Other"
    ),
    comparison_model_formatted = case_when(
      comparison_model == "AgeSex" ~ "AgeSex",
      comparison_model == "Clinical" ~ "Clin",
      comparison_model == "PANEL" ~ "PANEL",
      comparison_model == "Genomics" ~ "PRS",
      comparison_model == "Metabolomics" ~ "MetScore",
      comparison_model == "Proteomics" ~ "ProScore",
      TRUE ~ comparison_model %>%
        str_remove("^(AgeSex|Clinical|PANEL)_") %>%
        str_replace_all(c("Genomics" = "PRS", "Metabolomics" = "MetScore", "Proteomics" = "ProScore")) %>%
        str_replace_all("_", " +") %>%
        paste0("+", .) %>%
        paste0("*", ., "*")
    )
  )

clinical_scores_data_formatted <- clinical_scores_data_raw %>%
  mutate(
    model_group = "Clinical scores",
    comparison_model_formatted = toupper(comparison_model)
  )

# --- Combine into a single data frame for plotting ---
model_order_levels <- c(
  "AgeSex", "Clin", "PANEL", 
  "*+PRS*", "*+MetScore*", "*+ProScore*", 
  "*+PRS +MetScore*", "*+PRS +ProScore*", "*+MetScore +ProScore*", 
  "*+PRS +MetScore +ProScore*",
  "PRS", "MetScore", "ProScore",
  "ASCVD", "SCORE2"
)

plot_data <- bind_rows(
    cindex_data_formatted, 
    clinical_scores_data_formatted
  ) %>%
  mutate(
    outcome = factor(
      outcome,
      levels = c("cad", "stroke", "hf", "af", "pad", "vte"),
      labels = c("CAD", "Stroke", "HF", "AF", "PAD", "VTE")
    ),
    model_group = factor(
      model_group,
      levels = c("Clinical scores", "Omics-based", "AgeSex-based", "Clinical-based", "PANEL-based")
    ),
    comparison_model_formatted = factor(comparison_model_formatted, levels = rev(model_order_levels))
  )

scores_performance <- plot_data %>% filter(model_group == "Omics-based") %>%
  mutate(estimate_ci = sprintf("%.2f (%.2f, %.2f)", point_estimate, ci_lower, ci_upper)) %>%
  select(estimate_ci, comparison_model_formatted, everything())
print(scores_performance %>% filter(comparison_model_formatted == "ProScore") %>% arrange(point_estimate)) # ProScore
print(scores_performance %>% filter(comparison_model_formatted == "MetScore") %>% arrange(point_estimate)) # MetScore
print(scores_performance %>% filter(comparison_model_formatted == "PRS") %>% arrange(point_estimate)) # PRS

# =============================================================================
# 4. CREATE THE FOREST PLOT
# =============================================================================
print("--- Generating forest plot... ---")

baseline_lines <- plot_data %>% 
  filter(comparison_model_formatted %in% c("AgeSex", "Clin", "PANEL")) %>%
  select(outcome, model_group, point_estimate)

color_palette <- c(
  "Clinical scores" = "#F39B7FCC",
  "Omics-based"     = "#E64B35CC",
  "AgeSex-based"    = "#4DBBD5CC",
  "Clinical-based"  = "#00A087CC",
  "PANEL-based"     = "#3C5488CC"
)

cindex_forest_plot <- ggplot(
  plot_data, 
  aes(x = point_estimate, y = comparison_model_formatted, color = model_group)
) +
  geom_vline(
    data = baseline_lines,
    aes(xintercept = point_estimate),
    color = "#D3D3D3", 
    linetype = "dashed", 
    linewidth = 0.75
  ) +
  geom_linerange(aes(xmin = ci_lower, xmax = ci_upper), linewidth = 1) +
  geom_point(size = 1, alpha = 1) + 
  facet_grid(model_group ~ outcome, scales = "free_y", space = "free_y") +
  coord_cartesian(xlim = c(0.49, 1.02)) +
  scale_x_continuous(breaks = c(0.5, 0.75, 1.0), labels = c("0.5", "0.75", "1.0")) +
  scale_color_manual(values = color_palette, name = NULL) + 
  labs(x = "C-index (95% CI)", y = NULL) +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = 0, angle = 0),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90),
    axis.ticks.y = element_blank(),
    panel.grid = element_blank(),
    legend.title = element_text(size = 12, hjust = 0.1),
    legend.text = element_text(size = 12),
    legend.position = "none",
    strip.background = element_blank(),
    strip.text.x = element_text(size = 12),
    strip.text.y = element_blank()
  )

legend <- ggplot(
  plot_data, 
  aes(x = point_estimate, y = reorder_within(comparison_model_formatted, desc(comparison_model_formatted), model_group), color = model_group)
) +
  geom_linerange(aes(xmin = ci_lower, xmax = ci_upper), linewidth = 1) +
  geom_point(size = 1, alpha = 1) + 
  facet_grid(model_group ~ outcome, scales = "free_y", space = "free_y") +
  scale_color_manual(
    values = color_palette, 
    name = NULL,
    breaks = c("Omics-based", "AgeSex-based", "Clinical-based", "PANEL-based")
  ) + 
  tidytext::scale_y_reordered() +
  theme_bw() +
  theme(
    legend.title = element_text(size = 12, hjust = 0.1),
    legend.text = element_text(size = 12),
    legend.position = "bottom"
  )

example_plot <- ggplot(
  plot_data %>% filter(outcome == "AF" & model_group == "PANEL-based"), 
  aes(x = point_estimate, y = comparison_model_formatted, color = model_group)
) +
  geom_vline(
    data = baseline_lines %>% filter(outcome == "AF" & model_group == "PANEL-based"),
    aes(xintercept = point_estimate),
    color = "#D3D3D3", 
    linetype = "dashed", 
    linewidth = 0.75
  ) +
  geom_linerange(aes(xmin = ci_lower, xmax = ci_upper), linewidth = 1) +
  geom_point(size = 1, alpha = 1) + 
  coord_cartesian(xlim = c(0.49, 1.02)) +
  scale_x_continuous(breaks = c(0.5, 1.0), labels = c("0.5", "1.0")) +
  scale_color_manual(values = color_palette, name = NULL) + 
  labs(x = "C-index (95% CI)", y = NULL) +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = 0, angle = 0),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90),
    axis.ticks.y = element_blank(),
    panel.grid = element_blank(),
    legend.title = element_text(size = 12, hjust = 0.1),
    legend.text = element_text(size = 12),
    legend.position = "none",
    strip.background = element_blank(),
    strip.text.x = element_blank(),
    strip.text.y = element_blank()
  )
ggsave(str_c(getwd(), "/results/Figure/Performance_comparison_example.png"), plot = example_plot, width = 4, height = 3, unit = "in", dpi = 300, device = "png")

# =============================================================================
# 5. CLEAN UP ENVIRONMENT
# =============================================================================
rm(cindex_path, clinical_scores_path, cindex_data_raw, 
   clinical_scores_data_raw, cindex_data_formatted,
   clinical_scores_data_formatted, plot_data, model_order_levels,
   baseline_lines, color_palette, example_plot)

print("--- Script finished and environment cleaned. ---")

```

### Delta C-index

```{r}

# =============================================================================
# 1. SETUP
# =============================================================================
cindex_path <- "saved/results/Cindex/Merge/cindex_final.csv"

# =============================================================================
# 2. LOAD AND PREPARE DATA (Data wrangling is the same as before)
# =============================================================================
print("--- Loading and preparing C-index data... ---")
cindex_data_raw <- read_csv(cindex_path, show_col_types = FALSE) %>% 
  filter(metric == "delta_c_index")

cindex_data_formatted <- cindex_data_raw %>%
  mutate(
    model_group = case_when(
      str_starts(comparison_model, "AgeSex") ~ "AgeSex-based",
      str_starts(comparison_model, "Clinical") ~ "Clinical-based",
      str_starts(comparison_model, "PANEL") ~ "PANEL-based",
      comparison_model %in% c("Genomics", "Metabolomics", "Proteomics") ~ "Omics-based",
      TRUE ~ "Other"
    ),
    comparison_model_formatted = case_when(
      comparison_model %in% c("AgeSex", "Clinical", "PANEL", "Genomics", "Metabolomics", "Proteomics") ~ 
        recode(comparison_model, "Genomics"="PRS", "Metabolomics"="MetScore", "Proteomics"="ProScore", "Clinical"="Clin"),
      TRUE ~ comparison_model %>%
        str_remove("^(AgeSex|Clinical|PANEL)_") %>%
        str_replace_all(c("Genomics" = "PRS", "Metabolomics" = "MetScore", "Proteomics" = "ProScore")) %>%
        str_replace_all("_", " +") %>%
        paste0("+", .) %>%
        paste0("*", ., "*")
    )
  )

model_order_levels <- c(
  "AgeSex", "Clin", "PANEL", "*+PRS*", "*+MetScore*", "*+ProScore*", 
  "*+PRS +MetScore*", "*+PRS +ProScore*", "*+MetScore +ProScore*", 
  "*+PRS +MetScore +ProScore*", "PRS", "MetScore", "ProScore"
)

plot_data <- cindex_data_formatted %>%
  mutate(
    outcome = factor(
      outcome,
      levels = c("cad", "stroke", "hf", "af", "pad", "vte"),
      labels = c("CAD", "Stroke", "HF", "AF", "PAD", "VTE")
    ),
    model_group = factor(
      model_group,
      levels = c("Omics-based", "AgeSex-based", "Clinical-based", "PANEL-based")
    ),
    comparison_model_formatted = factor(comparison_model_formatted, levels = rev(model_order_levels))
  )

agesex_performance <- plot_data %>% filter(model_group == "AgeSex-based") %>%
  mutate(estimate_ci = sprintf("%.3f (%.3f, %.3f)", point_estimate, ci_lower, ci_upper)) %>%
  select(estimate_ci, comparison_model_formatted, everything())
print(agesex_performance %>% filter(comparison_model_formatted != "AgeSex") %>% arrange(point_estimate))
print(agesex_performance %>% filter(comparison_model_formatted == "*+ProScore*") %>% arrange(point_estimate))
print(agesex_performance %>% filter(comparison_model_formatted == "*+MetScore*") %>% arrange(point_estimate))

clin_performance <- plot_data %>% filter(model_group == "Clinical-based") %>%
  mutate(estimate_ci = sprintf("%.3f (%.3f, %.3f)", point_estimate, ci_lower, ci_upper)) %>%
  select(estimate_ci, comparison_model_formatted, everything())
print(clin_performance %>% filter(comparison_model_formatted != "Clin") %>% arrange(point_estimate))

panel_performance <- plot_data %>% filter(model_group == "PANEL-based") %>%
  mutate(estimate_ci = sprintf("%.3f (%.3f, %.3f)", point_estimate, ci_lower, ci_upper)) %>%
  select(estimate_ci, comparison_model_formatted, everything())
print(panel_performance %>% filter(comparison_model_formatted != "PANEL") %>% arrange(point_estimate))

# =============================================================================
# 3. CREATE THE DELTA C-INDEX FOREST PLOT
# =============================================================================
print("--- Generating delta C-index forest plot... ---")

delta_plot_data <- plot_data %>%
  filter(model_group != "Omics-based") %>%
  mutate(
    across(
      c(point_estimate, ci_lower, ci_upper),
      ~ if_else(comparison_model_formatted %in% c("AgeSex", "Clin", "PANEL"), NA_real_, .x)
    )
  )

baseline_text_data <- delta_plot_data %>%
  filter(comparison_model_formatted %in% c("AgeSex", "Clin", "PANEL"))

color_palette <- c(
  "Omics-based"     = "#E64B35CC",
  "AgeSex-based"    = "#4DBBD5CC",
  "Clinical-based"  = "#00A087CC",
  "PANEL-based"     = "#3C5488CC"
)

delta_cindex_plot <- ggplot(
  delta_plot_data, 
  aes(x = point_estimate, y = comparison_model_formatted, color = model_group)
) +
  geom_vline(
    xintercept = 0,
    color = "#D3D3D3", 
    linetype = "dashed", 
    linewidth = 0.75
  ) +
  geom_linerange(aes(xmin = ci_lower, xmax = ci_upper), linewidth = 1) +
  geom_point(size = 1, alpha = 1) + 
  geom_text(
    data = baseline_text_data,
    aes(x = 0, label = "Baseline"),
    nudge_x = 0.005,
    size = 3.5,
    color = "black",
    hjust = 0
  ) +
  facet_grid(model_group ~ outcome, scales = "free_y", space = "free_y") +
  coord_cartesian(xlim = c(-0.01, 0.126)) +
  scale_x_continuous(breaks = c(0, 0.04, 0.08, 0.12), labels = c("0", "0.04", "0.08", "0.12")) +
  scale_color_manual(values = color_palette, name = NULL) + 
  labs(x = "\u0394 C-index (95% CI)", y = NULL) +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_markdown(size = 12, hjust = 0.5, vjust = 1, family = "Arial"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90),
    axis.ticks.y = element_blank(),
    panel.grid = element_blank(),
    legend.title = element_text(size = 12, hjust = 0.1),
    legend.text = element_text(size = 12),
    legend.position = "none",
    strip.background = element_blank(),
    strip.text.x = element_text(size = 12),
    strip.text.y = element_blank()
  )

# =============================================================================
# 4. CLEAN UP ENVIRONMENT
# =============================================================================
rm(cindex_path, cindex_data_raw, cindex_data_formatted,
   plot_data, model_order_levels, delta_plot_data, baseline_text_data,
   color_palette)

print("--- Script finished and environment cleaned. ---")

```

### Pool

```{r}

# =============================================================================
# 1. COMBINE PLOTS
# =============================================================================
cindex_plot <- (cindex_forest_plot / delta_cindex_plot) + 
  plot_layout(heights = c(0.55, 0.45)) +
  plot_annotation(tag_levels = "a") &
  theme(plot.tag = element_text(face = "bold"))

cindex_plot <- wrap_elements(cindex_plot) / ggpubr::get_legend(legend) +
  plot_layout(heights = c(0.95, 0.05))

# =============================================================================
# 2. SAVE AND CLEAN UP
# =============================================================================
print("--- Saving final plot in all formats... ---")

showtext_auto(enable = T)
font_add("Arial", regular = "Arial.ttf")
ggsave(str_c(getwd(), "/results/Figure/Performance_comparison.pdf"), plot = cindex_plot, width = 14, height = 16, unit = "in", dpi = 300, device = "pdf")
showtext_auto(enable = F)

ggsave(str_c(getwd(), "/results/Figure/Performance_comparison.svg"), plot = cindex_plot, width = 14, height = 16, unit = "in", dpi = 300, device = "svg")

rm(cindex_forest_plot, delta_cindex_plot, legend, cindex_plot, scores_performance, agesex_performance, clin_performance, panel_performance)

```

## Geographic testing set

```{r}

# =============================================================================
# 1. SETUP
# =============================================================================
train_val_test_path <- "saved/results/Cindex/Merge/cindex_train_val_test_final.csv"
final_path <- "saved/results/Cindex/Merge/cindex_final.csv"

# =============================================================================
# 2. LOAD, COMBINE, AND PREPARE DATA
# =============================================================================
print("--- Loading and preparing C-index data... ---")

traintest_data <- read_csv(train_val_test_path, show_col_types = FALSE)
external_test_data <- read_csv(final_path, show_col_types = FALSE) %>%
  filter(
    metric == "c_index",
    comparison_model %in% c("Metabolomics", "Proteomics")
  ) %>%
  mutate(data_split = "external_test") %>%
  select(data_split, outcome, n_samples, comparison_model, metric, point_estimate, ci_lower, ci_upper)

plot_data <- bind_rows(traintest_data, external_test_data) %>%
  mutate(
    data_split = factor(
      data_split,
      levels = c("external_test", "internal_test", "val", "train"),
      labels = c("Hold-out testing", "Geographic testing", "Validation", "Train")
    ),
    outcome = factor(
      outcome,
      levels = c("cad", "stroke", "hf", "af", "pad", "vte"),
      labels = c("CAD", "Stroke", "HF", "AF", "PAD", "VTE")
    ),
    comparison_model = factor(
      comparison_model,
      levels = c("Metabolomics", "Proteomics"),
      labels = c("MetScore", "ProScore")
    )
  )

# =============================================================================
# 3. CREATE THE FOREST PLOT
# =============================================================================
print("--- Generating forest plot... ---")

plot_data_filtered <- plot_data %>%
  filter(data_split %in% c("Geographic testing", "Hold-out testing"))

color_palette <- c(
  "Geographic testing" = "#E64B35B2",
  "Hold-out testing" = "#4DBBD5B2"
)

cindex_comparison_plot <- ggplot(
  plot_data_filtered, 
  aes(x = point_estimate, y = comparison_model, color = data_split)
) +
  geom_linerange(
    aes(xmin = ci_lower, xmax = ci_upper), 
    linewidth = 1, 
    position = position_dodge(width = 0.6)
  ) +
  geom_point(size = 2.5, position = position_dodge(width = 0.6)) +
  facet_wrap(~ outcome, nrow = 1) +
  scale_color_manual(values = color_palette) +
  labs(
    x = "C-index (95% CI)", 
    y = NULL,
    color = NULL
  ) +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black"),
    axis.text.y = element_text(size = 12, colour = "black"),
    axis.title.x = element_text(size = 12),
    axis.ticks.y = element_blank(),
    panel.grid = element_blank(),
    legend.position = "bottom",
    strip.background = element_blank(),
    strip.text = element_text(size = 12)
  )

# =============================================================================
# 4. SAVE AND CLEAN UP
# =============================================================================
ggsave(str_c(getwd(), "/results/Figure/Performance_comparison_geographic_test.svg"), plot = cindex_comparison_plot, width = 14, height = 4, unit = "in", dpi = 300, device = "svg")

rm(train_val_test_path, final_path, traintest_data, external_test_data, 
   plot_data, plot_data_filtered, color_palette, cindex_comparison_plot)

print("--- Script finished and environment cleaned. ---")

```

## Single omics vs multiomics

```{r}

# =============================================================================
# 1. SETUP
# =============================================================================
cindex_path <- "saved/results/Cindex/Merge/cindex_single_vs_multi_omics_final.csv"

# =============================================================================
# 2. LOAD AND PREPARE DATA
# =============================================================================
print("--- Loading and preparing incremental C-index data... ---")

outcomes_list <- c("cad", "stroke", "hf", "af", "pad", "vte")
baselines_to_add <- c("PANEL_Genomics", "PANEL_Metabolomics", "PANEL_Proteomics")

placeholder_data <- expand_grid(
    outcome = outcomes_list, 
    baseline_model = baselines_to_add
  ) %>%
  mutate(
    comparison_model = baseline_model,
    metric = "delta_c_index",
    point_estimate = NA, ci_lower = NA, ci_upper = NA
  )

model_order_levels <- c(
  "PANEL", "*+PRS*", "*+MetScore*", "*+ProScore*", 
  "*+PRS +MetScore*", "*+PRS +ProScore*", "*+MetScore +ProScore*", 
  "*+PRS +MetScore +ProScore*"
)

plot_data <- read_csv(cindex_path, show_col_types = FALSE) %>%
  add_row(
    outcome = "cad", baseline_model = "PANEL_Genomics",
    comparison_model = "PANEL", metric = "delta_c_index",
    point_estimate = NA, ci_lower = NA, ci_upper = NA
  ) %>%
  bind_rows(placeholder_data) %>%
  filter(metric == "delta_c_index") %>%
  mutate(
    model_group = baseline_model %>%
      str_replace_all(c("Genomics" = "PRS", "Metabolomics" = "MetScore", "Proteomics" = "ProScore")) %>%
      str_replace("PANEL_", "PANEL+") %>%
      str_replace_all("_", "+"),
    model_group = factor(model_group, levels = c("PANEL+PRS", "PANEL+MetScore", "PANEL+ProScore")),
    comparison_model_formatted = case_when(
      comparison_model == "PANEL" ~ "PANEL",
      TRUE ~ comparison_model %>%
        str_remove("^(PANEL)_") %>%
        str_replace_all(c("Genomics" = "PRS", "Metabolomics" = "MetScore", "Proteomics" = "ProScore")) %>%
        str_replace_all("_", " +") %>%
        paste0("+", .) %>%
        paste0("*", ., "*")
    ),
    comparison_model_formatted = factor(comparison_model_formatted, levels = rev(model_order_levels)),
    outcome = factor(
      outcome,
      levels = c("cad", "stroke", "hf", "af", "pad", "vte"),
      labels = c("CAD", "Stroke", "HF", "AF", "PAD", "VTE")
    )
  )

baseline_text_data <- plot_data %>%
  filter(
    (model_group == "PANEL+PRS" & comparison_model_formatted == "*+PRS*") |
    (model_group == "PANEL+MetScore" & comparison_model_formatted == "*+MetScore*") |
    (model_group == "PANEL+ProScore" & comparison_model_formatted == "*+ProScore*")
  )

proscore_baseline <- plot_data %>% filter(baseline_model == "PANEL_Proteomics")%>%
  mutate(estimate_ci = sprintf("%.3f (%.3f, %.3f)", point_estimate, ci_lower, ci_upper)) %>%
  select(estimate_ci, comparison_model_formatted, everything())
print(proscore_baseline %>% filter(!is.na(point_estimate)) %>% arrange(point_estimate))

# =============================================================================
# 3. CREATE THE FOREST PLOT
# =============================================================================
print("--- Generating forest plot... ---")

plot_color <- "#3C5488CC" 

delta_cindex_plot <- ggplot(
  plot_data, 
  aes(x = point_estimate, y = comparison_model_formatted, color = model_group)
) +
  geom_vline(xintercept = 0, color = "#D3D3D3", linetype = "dashed", linewidth = 0.75) +
  geom_linerange(aes(xmin = ci_lower, xmax = ci_upper), color = plot_color, linewidth = 1) +
  geom_point(size = 1.5, alpha = 1, color = plot_color) + 
  geom_text(
    data = baseline_text_data,
    aes(x = 0, label = "Baseline"),
    nudge_x = 0.002,
    size = 4,
    color = "black",
    hjust = 0
  ) +
  facet_grid(model_group ~ outcome, scales = "free_y", space = "free_y") +
  coord_cartesian(xlim = c(-0.03, 0.1)) +
  scale_x_continuous(breaks = c(0, 0.03, 0.06, 0.09)) +
  scale_color_manual(values = c(plot_color, plot_color, plot_color), guide = "none") +
  labs(x = "\u0394 C-index (95% CI)", y = NULL) +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_markdown(size = 12, hjust = 0.5, vjust = -0.5, family = "Arial"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90),
    axis.ticks.y = element_blank(),
    panel.grid = element_blank(),
    legend.position = "none",
    strip.background = element_blank(),
    strip.text = element_text(size = 12),
    strip.text.y = element_blank()
  )

# =============================================================================
# 2. SAVE AND CLEAN UP
# =============================================================================
ggsave(str_c(getwd(), "/results/Figure/Performance_comparison_single_omics_multiomics.svg"), plot = delta_cindex_plot, width = 14, height = 7, unit = "in", dpi = 300, device = "svg")

rm(placeholder_data, baselines_to_add, model_order_levels, outcomes_list, cindex_path, plot_data, baseline_text_data, plot_color, delta_cindex_plot, proscore_baseline)

print("--- Script finished and environment cleaned. ---")

```

## Individual biomarker

### Protein

#### C-index forest plot

```{r}

# =============================================================================
# 1. SETUP
# =============================================================================
cindex_path <- "saved/results/Cindex/Merge/cindex_individual_biomarker_final.csv"
cindex_final_path <- "saved/results/Cindex/Merge/cindex_final.csv"

# =============================================================================
# 2. LOAD AND PREPARE DATA
# =============================================================================
print("--- Loading and preparing C-index data... ---")

# --- Load both data files ---
cindex_data_raw <- read_csv(cindex_path, show_col_types = FALSE) %>%
  filter(metric == "c_index" & biomarker == "protein")

cindex_panel <- read_csv(cindex_final_path, show_col_types = FALSE) %>%
  filter(comparison_model == "PANEL" & metric == "c_index") %>%
  mutate(biomarker = "protein")

# --- Create model_order_levels ---
biomarker <- c("CDCP1", "EDA2R", "GDF15", "MMP12", "NTproBNP", "CRIP2", "FASLG", "KLK4", "NEFL", "NPPB", "WFDC2", "BCAN", "ELN", "ENDOU", "PLB1", "ADGRG2", "HPGDS")

formatted_biomarker <- paste0("*+", biomarker, "*")
all_model_names <- c("PANEL", biomarker, formatted_biomarker)

panel_model <- "PANEL"
other_models <- all_model_names[all_model_names != panel_model]

sorted_other_models <- tibble(model = other_models) %>%
  mutate(
    sort_key = str_remove_all(model, "[*+]")
  ) %>%
  arrange(sort_key, model) %>%
  pull(model)
model_order_levels <- c(panel_model, sorted_other_models)

plot_data <- cindex_data_raw %>%
  bind_rows(cindex_panel) %>%
  mutate(
    model_group = case_when(
      str_starts(comparison_model, "PANEL") ~ "PANEL-based",
      TRUE ~ "Individual biomarker"
    ),
    model_group = factor(model_group, levels = c("Individual biomarker", "PANEL-based")),
    comparison_model_formatted = case_when(
      str_starts(comparison_model, "PANEL_") ~ comparison_model %>%
        str_remove("PANEL_") %>%
        paste0("+", .) %>%
        paste0("*", ., "*"),
      comparison_model %in% c("PANEL", biomarker) ~ comparison_model,
      TRUE ~ comparison_model
    ),
    comparison_model_formatted = factor(comparison_model_formatted, levels = rev(model_order_levels)),
    outcome = factor(
      outcome,
      levels = c("cad", "stroke", "hf", "af", "pad", "vte"),
      labels = c("CAD", "Stroke", "HF", "AF", "PAD", "VTE")
    )
  )

# =============================================================================
# 3. CREATE THE FOREST PLOT
# =============================================================================
print("--- Generating forest plot... ---")

baseline_lines <- plot_data %>% 
  filter(comparison_model_formatted %in% c("PANEL")) %>%
  select(outcome, model_group, point_estimate)

color_palette <- c(
  "Individual biomarker"     = "#8491B4CC",
  "PANEL-based"     = "#3C5488CC"
)

cindex_forest_protein_plot <- ggplot(
  plot_data, 
  aes(x = point_estimate, y = comparison_model_formatted, color = model_group)
) +
  geom_vline(
    data = baseline_lines,
    aes(xintercept = point_estimate),
    color = "#D3D3D3", 
    linetype = "dashed", 
    linewidth = 0.75
  ) +
  geom_linerange(aes(xmin = ci_lower, xmax = ci_upper), linewidth = 1) +
  geom_point(size = 1, alpha = 1) + 
  facet_grid(model_group ~ outcome, scales = "free_y", space = "free_y") +
  coord_cartesian(xlim = c(0.49, 1.02)) +
  scale_x_continuous(breaks = c(0.5, 0.75, 1.0), labels = c("0.5", "0.75", "1.0")) +
  scale_color_manual(values = color_palette, name = NULL) + 
  labs(x = "C-index (95% CI)", y = NULL) +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = 0, angle = 0),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90),
    axis.ticks.y = element_blank(),
    panel.grid = element_blank(),
    legend.title = element_text(size = 12, hjust = 0.1),
    legend.text = element_text(size = 12),
    legend.position = "none",
    strip.background = element_blank(),
    strip.text.x = element_text(size = 12),
    strip.text.y = element_blank()
  )

legend <- ggplot(
  plot_data, 
  aes(x = point_estimate, y = reorder_within(comparison_model_formatted, desc(comparison_model_formatted), model_group), color = model_group)
) +
  geom_linerange(aes(xmin = ci_lower, xmax = ci_upper), linewidth = 1) +
  geom_point(size = 1, alpha = 1) + 
  facet_grid(model_group ~ outcome, scales = "free_y", space = "free_y") +
  scale_color_manual(values = color_palette, name = NULL) + 
  tidytext::scale_y_reordered() +
  theme_bw() +
  theme(
    legend.title = element_text(size = 12, hjust = 0.1),
    legend.text = element_text(size = 12),
    legend.position = "bottom"
  )

# =============================================================================
# 5. CLEAN UP ENVIRONMENT
# =============================================================================
rm(cindex_path, cindex_final_path, cindex_data_raw, cindex_panel, biomarker, formatted_biomarker, all_model_names, panel_model, other_models, sorted_other_models, plot_data, model_order_levels, color_palette, baseline_lines)

print("--- Script finished and environment cleaned. ---")

```

#### Delta C-index

```{r}

# =============================================================================
# 1. SETUP
# =============================================================================
cindex_path <- "saved/results/Cindex/Merge/cindex_individual_biomarker_final.csv"

# =============================================================================
# 2. LOAD AND PREPARE DATA (Data wrangling is the same as before)
# =============================================================================
print("--- Loading and preparing C-index data... ---")
cindex_data_raw <- read_csv(cindex_path, show_col_types = FALSE) %>% 
  filter(metric == "delta_c_index" & biomarker == "protein" & baseline_model == "PANEL")

biomarker <- c("CDCP1", "EDA2R", "GDF15", "MMP12", "NTproBNP", "CRIP2", "FASLG", "KLK4", "NEFL", "NPPB", "WFDC2", "BCAN", "ELN", "ENDOU", "PLB1", "ADGRG2", "HPGDS")
formatted_biomarker <- paste0("*+", biomarker, "*")
all_model_names <- c("PANEL", biomarker, formatted_biomarker)

panel_model <- "PANEL"
other_models <- all_model_names[all_model_names != panel_model]

sorted_other_models <- tibble(model = other_models) %>%
  mutate(
    sort_key = str_remove_all(model, "[*+]")
  ) %>%
  arrange(sort_key, model) %>%
  pull(model)
model_order_levels <- c(panel_model, sorted_other_models)


outcomes_list <- c("cad", "stroke", "hf", "af", "pad", "vte")
placeholder_data <- expand_grid(
    outcome = outcomes_list, 
    baseline_model = "PANEL"
  ) %>%
  mutate(
    comparison_model = baseline_model, metric = "delta_c_index",
    biomarker = NA, point_estimate = NA, ci_lower = NA, ci_upper = NA
  )

plot_data <- cindex_data_raw %>%
  bind_rows(placeholder_data) %>%
  mutate(
    model_group = case_when(
      str_starts(comparison_model, "PANEL") ~ "PANEL-based",
      TRUE ~ "Individual biomarker"
    ),
    model_group = factor(model_group, levels = c("Individual biomarker", "PANEL-based")),
    comparison_model_formatted = case_when(
      comparison_model %in% c("PANEL") ~ comparison_model,
      TRUE ~ comparison_model %>%
        str_remove("^(PANEL)_") %>%
        str_replace_all("_", " +") %>%
        paste0("+", .) %>%
        paste0("*", ., "*")
    ),
    comparison_model_formatted = factor(comparison_model_formatted, levels = rev(model_order_levels)),
    outcome = factor(
      outcome,
      levels = c("cad", "stroke", "hf", "af", "pad", "vte"),
      labels = c("CAD", "Stroke", "HF", "AF", "PAD", "VTE")
    )
  )
print(
  plot_data %>% 
    filter(comparison_model_formatted != "PANEL")  %>%
    mutate(estimate_ci = sprintf("%.3f (%.3f, %.3f)", point_estimate, ci_lower, ci_upper)) %>%
    select(estimate_ci, comparison_model_formatted, everything()) %>%
    arrange(outcome, desc(point_estimate))
  )

# =============================================================================
# 3. CREATE THE DELTA C-INDEX FOREST PLOT
# =============================================================================
print("--- Generating delta C-index forest plot... ---")

delta_plot_data <- plot_data %>%
  mutate(
    across(
      c(point_estimate, ci_lower, ci_upper),
      ~ if_else(comparison_model_formatted %in% c("PANEL"), NA_real_, .x)
    )
  )

baseline_text_data <- delta_plot_data %>%
  filter(comparison_model_formatted %in% c("PANEL"))

color_palette <- c(
  "Individual biomarker"     = "#8491B4CC",
  "PANEL-based"     = "#3C5488CC"
)

delta_cindex_protein_plot <- ggplot(
  delta_plot_data, 
  aes(x = point_estimate, y = comparison_model_formatted, color = model_group)
) +
  geom_vline(
    xintercept = 0,
    color = "#D3D3D3", 
    linetype = "dashed", 
    linewidth = 0.75
  ) +
  geom_linerange(aes(xmin = ci_lower, xmax = ci_upper), linewidth = 1) +
  geom_point(size = 1, alpha = 1) + 
  geom_text(
    data = baseline_text_data,
    aes(x = 0, label = "Baseline"),
    nudge_x = 0.005,
    size = 3.5,
    color = "black",
    hjust = 0
  ) +
  facet_grid(~ outcome, scales = "free_y", space = "free_y") +
  coord_cartesian(xlim = c(-0.01, 0.04)) +
  scale_x_continuous(breaks = c(0, 0.015, 0.03), labels = c("0", "0.015", "0.03")) +
  scale_color_manual(values = color_palette, name = NULL) + 
  labs(x = "\u0394 C-index (95% CI)", y = NULL) +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_markdown(size = 12, hjust = 0.5, vjust = 1, family = "Arial"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90),
    axis.ticks.y = element_blank(),
    panel.grid = element_blank(),
    legend.title = element_text(size = 12, hjust = 0.1),
    legend.text = element_text(size = 12),
    legend.position = "none",
    strip.background = element_blank(),
    strip.text.x = element_text(size = 12),
    strip.text.y = element_blank()
  )

# =============================================================================
# 4. CLEAN UP ENVIRONMENT
# =============================================================================
rm(cindex_path, cindex_data_raw, outcomes_list, placeholder_data, plot_data, biomarker, formatted_biomarker, all_model_names, panel_model, other_models, sorted_other_models, model_order_levels, delta_plot_data, baseline_text_data, color_palette)

print("--- Script finished and environment cleaned. ---")

```

### Metabolite

#### C-index forest plot

```{r}

# =============================================================================
# 1. SETUP
# =============================================================================
cindex_path <- "saved/results/Cindex/Merge/cindex_individual_biomarker_final.csv"
cindex_final_path <- "saved/results/Cindex/Merge/cindex_final.csv"

# =============================================================================
# 2. LOAD AND PREPARE DATA
# =============================================================================
print("--- Loading and preparing C-index data... ---")

# --- Load both data files ---
cindex_data_raw <- read_csv(cindex_path, show_col_types = FALSE) %>%
  filter(metric == "c_index" & biomarker == "metabolite")

cindex_panel <- read_csv(cindex_final_path, show_col_types = FALSE) %>%
  filter(comparison_model == "PANEL" & metric == "c_index") %>%
  mutate(biomarker = "metabolite")

# --- Create model_order_levels ---
biomarker <- c("MUFA", "LA", "Creatinine", "Albumin", "XL_HDL_FC", "Gln", "XXL_VLDL_CE", "IDL_FC")
formatted_biomarker <- paste0("*+", biomarker, "*")
all_model_names <- c("PANEL", biomarker, formatted_biomarker)

panel_model <- "PANEL"
other_models <- all_model_names[all_model_names != panel_model]

sorted_other_models <- tibble(model = other_models) %>%
  mutate(
    sort_key = str_remove_all(model, "[*+]")
  ) %>%
  arrange(sort_key, model) %>%
  pull(model)
model_order_levels <- c(panel_model, sorted_other_models)

plot_data <- cindex_data_raw %>%
  bind_rows(cindex_panel) %>%
  mutate(
    model_group = case_when(
      str_starts(comparison_model, "PANEL") ~ "PANEL-based",
      TRUE ~ "Individual biomarker"
    ),
    model_group = factor(model_group, levels = c("Individual biomarker", "PANEL-based")),
    comparison_model_formatted = case_when(
      str_starts(comparison_model, "PANEL_") ~ comparison_model %>%
        str_remove("PANEL_") %>%
        paste0("+", .) %>%
        paste0("*", ., "*"),
      comparison_model %in% c("PANEL", biomarker) ~ comparison_model,
      TRUE ~ comparison_model
    ),
    comparison_model_formatted = factor(comparison_model_formatted, levels = rev(model_order_levels)),
    outcome = factor(
      outcome,
      levels = c("cad", "stroke", "hf", "af", "pad", "vte"),
      labels = c("CAD", "Stroke", "HF", "AF", "PAD", "VTE")
    )
  )

# =============================================================================
# 3. CREATE THE FOREST PLOT
# =============================================================================
print("--- Generating forest plot... ---")

baseline_lines <- plot_data %>% 
  filter(comparison_model_formatted %in% c("PANEL")) %>%
  select(outcome, model_group, point_estimate)

color_palette <- c(
  "Individual biomarker"     = "#8491B4CC",
  "PANEL-based"     = "#3C5488CC"
)

cindex_forest_metabolite_plot <- ggplot(
  plot_data, 
  aes(x = point_estimate, y = comparison_model_formatted, color = model_group)
) +
  geom_vline(
    data = baseline_lines,
    aes(xintercept = point_estimate),
    color = "#D3D3D3", 
    linetype = "dashed", 
    linewidth = 0.75
  ) +
  geom_linerange(aes(xmin = ci_lower, xmax = ci_upper), linewidth = 1) +
  geom_point(size = 1, alpha = 1) + 
  facet_grid(model_group ~ outcome, scales = "free_y", space = "free_y") +
  coord_cartesian(xlim = c(0.49, 1.02)) +
  scale_x_continuous(breaks = c(0.5, 0.75, 1.0), labels = c("0.5", "0.75", "1.0")) +
  scale_color_manual(values = color_palette, name = NULL) + 
  labs(x = "C-index (95% CI)", y = NULL) +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = 0, angle = 0),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90),
    axis.ticks.y = element_blank(),
    panel.grid = element_blank(),
    legend.title = element_text(size = 12, hjust = 0.1),
    legend.text = element_text(size = 12),
    legend.position = "none",
    strip.background = element_blank(),
    strip.text.x = element_text(size = 12),
    strip.text.y = element_blank()
  )

legend <- ggplot(
  plot_data, 
  aes(x = point_estimate, y = reorder_within(comparison_model_formatted, desc(comparison_model_formatted), model_group), color = model_group)
) +
  geom_linerange(aes(xmin = ci_lower, xmax = ci_upper), linewidth = 1) +
  geom_point(size = 1, alpha = 1) + 
  facet_grid(model_group ~ outcome, scales = "free_y", space = "free_y") +
  scale_color_manual(values = color_palette, name = NULL) + 
  tidytext::scale_y_reordered() +
  theme_bw() +
  theme(
    legend.title = element_text(size = 12, hjust = 0.1),
    legend.text = element_text(size = 12),
    legend.position = "bottom"
  )

# =============================================================================
# 5. CLEAN UP ENVIRONMENT
# =============================================================================
rm(cindex_path, cindex_final_path, cindex_data_raw, cindex_panel, biomarker, formatted_biomarker, all_model_names, panel_model, other_models, sorted_other_models, plot_data, model_order_levels, color_palette, baseline_lines)

print("--- Script finished and environment cleaned. ---")

```

#### Delta C-index

```{r}

# =============================================================================
# 1. SETUP
# =============================================================================
cindex_path <- "saved/results/Cindex/Merge/cindex_individual_biomarker_final.csv"

# =============================================================================
# 2. LOAD AND PREPARE DATA (Data wrangling is the same as before)
# =============================================================================
print("--- Loading and preparing C-index data... ---")
cindex_data_raw <- read_csv(cindex_path, show_col_types = FALSE) %>% 
  filter(metric == "delta_c_index" & biomarker == "metabolite" & baseline_model == "PANEL")

biomarker <- c("MUFA", "LA", "Creatinine", "Albumin", "XL_HDL_FC", "Gln", "XXL_VLDL_CE", "IDL_FC")
formatted_biomarker <- paste0("*+", biomarker, "*")
all_model_names <- c("PANEL", biomarker, formatted_biomarker)

panel_model <- "PANEL"
other_models <- all_model_names[all_model_names != panel_model]

sorted_other_models <- tibble(model = other_models) %>%
  mutate(
    sort_key = str_remove_all(model, "[*+]")
  ) %>%
  arrange(sort_key, model) %>%
  pull(model)
model_order_levels <- c(panel_model, sorted_other_models)


outcomes_list <- c("cad", "stroke", "hf", "af", "pad", "vte")
placeholder_data <- expand_grid(
    outcome = outcomes_list, 
    baseline_model = "PANEL"
  ) %>%
  mutate(
    comparison_model = baseline_model, metric = "delta_c_index",
    biomarker = NA, point_estimate = NA, ci_lower = NA, ci_upper = NA
  )

plot_data <- cindex_data_raw %>%
  bind_rows(placeholder_data) %>%
  mutate(
    model_group = case_when(
      str_starts(comparison_model, "PANEL") ~ "PANEL-based",
      TRUE ~ "Individual biomarker"
    ),
    model_group = factor(model_group, levels = c("Individual biomarker", "PANEL-based")),
    comparison_model_formatted = case_when(
      str_starts(comparison_model, "PANEL_") ~ comparison_model %>%
        str_remove("PANEL_") %>%
        paste0("+", .) %>%
        paste0("*", ., "*"),
      comparison_model %in% c("PANEL", biomarker) ~ comparison_model,
      TRUE ~ comparison_model
    ),
    comparison_model_formatted = factor(comparison_model_formatted, levels = rev(model_order_levels)),
    outcome = factor(
      outcome,
      levels = c("cad", "stroke", "hf", "af", "pad", "vte"),
      labels = c("CAD", "Stroke", "HF", "AF", "PAD", "VTE")
    )
  )
print(
  plot_data %>% 
    filter(comparison_model_formatted != "PANEL")  %>%
    mutate(estimate_ci = sprintf("%.3f (%.3f, %.3f)", point_estimate, ci_lower, ci_upper)) %>%
    select(estimate_ci, comparison_model_formatted, everything()) %>%
    arrange(outcome, desc(point_estimate))
  )

# =============================================================================
# 3. CREATE THE DELTA C-INDEX FOREST PLOT
# =============================================================================
print("--- Generating delta C-index forest plot... ---")

delta_plot_data <- plot_data %>%
  mutate(
    across(
      c(point_estimate, ci_lower, ci_upper),
      ~ if_else(comparison_model_formatted %in% c("PANEL"), NA_real_, .x)
    )
  )

baseline_text_data <- delta_plot_data %>%
  filter(comparison_model_formatted %in% c("PANEL"))

color_palette <- c(
  "Individual biomarker"     = "#8491B4CC",
  "PANEL-based"     = "#3C5488CC"
)

delta_cindex_metabolite_plot <- ggplot(
  delta_plot_data, 
  aes(x = point_estimate, y = comparison_model_formatted, color = model_group)
) +
  geom_vline(
    xintercept = 0,
    color = "#D3D3D3", 
    linetype = "dashed", 
    linewidth = 0.75
  ) +
  geom_linerange(aes(xmin = ci_lower, xmax = ci_upper), linewidth = 1) +
  geom_point(size = 1, alpha = 1) + 
  geom_text(
    data = baseline_text_data,
    aes(x = 0, label = "Baseline"),
    nudge_x = 0.005,
    size = 3.5,
    color = "black",
    hjust = 0
  ) +
  facet_grid(~ outcome, scales = "free_y", space = "free_y") +
  coord_cartesian(xlim = c(-0.01, 0.04)) +
  scale_x_continuous(breaks = c(0, 0.015, 0.03), labels = c("0", "0.015", "0.03")) +
  scale_color_manual(values = color_palette, name = NULL) + 
  labs(x = "\u0394 C-index (95% CI)", y = NULL) +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_markdown(size = 12, hjust = 0.5, vjust = 1, family = "Arial"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90),
    axis.ticks.y = element_blank(),
    panel.grid = element_blank(),
    legend.title = element_text(size = 12, hjust = 0.1),
    legend.text = element_text(size = 12),
    legend.position = "none",
    strip.background = element_blank(),
    strip.text.x = element_text(size = 12),
    strip.text.y = element_blank()
  )

# =============================================================================
# 4. CLEAN UP ENVIRONMENT
# =============================================================================
rm(cindex_path, cindex_data_raw, outcomes_list, placeholder_data, plot_data, biomarker, formatted_biomarker, all_model_names, panel_model, other_models, sorted_other_models, model_order_levels, delta_plot_data, baseline_text_data, color_palette)

print("--- Script finished and environment cleaned. ---")

```

### Pool

```{r}

# =============================================================================
# 1. COMBINE PLOTS
# =============================================================================
height1 <- n_distinct(cindex_forest_metabolite_plot$data$comparison_model_formatted)
height2 <- n_distinct(delta_cindex_metabolite_plot$data$comparison_model_formatted)
height3 <- n_distinct(cindex_forest_protein_plot$data$comparison_model_formatted)
height4 <- n_distinct(delta_cindex_protein_plot$data$comparison_model_formatted)

proportional_heights <- c(height1, height2, height3, height4)

cindex_plot <- (cindex_forest_metabolite_plot / delta_cindex_metabolite_plot / cindex_forest_protein_plot / delta_cindex_protein_plot) + 
  plot_layout(heights = proportional_heights) +
  plot_annotation(tag_levels = "a") &
  theme(plot.tag = element_text(face = "bold"))

cindex_plot <- wrap_elements(cindex_plot) / ggpubr::get_legend(legend) +
  plot_layout(heights = c(0.95, 0.01))

# =============================================================================
# 2. SAVE AND CLEAN UP
# =============================================================================
print("--- Saving final plot in all formats... ---")

ggsave(str_c(getwd(), "/results/Figure/Performance_comparison_individual_biomarker.svg"), plot = cindex_plot, width = 14, height = 26, unit = "in", dpi = 300, device = "svg")

rm(height1, height2, height3, height4, proportional_heights, cindex_plot, legend, cindex_forest_metabolite_plot, delta_cindex_metabolite_plot, cindex_forest_protein_plot, delta_cindex_protein_plot)

```

## LDL biomarker

### All participants

#### C-index forest plot

```{r}

# =============================================================================
# 1. SETUP
# =============================================================================
cindex_path <- "saved/results/Cindex/Merge/cindex_LDL_biomarker_final.csv"
cindex_final_path <- "saved/results/Cindex/Merge/cindex_final.csv"

# =============================================================================
# 2. LOAD AND PREPARE DATA
# =============================================================================
print("--- Loading and preparing C-index data... ---")

# --- Load both data files ---
cindex_data_raw <- read_csv(cindex_path, show_col_types = FALSE) %>%
  filter(metric == "c_index")

cindex_panel <- read_csv(cindex_final_path, show_col_types = FALSE) %>%
  filter(comparison_model == "PANEL" & metric == "c_index")

# --- Create model_order_levels ---
total_lipids <- c(
    "Total_C", "non_HDL_C", "Remnant_C", "Total_TG", "Total_PL", 
    "Total_CE", "Total_FC", "Total_L"
)

ldl_lipids <- c(
    "Clinical_LDL_C", "LDL_C", "LDL_TG", "LDL_PL", "LDL_CE", 
    "LDL_FC", "LDL_L", "LDL_P", "LDL_size"
)

all_total_lipids <- c(sort(total_lipids), paste0("*+", sort(total_lipids), "*"))
sorted_total_lipids <- tibble(model = all_total_lipids) %>%
  mutate(sort_key = str_remove_all(model, "[*+]")) %>%
  arrange(sort_key, model) %>%
  pull(model)

all_ldl_lipids <- c(sort(ldl_lipids), paste0("*+", sort(ldl_lipids), "*"))
sorted_ldl_lipids <- tibble(model = all_ldl_lipids) %>%
  mutate(sort_key = str_remove_all(model, "[*+]")) %>%
  arrange(sort_key, model) %>%
  pull(model)
model_order_levels <- c("PANEL", sorted_total_lipids, sorted_ldl_lipids)

plot_data <- cindex_data_raw %>%
  bind_rows(cindex_panel) %>%
  mutate(
    model_group = case_when(
      str_starts(comparison_model, "PANEL") ~ "PANEL-based",
      TRUE ~ "Individual biomarker"
    ),
    model_group = factor(model_group, levels = c("Individual biomarker", "PANEL-based")),
    comparison_model_formatted = case_when(
      str_starts(comparison_model, "PANEL_") ~ comparison_model %>%
        str_remove("PANEL_") %>%
        paste0("+", .) %>%
        paste0("*", ., "*"),
      comparison_model %in% c("PANEL", total_lipids, ldl_lipids) ~ comparison_model,
      TRUE ~ comparison_model
    ),
    comparison_model_formatted = factor(comparison_model_formatted, levels = rev(model_order_levels)),
    outcome = factor(
      outcome,
      levels = c("cad", "stroke", "hf", "af", "pad", "vte"),
      labels = c("CAD", "Stroke", "HF", "AF", "PAD", "VTE")
    )
  )

# =============================================================================
# 3. CREATE THE FOREST PLOT
# =============================================================================
print("--- Generating forest plot... ---")

baseline_lines <- plot_data %>% 
  filter(comparison_model_formatted %in% c("PANEL")) %>%
  select(outcome, model_group, point_estimate)

color_palette <- c(
  "Individual biomarker"     = "#8491B4CC",
  "PANEL-based"     = "#3C5488CC"
)

cindex_forest_plot <- ggplot(
  plot_data, 
  aes(x = point_estimate, y = comparison_model_formatted, color = model_group)
) +
  geom_vline(
    data = baseline_lines,
    aes(xintercept = point_estimate),
    color = "#D3D3D3", 
    linetype = "dashed", 
    linewidth = 0.75
  ) +
  geom_linerange(aes(xmin = ci_lower, xmax = ci_upper), linewidth = 1) +
  geom_point(size = 1, alpha = 1) + 
  facet_grid(model_group ~ outcome, scales = "free_y", space = "free_y") +
  coord_cartesian(xlim = c(0.49, 1.02)) +
  scale_x_continuous(breaks = c(0.5, 0.75, 1.0), labels = c("0.5", "0.75", "1.0")) +
  scale_color_manual(values = color_palette, name = NULL) + 
  labs(x = "C-index (95% CI)", y = NULL) +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = 0, angle = 0),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90),
    axis.ticks.y = element_blank(),
    panel.grid = element_blank(),
    legend.title = element_text(size = 12, hjust = 0.1),
    legend.text = element_text(size = 12),
    legend.position = "none",
    strip.background = element_blank(),
    strip.text.x = element_text(size = 12),
    strip.text.y = element_blank()
  )

legend <- ggplot(
  plot_data, 
  aes(x = point_estimate, y = reorder_within(comparison_model_formatted, desc(comparison_model_formatted), model_group), color = model_group)
) +
  geom_linerange(aes(xmin = ci_lower, xmax = ci_upper), linewidth = 1) +
  geom_point(size = 1, alpha = 1) + 
  facet_grid(model_group ~ outcome, scales = "free_y", space = "free_y") +
  scale_color_manual(values = color_palette, name = NULL) + 
  tidytext::scale_y_reordered() +
  theme_bw() +
  theme(
    legend.title = element_text(size = 12, hjust = 0.1),
    legend.text = element_text(size = 12),
    legend.position = "bottom"
  )

# =============================================================================
# 5. CLEAN UP ENVIRONMENT
# =============================================================================
rm(cindex_path, cindex_data_raw, cindex_panel, plot_data, color_palette, total_lipids, ldl_lipids, all_total_lipids, sorted_total_lipids, all_ldl_lipids, sorted_ldl_lipids, model_order_levels, baseline_lines)

print("--- Script finished and environment cleaned. ---")

```

#### Delta C-index

```{r}

# =============================================================================
# 1. SETUP
# =============================================================================
cindex_path <- "saved/results/Cindex/Merge/cindex_LDL_biomarker_final.csv"

# =============================================================================
# 2. LOAD AND PREPARE DATA (Data wrangling is the same as before)
# =============================================================================
print("--- Loading and preparing C-index data... ---")
cindex_data_raw <- read_csv(cindex_path, show_col_types = FALSE) %>% 
  filter(metric == "delta_c_index" & baseline_model == "PANEL")

# --- Create model_order_levels ---
total_lipids <- c(
    "Total_C", "non_HDL_C", "Remnant_C", "Total_TG", "Total_PL", 
    "Total_CE", "Total_FC", "Total_L"
)

ldl_lipids <- c(
    "Clinical_LDL_C", "LDL_C", "LDL_TG", "LDL_PL", "LDL_CE", 
    "LDL_FC", "LDL_L", "LDL_P", "LDL_size"
)

all_total_lipids <- c(sort(total_lipids), paste0("*+", sort(total_lipids), "*"))
sorted_total_lipids <- tibble(model = all_total_lipids) %>%
  mutate(sort_key = str_remove_all(model, "[*+]")) %>%
  arrange(sort_key, model) %>%
  pull(model)

all_ldl_lipids <- c(sort(ldl_lipids), paste0("*+", sort(ldl_lipids), "*"))
sorted_ldl_lipids <- tibble(model = all_ldl_lipids) %>%
  mutate(sort_key = str_remove_all(model, "[*+]")) %>%
  arrange(sort_key, model) %>%
  pull(model)
model_order_levels <- c("PANEL", sorted_total_lipids, sorted_ldl_lipids)

outcomes_list <- c("cad", "stroke", "hf", "af", "pad", "vte")
placeholder_data <- expand_grid(
    outcome = outcomes_list, 
    baseline_model = "PANEL"
  ) %>%
  mutate(
    comparison_model = baseline_model, metric = "delta_c_index",
    point_estimate = NA, ci_lower = NA, ci_upper = NA
  )

plot_data <- cindex_data_raw %>%
  bind_rows(placeholder_data) %>%
  mutate(
    model_group = case_when(
      str_starts(comparison_model, "PANEL") ~ "PANEL-based",
      TRUE ~ "Individual biomarker"
    ),
    model_group = factor(model_group, levels = c("Individual biomarker", "PANEL-based")),
    comparison_model_formatted = case_when(
      str_starts(comparison_model, "PANEL_") ~ comparison_model %>%
        str_remove("PANEL_") %>%
        paste0("+", .) %>%
        paste0("*", ., "*"),
      comparison_model %in% c("PANEL", total_lipids, ldl_lipids) ~ comparison_model,
      TRUE ~ comparison_model
    ),
    comparison_model_formatted = factor(comparison_model_formatted, levels = rev(model_order_levels)),
    outcome = factor(
      outcome,
      levels = c("cad", "stroke", "hf", "af", "pad", "vte"),
      labels = c("CAD", "Stroke", "HF", "AF", "PAD", "VTE")
    )
  )
print(
  plot_data %>% 
    filter(comparison_model_formatted != "PANEL")  %>%
    mutate(estimate_ci = sprintf("%.3f (%.3f, %.3f)", point_estimate, ci_lower, ci_upper)) %>%
    select(estimate_ci, comparison_model_formatted, everything()) %>%
    arrange(outcome, desc(point_estimate))
  )

# =============================================================================
# 3. CREATE THE DELTA C-INDEX FOREST PLOT
# =============================================================================
print("--- Generating delta C-index forest plot... ---")

delta_plot_data <- plot_data %>%
  mutate(
    across(
      c(point_estimate, ci_lower, ci_upper),
      ~ if_else(comparison_model_formatted %in% c("PANEL"), NA_real_, .x)
    )
  )

baseline_text_data <- delta_plot_data %>%
  filter(comparison_model_formatted %in% c("PANEL"))

color_palette <- c(
  "Individual biomarker"     = "#8491B4CC",
  "PANEL-based"     = "#3C5488CC"
)

delta_cindex_plot <- ggplot(
  delta_plot_data, 
  aes(x = point_estimate, y = comparison_model_formatted, color = model_group)
) +
  geom_vline(
    xintercept = 0,
    color = "#D3D3D3", 
    linetype = "dashed", 
    linewidth = 0.75
  ) +
  geom_linerange(aes(xmin = ci_lower, xmax = ci_upper), linewidth = 1) +
  geom_point(size = 1, alpha = 1) + 
  geom_text(
    data = baseline_text_data,
    aes(x = 0, label = "Baseline"),
    nudge_x = 0.005,
    size = 3.5,
    color = "black",
    hjust = 0
  ) +
  facet_grid(~ outcome, scales = "free_y", space = "free_y") +
  coord_cartesian(xlim = c(-0.01, 0.04)) +
  scale_x_continuous(breaks = c(0, 0.015, 0.03), labels = c("0", "0.015", "0.03")) +
  scale_color_manual(values = color_palette, name = NULL) + 
  labs(x = "\u0394 C-index (95% CI)", y = NULL) +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_markdown(size = 12, hjust = 0.5, vjust = 1, family = "Arial"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90),
    axis.ticks.y = element_blank(),
    panel.grid = element_blank(),
    legend.title = element_text(size = 12, hjust = 0.1),
    legend.text = element_text(size = 12),
    legend.position = "none",
    strip.background = element_blank(),
    strip.text.x = element_text(size = 12),
    strip.text.y = element_blank()
  )

# =============================================================================
# 4. CLEAN UP ENVIRONMENT
# =============================================================================
rm(cindex_path, cindex_data_raw, outcomes_list, placeholder_data, plot_data, delta_plot_data, baseline_text_data, color_palette, total_lipids, ldl_lipids, all_total_lipids, sorted_total_lipids, all_ldl_lipids, sorted_ldl_lipids, model_order_levels)

print("--- Script finished and environment cleaned. ---")

```

#### Pool

```{r}

# =============================================================================
# 1. COMBINE PLOTS
# =============================================================================
height1 <- n_distinct(cindex_forest_plot$data$comparison_model_formatted)
height2 <- n_distinct(delta_cindex_plot$data$comparison_model_formatted)

proportional_heights <- c(height1, height2)

cindex_plot <- (cindex_forest_plot / delta_cindex_plot) + 
  plot_layout(heights = proportional_heights) +
  plot_annotation(tag_levels = "a") &
  theme(plot.tag = element_text(face = "bold"))

cindex_plot <- wrap_elements(cindex_plot) / ggpubr::get_legend(legend) +
  plot_layout(heights = c(0.95, 0.01))

# =============================================================================
# 2. SAVE AND CLEAN UP
# =============================================================================
print("--- Saving final plot in all formats... ---")

ggsave(str_c(getwd(), "/results/Figure/Performance_comparison_LDL_biomarker.svg"), plot = cindex_plot, width = 14, height = 14, unit = "in", dpi = 300, device = "svg")

rm(height1, height2, proportional_heights, cindex_plot, legend, cindex_forest_plot, delta_cindex_plot)

```

### Participants not using lipid-lowering medication

#### C-index forest plot

```{r}

# =============================================================================
# 1. SETUP
# =============================================================================
cindex_path <- "saved/results/Cindex/Merge/cindex_LDL_biomarker_no_statins_final.csv"

# =============================================================================
# 2. LOAD AND PREPARE DATA
# =============================================================================
print("--- Loading and preparing C-index data... ---")

# --- Load both data files ---
cindex_data_raw <- read_csv(cindex_path, show_col_types = FALSE) %>%
  filter(metric == "c_index")

# --- Create model_order_levels ---
total_lipids <- c(
    "Total_C", "non_HDL_C", "Remnant_C", "Total_TG", "Total_PL", 
    "Total_CE", "Total_FC", "Total_L"
)

ldl_lipids <- c(
    "Clinical_LDL_C", "LDL_C", "LDL_TG", "LDL_PL", "LDL_CE", 
    "LDL_FC", "LDL_L", "LDL_P", "LDL_size"
)

all_total_lipids <- c(sort(total_lipids), paste0("*+", sort(total_lipids), "*"))
sorted_total_lipids <- tibble(model = all_total_lipids) %>%
  mutate(sort_key = str_remove_all(model, "[*+]")) %>%
  arrange(sort_key, model) %>%
  pull(model)

all_ldl_lipids <- c(sort(ldl_lipids), paste0("*+", sort(ldl_lipids), "*"))
sorted_ldl_lipids <- tibble(model = all_ldl_lipids) %>%
  mutate(sort_key = str_remove_all(model, "[*+]")) %>%
  arrange(sort_key, model) %>%
  pull(model)
model_order_levels <- c("PANEL", sorted_total_lipids, sorted_ldl_lipids)

plot_data <- cindex_data_raw %>%
  mutate(
    model_group = case_when(
      str_starts(comparison_model, "PANEL") ~ "PANEL-based",
      TRUE ~ "Individual biomarker"
    ),
    model_group = factor(model_group, levels = c("Individual biomarker", "PANEL-based")),
    comparison_model_formatted = case_when(
      str_starts(comparison_model, "PANEL_") ~ comparison_model %>%
        str_remove("PANEL_") %>%
        paste0("+", .) %>%
        paste0("*", ., "*"),
      comparison_model %in% c("PANEL", total_lipids, ldl_lipids) ~ comparison_model,
      TRUE ~ comparison_model
    ),
    comparison_model_formatted = factor(comparison_model_formatted, levels = rev(model_order_levels)),
    outcome = factor(
      outcome,
      levels = c("cad", "stroke", "hf", "af", "pad", "vte"),
      labels = c("CAD", "Stroke", "HF", "AF", "PAD", "VTE")
    )
  )

# =============================================================================
# 3. CREATE THE FOREST PLOT
# =============================================================================
print("--- Generating forest plot... ---")

baseline_lines <- plot_data %>% 
  filter(comparison_model_formatted %in% c("PANEL")) %>%
  select(outcome, model_group, point_estimate)

color_palette <- c(
  "Individual biomarker"     = "#8491B4CC",
  "PANEL-based"     = "#3C5488CC"
)

cindex_forest_plot <- ggplot(
  plot_data, 
  aes(x = point_estimate, y = comparison_model_formatted, color = model_group)
) +
  geom_vline(
    data = baseline_lines,
    aes(xintercept = point_estimate),
    color = "#D3D3D3", 
    linetype = "dashed", 
    linewidth = 0.75
  ) +
  geom_linerange(aes(xmin = ci_lower, xmax = ci_upper), linewidth = 1) +
  geom_point(size = 1, alpha = 1) + 
  facet_grid(model_group ~ outcome, scales = "free_y", space = "free_y") +
  coord_cartesian(xlim = c(0.49, 1.02)) +
  scale_x_continuous(breaks = c(0.5, 0.75, 1.0), labels = c("0.5", "0.75", "1.0")) +
  scale_color_manual(values = color_palette, name = NULL) + 
  labs(x = "C-index (95% CI)", y = NULL) +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = 0, angle = 0),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90),
    axis.ticks.y = element_blank(),
    panel.grid = element_blank(),
    legend.title = element_text(size = 12, hjust = 0.1),
    legend.text = element_text(size = 12),
    legend.position = "none",
    strip.background = element_blank(),
    strip.text.x = element_text(size = 12),
    strip.text.y = element_blank()
  )

legend <- ggplot(
  plot_data, 
  aes(x = point_estimate, y = reorder_within(comparison_model_formatted, desc(comparison_model_formatted), model_group), color = model_group)
) +
  geom_linerange(aes(xmin = ci_lower, xmax = ci_upper), linewidth = 1) +
  geom_point(size = 1, alpha = 1) + 
  facet_grid(model_group ~ outcome, scales = "free_y", space = "free_y") +
  scale_color_manual(values = color_palette, name = NULL) + 
  tidytext::scale_y_reordered() +
  theme_bw() +
  theme(
    legend.title = element_text(size = 12, hjust = 0.1),
    legend.text = element_text(size = 12),
    legend.position = "bottom"
  )

# =============================================================================
# 5. CLEAN UP ENVIRONMENT
# =============================================================================
rm(cindex_path, cindex_data_raw, plot_data, color_palette, total_lipids, ldl_lipids, all_total_lipids, sorted_total_lipids, all_ldl_lipids, sorted_ldl_lipids, model_order_levels, baseline_lines)

print("--- Script finished and environment cleaned. ---")

```

#### Delta C-index

```{r}

# =============================================================================
# 1. SETUP
# =============================================================================
cindex_path <- "saved/results/Cindex/Merge/cindex_LDL_biomarker_no_statins_final.csv"

# =============================================================================
# 2. LOAD AND PREPARE DATA (Data wrangling is the same as before)
# =============================================================================
print("--- Loading and preparing C-index data... ---")
cindex_data_raw <- read_csv(cindex_path, show_col_types = FALSE) %>% 
  filter(metric == "delta_c_index" & baseline_model == "PANEL" & comparison_model != "PANEL")

# --- Create model_order_levels ---
total_lipids <- c(
    "Total_C", "non_HDL_C", "Remnant_C", "Total_TG", "Total_PL", 
    "Total_CE", "Total_FC", "Total_L"
)

ldl_lipids <- c(
    "Clinical_LDL_C", "LDL_C", "LDL_TG", "LDL_PL", "LDL_CE", 
    "LDL_FC", "LDL_L", "LDL_P", "LDL_size"
)

all_total_lipids <- c(sort(total_lipids), paste0("*+", sort(total_lipids), "*"))
sorted_total_lipids <- tibble(model = all_total_lipids) %>%
  mutate(sort_key = str_remove_all(model, "[*+]")) %>%
  arrange(sort_key, model) %>%
  pull(model)

all_ldl_lipids <- c(sort(ldl_lipids), paste0("*+", sort(ldl_lipids), "*"))
sorted_ldl_lipids <- tibble(model = all_ldl_lipids) %>%
  mutate(sort_key = str_remove_all(model, "[*+]")) %>%
  arrange(sort_key, model) %>%
  pull(model)
model_order_levels <- c("PANEL", sorted_total_lipids, sorted_ldl_lipids)

outcomes_list <- c("cad", "stroke", "hf", "af", "pad", "vte")
placeholder_data <- expand_grid(
    outcome = outcomes_list, 
    baseline_model = "PANEL"
  ) %>%
  mutate(
    comparison_model = baseline_model, metric = "delta_c_index",
    point_estimate = NA, ci_lower = NA, ci_upper = NA
  )

plot_data <- cindex_data_raw %>%
  bind_rows(placeholder_data) %>%
  mutate(
    model_group = case_when(
      str_starts(comparison_model, "PANEL") ~ "PANEL-based",
      TRUE ~ "Individual biomarker"
    ),
    model_group = factor(model_group, levels = c("Individual biomarker", "PANEL-based")),
    comparison_model_formatted = case_when(
      str_starts(comparison_model, "PANEL_") ~ comparison_model %>%
        str_remove("PANEL_") %>%
        paste0("+", .) %>%
        paste0("*", ., "*"),
      comparison_model %in% c("PANEL", total_lipids, ldl_lipids) ~ comparison_model,
      TRUE ~ comparison_model
    ),
    comparison_model_formatted = factor(comparison_model_formatted, levels = rev(model_order_levels)),
    outcome = factor(
      outcome,
      levels = c("cad", "stroke", "hf", "af", "pad", "vte"),
      labels = c("CAD", "Stroke", "HF", "AF", "PAD", "VTE")
    )
  )
print(
  plot_data %>% 
    filter(comparison_model_formatted != "PANEL")  %>%
    mutate(estimate_ci = sprintf("%.3f (%.3f, %.3f)", point_estimate, ci_lower, ci_upper)) %>%
    select(estimate_ci, comparison_model_formatted, everything()) %>%
    arrange(outcome, desc(point_estimate))
  )

# =============================================================================
# 3. CREATE THE DELTA C-INDEX FOREST PLOT
# =============================================================================
print("--- Generating delta C-index forest plot... ---")

delta_plot_data <- plot_data %>%
  mutate(
    across(
      c(point_estimate, ci_lower, ci_upper),
      ~ if_else(comparison_model_formatted %in% c("PANEL"), NA_real_, .x)
    )
  )

baseline_text_data <- delta_plot_data %>%
  filter(comparison_model_formatted %in% c("PANEL"))

color_palette <- c(
  "Individual biomarker"     = "#8491B4CC",
  "PANEL-based"     = "#3C5488CC"
)

delta_cindex_plot <- ggplot(
  delta_plot_data, 
  aes(x = point_estimate, y = comparison_model_formatted, color = model_group)
) +
  geom_vline(
    xintercept = 0,
    color = "#D3D3D3", 
    linetype = "dashed", 
    linewidth = 0.75
  ) +
  geom_linerange(aes(xmin = ci_lower, xmax = ci_upper), linewidth = 1) +
  geom_point(size = 1, alpha = 1) + 
  geom_text(
    data = baseline_text_data,
    aes(x = 0, label = "Baseline"),
    nudge_x = 0.005,
    size = 3.5,
    color = "black",
    hjust = 0
  ) +
  facet_grid(~ outcome, scales = "free_y", space = "free_y") +
  coord_cartesian(xlim = c(-0.01, 0.04)) +
  scale_x_continuous(breaks = c(0, 0.015, 0.03), labels = c("0", "0.015", "0.03")) +
  scale_color_manual(values = color_palette, name = NULL) + 
  labs(x = "\u0394 C-index (95% CI)", y = NULL) +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_markdown(size = 12, hjust = 0.5, vjust = 1, family = "Arial"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90),
    axis.ticks.y = element_blank(),
    panel.grid = element_blank(),
    legend.title = element_text(size = 12, hjust = 0.1),
    legend.text = element_text(size = 12),
    legend.position = "none",
    strip.background = element_blank(),
    strip.text.x = element_text(size = 12),
    strip.text.y = element_blank()
  )

# =============================================================================
# 4. CLEAN UP ENVIRONMENT
# =============================================================================
rm(cindex_path, cindex_data_raw, outcomes_list, placeholder_data, plot_data, delta_plot_data, baseline_text_data, color_palette, total_lipids, ldl_lipids, all_total_lipids, sorted_total_lipids, all_ldl_lipids, sorted_ldl_lipids, model_order_levels)

print("--- Script finished and environment cleaned. ---")

```

#### Pool

```{r}

# =============================================================================
# 1. COMBINE PLOTS
# =============================================================================
height1 <- n_distinct(cindex_forest_plot$data$comparison_model_formatted)
height2 <- n_distinct(delta_cindex_plot$data$comparison_model_formatted)

proportional_heights <- c(height1, height2)

cindex_plot <- (cindex_forest_plot / delta_cindex_plot) + 
  plot_layout(heights = proportional_heights) +
  plot_annotation(tag_levels = "a") &
  theme(plot.tag = element_text(face = "bold"))

cindex_plot <- wrap_elements(cindex_plot) / ggpubr::get_legend(legend) +
  plot_layout(heights = c(0.95, 0.01))

# =============================================================================
# 2. SAVE AND CLEAN UP
# =============================================================================
print("--- Saving final plot in all formats... ---")

ggsave(str_c(getwd(), "/results/Figure/Performance_comparison_LDL_biomarker_no_statins.svg"), plot = cindex_plot, width = 14, height = 14, unit = "in", dpi = 300, device = "svg")

rm(height1, height2, proportional_heights, cindex_plot, legend, cindex_forest_plot, delta_cindex_plot)

```

## Machine learning models

### C-index forest plot

```{r}

# =============================================================================
# 1. SETUP
# =============================================================================
all_models_path <- "saved/results/Cindex/Merge/cindex_all_models_final.csv"
cindex_final_path <- "saved/results/Cindex/Merge/cindex_final.csv"

# =============================================================================
# 2. LOAD, MERGE, AND PREPARE DATA
# =============================================================================
print("--- Loading and preparing C-index data... ---")

cindex_all_models <- read_csv(all_models_path, show_col_types = FALSE) %>%
  filter(metric == "c_index")
cindex_omicsnet <- read_csv(cindex_final_path, show_col_types = FALSE) %>%
  filter((baseline_model == "PANEL" | comparison_model %in% c("Genomics", "Metabolomics", "Proteomics")) & metric == "c_index") %>%
  mutate(model = "omicsnet")

combined_data <- bind_rows(cindex_all_models, cindex_omicsnet)

model_order_levels <- c(
  "PANEL", 
  "*+PRS*", "*+MetScore*", "*+ProScore*", 
  "*+PRS +MetScore*", "*+PRS +ProScore*", "*+MetScore +ProScore*", 
  "*+PRS +MetScore +ProScore*",
  "PRS", "MetScore", "ProScore"
)

plot_data <- combined_data %>%
  mutate(
    model_group = case_when(
      str_starts(comparison_model, "PANEL") ~ "PANEL-based",
      comparison_model %in% c("Genomics", "Metabolomics", "Proteomics") ~ "Omics-based",
      TRUE ~ "Other"
    ),
    model_group = factor(model_group, levels = c("Omics-based", "PANEL-based")),
    model = factor(
      model,
      levels = c("glm", "rf", "lgbm", "xgb", "omicsnet"),
      labels = c("Logistic regression", "Random forest", "LightGBM", "XGBoost", "MetNet/ProNet")
    ),
    outcome = factor(
      outcome,
      levels = c("cad", "stroke", "hf", "af", "pad", "vte"),
      labels = c("CAD", "Stroke", "HF", "AF", "PAD", "VTE")
    ),
    comparison_model_formatted = case_when(
      comparison_model == "PANEL" ~ "PANEL",
      comparison_model == "Genomics" ~ "PRS",
      comparison_model == "Metabolomics" ~ "MetScore",
      comparison_model == "Proteomics" ~ "ProScore",
      TRUE ~ comparison_model %>%
        str_remove("^(PANEL)_") %>%
        str_replace_all(c("Genomics" = "PRS", "Metabolomics" = "MetScore", "Proteomics" = "ProScore")) %>%
        str_replace_all("_", " +") %>%
        paste0("+", .) %>%
        paste0("*", ., "*")
    ),
    comparison_model_formatted = factor(comparison_model_formatted, levels = rev(model_order_levels)),
    point_estimate = if_else(comparison_model == "PANEL", NA_real_, point_estimate),
    ci_lower = if_else(comparison_model == "PANEL", NA_real_, ci_lower),
    ci_upper = if_else(comparison_model == "PANEL", NA_real_, ci_upper)
  ) %>%
  filter(!comparison_model_formatted %in% c("*+PRS*", "PRS"))

# =============================================================================
# 3. CREATE THE FOREST PLOT
# =============================================================================
print("--- Generating forest plot... ---")

color_palette <- c(
  "MetNet/ProNet" = "#E64B35CC",
  "XGBoost" = "#4DBBD5CC",
  "LightGBM" = "#00A087CC",
  "Random forest" = "#3C5488CC",
  "Logistic regression" = "#F39B7FCC"
)

cindex_forest_plot <- ggplot(
  plot_data, 
  aes(x = point_estimate, y = comparison_model_formatted, color = model)
) +
  geom_linerange(
    aes(xmin = ci_lower, xmax = ci_upper), 
    linewidth = 1, position = position_dodge(width = 0.6)
  ) +
  geom_point(
    size = 1.5, alpha = 1, position = position_dodge(width = 0.6)
  ) +
  facet_grid(model_group ~ outcome, scales = "free_y", space = "free_y") +
  coord_cartesian(xlim = c(0.49, 1.02)) +
  scale_x_continuous(breaks = c(0.5, 0.75, 1.0), labels = c("0.5", "0.75", "1.0")) +
  scale_color_manual(values = color_palette) + 
  labs(x = "C-index (95% CI)", y = NULL, color = NULL) +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12),
    axis.ticks.y = element_blank(),
    panel.grid = element_blank(),
    legend.title = element_text(size = 12),
    legend.text = element_text(size = 12),
    legend.position = "none",
    strip.background = element_blank(),
    strip.text.x = element_text(size = 12),
    strip.text.y = element_blank()
  )

legend <- ggplot(
  plot_data, 
  aes(x = point_estimate, y = comparison_model_formatted, color = model)
) +
  geom_linerange(
    aes(xmin = ci_lower, xmax = ci_upper), 
    linewidth = 1, position = position_dodge(width = 0.6)
  ) +
  geom_point(
    size = 1.5, alpha = 1, position = position_dodge(width = 0.6)
  ) +
  facet_grid(model_group ~ outcome, scales = "free", space = "free_y") +
  scale_color_manual(values = color_palette) + 
  labs(x = "C-index (95% CI)", y = NULL, color = NULL) +
  theme_bw() +
  theme(
    legend.title = element_text(size = 12),
    legend.text = element_text(size = 12),
    legend.position = "bottom"
  )

# =============================================================================
# 4. CLEAN UP ENVIRONMENT
# =============================================================================
rm(all_models_path, cindex_final_path, cindex_all_models, cindex_omicsnet,
   combined_data, model_order_levels, plot_data, color_palette)

print("--- Script finished and environment cleaned. ---")

```

### Delta C-index

```{r}

# =============================================================================
# 1. SETUP
# =============================================================================
all_models_path <- "saved/results/Cindex/Merge/cindex_all_models_final.csv"
cindex_final_path <- "saved/results/Cindex/Merge/cindex_final.csv"

# =============================================================================
# 2. LOAD, MERGE, AND PREPARE DATA
# =============================================================================
print("--- Loading and preparing C-index data... ---")

cindex_all_models <- read_csv(all_models_path, show_col_types = FALSE) %>%
  filter(metric == "delta_c_index")
cindex_omicsnet <- read_csv(cindex_final_path, show_col_types = FALSE) %>%
  filter((baseline_model == "PANEL") & metric == "delta_c_index") %>%
  mutate(model = "omicsnet")
combined_data <- bind_rows(cindex_all_models, cindex_omicsnet)

model_order_levels <- c(
  "PANEL", 
  "*+PRS*", "*+MetScore*", "*+ProScore*", 
  "*+PRS +MetScore*", "*+PRS +ProScore*", "*+MetScore +ProScore*", 
  "*+PRS +MetScore +ProScore*",
  "PRS", "MetScore", "ProScore"
)

delta_plot_data <- combined_data %>%
  mutate(
    model = factor(
      model,
      levels = c("glm", "rf", "lgbm", "xgb", "omicsnet"),
      labels = c("Logistic regression", "Random forest", "LightGBM", "XGBoost", "MetNet/ProNet")
    ),
    outcome = factor(
      outcome,
      levels = c("cad", "stroke", "hf", "af", "pad", "vte"),
      labels = c("CAD", "Stroke", "HF", "AF", "PAD", "VTE")
    ),
    comparison_model_formatted = case_when(
      comparison_model == "PANEL" ~ "PANEL",
      comparison_model == "Genomics" ~ "PRS",
      comparison_model == "Metabolomics" ~ "MetScore",
      comparison_model == "Proteomics" ~ "ProScore",
      TRUE ~ comparison_model %>%
        str_remove("^(PANEL)_") %>%
        str_replace_all(c("Genomics" = "PRS", "Metabolomics" = "MetScore", "Proteomics" = "ProScore")) %>%
        str_replace_all("_", " +") %>%
        paste0("+", .) %>%
        paste0("*", ., "*")
    ),
    comparison_model_formatted = factor(comparison_model_formatted, levels = rev(model_order_levels)),
    point_estimate = if_else(comparison_model == "PANEL", NA_real_, point_estimate),
    ci_lower = if_else(comparison_model == "PANEL", NA_real_, ci_lower),
    ci_upper = if_else(comparison_model == "PANEL", NA_real_, ci_upper)
  ) %>%
  filter(!comparison_model_formatted %in% c("*+PRS*", "PRS", "MetScore", "ProScore"))

# =============================================================================
# 3. CREATE THE FOREST PLOT
# =============================================================================
print("--- Generating forest plot... ---")

baseline_text_data <- delta_plot_data %>%
  filter(model == "MetNet/ProNet" & comparison_model_formatted %in% c("PANEL"))

color_palette <- c(
  "MetNet/ProNet" = "#E64B35CC",
  "XGBoost" = "#4DBBD5CC",
  "LightGBM" = "#00A087CC",
  "Random forest" = "#3C5488CC",
  "Logistic regression" = "#F39B7FCC"
)

delta_cindex_plot <- ggplot(
  delta_plot_data, 
  aes(x = point_estimate, y = comparison_model_formatted, color = model)
) +
  geom_vline(
    xintercept = 0,
    color = "#D3D3D3", 
    linetype = "dashed", 
    linewidth = 0.75
  ) +
  geom_linerange(
    aes(xmin = ci_lower, xmax = ci_upper), 
    linewidth = 1, position = position_dodge(width = 0.6)
  ) +
  geom_point(
    size = 1.5, alpha = 1, position = position_dodge(width = 0.6)
  ) +
  geom_text(
    data = baseline_text_data,
    aes(x = 0, label = "Baseline"),
    nudge_x = 0.005,
    size = 3.5,
    color = "black",
    hjust = 0
  ) +
  facet_grid(~ outcome, scales = "free_y", space = "free_y") +
  coord_cartesian(xlim = c(-0.01, 0.07)) +
  scale_x_continuous(breaks = c(0, 0.03, 0.06), labels = c("0", "0.03", "0.06")) +
  scale_color_manual(values = color_palette, name = NULL) + 
  labs(x = "\u0394 C-index (95% CI)", y = NULL) +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12),
    axis.ticks.y = element_blank(),
    panel.grid = element_blank(),
    legend.title = element_text(size = 12),
    legend.text = element_text(size = 12),
    legend.position = "none",
    strip.background = element_blank(),
    strip.text.x = element_text(size = 12),
    strip.text.y = element_blank()
  )

# =============================================================================
# 4. CLEAN UP ENVIRONMENT
# =============================================================================
rm(all_models_path, cindex_final_path, cindex_all_models, cindex_omicsnet,
   combined_data, model_order_levels, delta_plot_data, baseline_text_data, color_palette)

print("--- Script finished and environment cleaned. ---")

```

### Pool

```{r}

# =============================================================================
# 1. COMBINE PLOTS
# =============================================================================
height1 <- n_distinct(cindex_forest_plot$data$comparison_model_formatted)
height2 <- n_distinct(delta_cindex_plot$data$comparison_model_formatted)

proportional_heights <- c(height1, height2)

cindex_plot <- (cindex_forest_plot / delta_cindex_plot) + 
  plot_layout(heights = proportional_heights) +
  plot_annotation(tag_levels = "a") &
  theme(plot.tag = element_text(face = "bold"))

cindex_plot <- wrap_elements(cindex_plot) / ggpubr::get_legend(legend) +
  plot_layout(heights = c(0.95, 0.05))

# =============================================================================
# 2. SAVE AND CLEAN UP
# =============================================================================
print("--- Saving final plot in all formats... ---")

ggsave(str_c(getwd(), "/results/Figure/Performance_comparison_other_models.svg"), plot = cindex_plot, width = 14, height = 16, unit = "in", dpi = 300, device = "svg")

rm(height1, height2, proportional_heights, cindex_forest_plot, delta_cindex_plot, legend, cindex_plot)

```

## Subgroup

### Age under 60

#### C-index forest plot

```{r}

# =============================================================================
# 1. SETUP
# =============================================================================
cindex_path <- "saved/results/Cindex/Merge/cindex_subgroup_final.csv"

# =============================================================================
# 2. LOAD AND PREPARE DATA
# =============================================================================
print("--- Loading and preparing C-index data... ---")

cindex_data_raw <- read_csv(cindex_path, show_col_types = FALSE) %>% 
  filter(metric == "c_index" & subgroup == "Age_under_60")

cindex_data_raw <- read_csv(cindex_path, show_col_types = FALSE) %>% 
  filter(metric == "c_index" & subgroup == "Age_under_60" & comparison_model %in% c("PANEL", "Genomics", "Metabolomics", "Proteomics", "PANEL_Genomics", 
    "PANEL_Metabolomics", "PANEL_Proteomics", "PANEL_Genomics_Metabolomics", 
    "PANEL_Genomics_Proteomics", "PANEL_Metabolomics_Proteomics", "PANEL_Genomics_Metabolomics_Proteomics"))

model_order_levels <- c(
  "PANEL", 
  "*+PRS*", "*+MetScore*", "*+ProScore*", 
  "*+PRS +MetScore*", "*+PRS +ProScore*", "*+MetScore +ProScore*", 
  "*+PRS +MetScore +ProScore*",
  "PRS", "MetScore", "ProScore"
)

plot_data <- cindex_data_raw %>%
  mutate(
    model_group = case_when(
      str_starts(comparison_model, "PANEL") ~ "PANEL-based",
      comparison_model %in% c("Genomics", "Metabolomics", "Proteomics") ~ "Omics-based",
      TRUE ~ "Other"
    ),
    model_group = factor(
      model_group,
      levels = c("Omics-based", "PANEL-based")
    ),
    comparison_model_formatted = case_when(
      comparison_model == "PANEL" ~ "PANEL",
      comparison_model == "Genomics" ~ "PRS",
      comparison_model == "Metabolomics" ~ "MetScore",
      comparison_model == "Proteomics" ~ "ProScore",
      TRUE ~ comparison_model %>%
        str_remove("^(PANEL)_") %>%
        str_replace_all(c("Genomics" = "PRS", "Metabolomics" = "MetScore", "Proteomics" = "ProScore")) %>%
        str_replace_all("_", " +") %>%
        paste0("+", .) %>%
        paste0("*", ., "*")
    ),
    comparison_model_formatted = factor(comparison_model_formatted, levels = rev(model_order_levels)),
    outcome = factor(
      outcome,
      levels = c("cad", "stroke", "hf", "af", "pad", "vte"),
      labels = c("CAD", "Stroke", "HF", "AF", "PAD", "VTE")
    )
  )

# =============================================================================
# 4. CREATE THE FOREST PLOT
# =============================================================================
print("--- Generating forest plot... ---")

baseline_lines <- plot_data %>% 
  filter(comparison_model_formatted %in% c("AgeSex", "Clin", "PANEL")) %>%
  select(outcome, model_group, point_estimate)

color_palette <- c(
  "Omics-based"     = "#E64B35CC",
  "PANEL-based"     = "#3C5488CC"
)

cindex_forest_plot <- ggplot(
  plot_data, 
  aes(x = point_estimate, y = comparison_model_formatted, color = model_group)
) +
  geom_vline(
    data = baseline_lines,
    aes(xintercept = point_estimate),
    color = "#D3D3D3", 
    linetype = "dashed", 
    linewidth = 0.75
  ) +
  geom_linerange(aes(xmin = ci_lower, xmax = ci_upper), linewidth = 1) +
  geom_point(size = 1, alpha = 1) + 
  facet_grid(model_group ~ outcome, scales = "free_y", space = "free_y") +
  coord_cartesian(xlim = c(0.49, 1.02)) +
  scale_x_continuous(breaks = c(0.5, 0.75, 1.0), labels = c("0.5", "0.75", "1.0")) +
  scale_color_manual(values = color_palette, name = NULL) + 
  labs(x = "C-index (95% CI)", y = NULL) +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = 0, angle = 0),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90),
    axis.ticks.y = element_blank(),
    panel.grid = element_blank(),
    legend.title = element_text(size = 12, hjust = 0.1),
    legend.text = element_text(size = 12),
    legend.position = "none",
    strip.background = element_blank(),
    strip.text.x = element_text(size = 12),
    strip.text.y = element_blank()
  )

legend <- ggplot(
  plot_data, 
  aes(x = point_estimate, y = reorder_within(comparison_model_formatted, desc(comparison_model_formatted), model_group), color = model_group)
) +
  geom_linerange(aes(xmin = ci_lower, xmax = ci_upper), linewidth = 1) +
  geom_point(size = 1, alpha = 1) + 
  facet_grid(model_group ~ outcome, scales = "free_y", space = "free_y") +
  scale_color_manual(values = color_palette, name = NULL) + 
  tidytext::scale_y_reordered() +
  theme_bw() +
  theme(
    legend.title = element_text(size = 12, hjust = 0.1),
    legend.text = element_text(size = 12),
    legend.position = "bottom"
  )

# =============================================================================
# 5. CLEAN UP ENVIRONMENT
# =============================================================================
rm(cindex_path, cindex_data_raw, plot_data, model_order_levels,
   baseline_lines, color_palette)

print("--- Script finished and environment cleaned. ---")

```

#### Delta C-index

```{r}

# =============================================================================
# 1. SETUP
# =============================================================================
cindex_path <- "saved/results/Cindex/Merge/cindex_subgroup_final.csv"

# =============================================================================
# 2. LOAD AND PREPARE DATA
# =============================================================================
print("--- Loading and preparing C-index data... ---")

cindex_data_raw <- read_csv(cindex_path, show_col_types = FALSE) %>% 
  filter(metric == "delta_c_index" & subgroup == "Age_under_60")

cindex_data_raw <- read_csv(cindex_path, show_col_types = FALSE) %>% 
  filter(metric == "delta_c_index" & subgroup == "Age_under_60" & comparison_model %in% c("PANEL", "PANEL_Genomics", 
    "PANEL_Metabolomics", "PANEL_Proteomics", "PANEL_Genomics_Metabolomics", 
    "PANEL_Genomics_Proteomics", "PANEL_Metabolomics_Proteomics", "PANEL_Genomics_Metabolomics_Proteomics"))


cindex_data_formatted <- cindex_data_raw %>%
  mutate(
    model_group = case_when(
      str_starts(comparison_model, "PANEL") ~ "PANEL-based",
      comparison_model %in% c("Genomics", "Metabolomics", "Proteomics") ~ "Omics-based",
      TRUE ~ "Other"
    ),
    comparison_model_formatted = case_when(
      comparison_model %in% c("PANEL", "Genomics", "Metabolomics", "Proteomics") ~ recode(comparison_model, "Genomics"="PRS", "Metabolomics"="MetScore", "Proteomics"="ProScore"),
      TRUE ~ comparison_model %>%
        str_remove("^(PANEL)_") %>%
        str_replace_all(c("Genomics" = "PRS", "Metabolomics" = "MetScore", "Proteomics" = "ProScore")) %>%
        str_replace_all("_", " +") %>%
        paste0("+", .) %>%
        paste0("*", ., "*")
    )
  )

model_order_levels <- c(
  "PANEL", "*+PRS*", "*+MetScore*", "*+ProScore*", 
  "*+PRS +MetScore*", "*+PRS +ProScore*", "*+MetScore +ProScore*", 
  "*+PRS +MetScore +ProScore*", "PRS", "MetScore", "ProScore"
)

plot_data <- cindex_data_formatted %>%
  mutate(
    outcome = factor(
      outcome,
      levels = c("cad", "stroke", "hf", "af", "pad", "vte"),
      labels = c("CAD", "Stroke", "HF", "AF", "PAD", "VTE")
    ),
    model_group = factor(
      model_group,
      levels = c("Omics-based", "PANEL-based")
    ),
    comparison_model_formatted = factor(comparison_model_formatted, levels = rev(model_order_levels))
  )

# =============================================================================
# 3. CREATE THE DELTA C-INDEX FOREST PLOT
# =============================================================================
print("--- Generating delta C-index forest plot... ---")

delta_plot_data <- plot_data %>%
  mutate(
    across(
      c(point_estimate, ci_lower, ci_upper),
      ~ if_else(comparison_model_formatted %in% c("PANEL"), NA_real_, .x)
    )
  )

baseline_text_data <- delta_plot_data %>%
  filter(comparison_model_formatted %in% c("PANEL"))

color_palette <- c(
  "PANEL-based"     = "#3C5488CC"
)

delta_cindex_plot <- ggplot(
  delta_plot_data, 
  aes(x = point_estimate, y = comparison_model_formatted, color = model_group)
) +
  geom_vline(
    xintercept = 0,
    color = "#D3D3D3", 
    linetype = "dashed", 
    linewidth = 0.75
  ) +
  geom_linerange(aes(xmin = ci_lower, xmax = ci_upper), linewidth = 1) +
  geom_point(size = 1, alpha = 1) + 
  geom_text(
    data = baseline_text_data,
    aes(x = 0, label = "Baseline"),
    nudge_x = 0.005,
    size = 3.5,
    color = "black",
    hjust = 0
  ) +
  facet_grid(model_group ~ outcome, scales = "free_y", space = "free_y") +
  coord_cartesian(xlim = c(-0.01, 0.126)) +
  scale_x_continuous(breaks = c(0, 0.04, 0.08, 0.12), labels = c("0", "0.04", "0.08", "0.12")) +
  scale_color_manual(values = color_palette, name = NULL) + 
  labs(x = "\u0394 C-index (95% CI)", y = NULL) +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_markdown(size = 12, hjust = 0.5, vjust = 1, family = "Arial"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90),
    axis.ticks.y = element_blank(),
    panel.grid = element_blank(),
    legend.title = element_text(size = 12, hjust = 0.1),
    legend.text = element_text(size = 12),
    legend.position = "none",
    strip.background = element_blank(),
    strip.text.x = element_text(size = 12),
    strip.text.y = element_blank()
  )

cindex_forest_age_under_60 <- (cindex_forest_plot / delta_cindex_plot) + 
  plot_layout(heights = c(11/19, 8/19))

n_samples_value <- plot_data$n_samples[1]
formatted_n <- format(n_samples_value, big.mark = ",")
new_title <- glue("**a** Aged less than 60 (*N* = {formatted_n})")

cindex_forest_age_under_60 <- wrap_elements(cindex_forest_age_under_60) + 
  plot_annotation(
    title = new_title,
    theme = theme(plot.title = element_markdown()) 
  )

# =============================================================================
# 4. CLEAN UP ENVIRONMENT
# =============================================================================
rm(cindex_path, cindex_data_raw, cindex_data_formatted,
   plot_data, model_order_levels, delta_plot_data, baseline_text_data,
   color_palette, cindex_forest_plot, delta_cindex_plot, 
   n_samples_value, formatted_n, new_title)

print("--- Script finished and environment cleaned. ---")

```



### Age over 60

#### C-index forest plot

```{r}

# =============================================================================
# 1. SETUP
# =============================================================================
cindex_path <- "saved/results/Cindex/Merge/cindex_subgroup_final.csv"

# =============================================================================
# 2. LOAD AND PREPARE DATA
# =============================================================================
print("--- Loading and preparing C-index data... ---")

cindex_data_raw <- read_csv(cindex_path, show_col_types = FALSE) %>% 
  filter(metric == "c_index" & subgroup == "Age_over_60")

cindex_data_raw <- read_csv(cindex_path, show_col_types = FALSE) %>% 
  filter(metric == "c_index" & subgroup == "Age_over_60" & comparison_model %in% c("PANEL", "Genomics", "Metabolomics", "Proteomics", "PANEL_Genomics", 
    "PANEL_Metabolomics", "PANEL_Proteomics", "PANEL_Genomics_Metabolomics", 
    "PANEL_Genomics_Proteomics", "PANEL_Metabolomics_Proteomics", "PANEL_Genomics_Metabolomics_Proteomics"))

model_order_levels <- c(
  "PANEL", 
  "*+PRS*", "*+MetScore*", "*+ProScore*", 
  "*+PRS +MetScore*", "*+PRS +ProScore*", "*+MetScore +ProScore*", 
  "*+PRS +MetScore +ProScore*",
  "PRS", "MetScore", "ProScore"
)

plot_data <- cindex_data_raw %>%
  mutate(
    model_group = case_when(
      str_starts(comparison_model, "PANEL") ~ "PANEL-based",
      comparison_model %in% c("Genomics", "Metabolomics", "Proteomics") ~ "Omics-based",
      TRUE ~ "Other"
    ),
    model_group = factor(
      model_group,
      levels = c("Omics-based", "PANEL-based")
    ),
    comparison_model_formatted = case_when(
      comparison_model == "PANEL" ~ "PANEL",
      comparison_model == "Genomics" ~ "PRS",
      comparison_model == "Metabolomics" ~ "MetScore",
      comparison_model == "Proteomics" ~ "ProScore",
      TRUE ~ comparison_model %>%
        str_remove("^(PANEL)_") %>%
        str_replace_all(c("Genomics" = "PRS", "Metabolomics" = "MetScore", "Proteomics" = "ProScore")) %>%
        str_replace_all("_", " +") %>%
        paste0("+", .) %>%
        paste0("*", ., "*")
    ),
    comparison_model_formatted = factor(comparison_model_formatted, levels = rev(model_order_levels)),
    outcome = factor(
      outcome,
      levels = c("cad", "stroke", "hf", "af", "pad", "vte"),
      labels = c("CAD", "Stroke", "HF", "AF", "PAD", "VTE")
    )
  )

# =============================================================================
# 4. CREATE THE FOREST PLOT
# =============================================================================
print("--- Generating forest plot... ---")

baseline_lines <- plot_data %>% 
  filter(comparison_model_formatted %in% c("AgeSex", "Clin", "PANEL")) %>%
  select(outcome, model_group, point_estimate)

color_palette <- c(
  "Omics-based"     = "#E64B35CC",
  "PANEL-based"     = "#3C5488CC"
)

cindex_forest_plot <- ggplot(
  plot_data, 
  aes(x = point_estimate, y = comparison_model_formatted, color = model_group)
) +
  geom_vline(
    data = baseline_lines,
    aes(xintercept = point_estimate),
    color = "#D3D3D3", 
    linetype = "dashed", 
    linewidth = 0.75
  ) +
  geom_linerange(aes(xmin = ci_lower, xmax = ci_upper), linewidth = 1) +
  geom_point(size = 1, alpha = 1) + 
  facet_grid(model_group ~ outcome, scales = "free_y", space = "free_y") +
  coord_cartesian(xlim = c(0.49, 1.02)) +
  scale_x_continuous(breaks = c(0.5, 0.75, 1.0), labels = c("0.5", "0.75", "1.0")) +
  scale_color_manual(values = color_palette, name = NULL) + 
  labs(x = "C-index (95% CI)", y = NULL) +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = 0, angle = 0),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90),
    axis.ticks.y = element_blank(),
    panel.grid = element_blank(),
    legend.title = element_text(size = 12, hjust = 0.1),
    legend.text = element_text(size = 12),
    legend.position = "none",
    strip.background = element_blank(),
    strip.text.x = element_text(size = 12),
    strip.text.y = element_blank()
  )

legend <- ggplot(
  plot_data, 
  aes(x = point_estimate, y = reorder_within(comparison_model_formatted, desc(comparison_model_formatted), model_group), color = model_group)
) +
  geom_linerange(aes(xmin = ci_lower, xmax = ci_upper), linewidth = 1) +
  geom_point(size = 1, alpha = 1) + 
  facet_grid(model_group ~ outcome, scales = "free_y", space = "free_y") +
  scale_color_manual(values = color_palette, name = NULL) + 
  tidytext::scale_y_reordered() +
  theme_bw() +
  theme(
    legend.title = element_text(size = 12, hjust = 0.1),
    legend.text = element_text(size = 12),
    legend.position = "bottom"
  )

# =============================================================================
# 5. CLEAN UP ENVIRONMENT
# =============================================================================
rm(cindex_path, cindex_data_raw, plot_data, model_order_levels,
   baseline_lines, color_palette)

print("--- Script finished and environment cleaned. ---")

```

#### Delta C-index

```{r}

# =============================================================================
# 1. SETUP
# =============================================================================
cindex_path <- "saved/results/Cindex/Merge/cindex_subgroup_final.csv"

# =============================================================================
# 2. LOAD AND PREPARE DATA
# =============================================================================
print("--- Loading and preparing C-index data... ---")

cindex_data_raw <- read_csv(cindex_path, show_col_types = FALSE) %>% 
  filter(metric == "delta_c_index" & subgroup == "Age_over_60")

cindex_data_raw <- read_csv(cindex_path, show_col_types = FALSE) %>% 
  filter(metric == "delta_c_index" & subgroup == "Age_over_60" & comparison_model %in% c("PANEL", "PANEL_Genomics", 
    "PANEL_Metabolomics", "PANEL_Proteomics", "PANEL_Genomics_Metabolomics", 
    "PANEL_Genomics_Proteomics", "PANEL_Metabolomics_Proteomics", "PANEL_Genomics_Metabolomics_Proteomics"))


cindex_data_formatted <- cindex_data_raw %>%
  mutate(
    model_group = case_when(
      str_starts(comparison_model, "PANEL") ~ "PANEL-based",
      comparison_model %in% c("Genomics", "Metabolomics", "Proteomics") ~ "Omics-based",
      TRUE ~ "Other"
    ),
    comparison_model_formatted = case_when(
      comparison_model %in% c("PANEL", "Genomics", "Metabolomics", "Proteomics") ~ recode(comparison_model, "Genomics"="PRS", "Metabolomics"="MetScore", "Proteomics"="ProScore"),
      TRUE ~ comparison_model %>%
        str_remove("^(PANEL)_") %>%
        str_replace_all(c("Genomics" = "PRS", "Metabolomics" = "MetScore", "Proteomics" = "ProScore")) %>%
        str_replace_all("_", " +") %>%
        paste0("+", .) %>%
        paste0("*", ., "*")
    )
  )

model_order_levels <- c(
  "PANEL", "*+PRS*", "*+MetScore*", "*+ProScore*", 
  "*+PRS +MetScore*", "*+PRS +ProScore*", "*+MetScore +ProScore*", 
  "*+PRS +MetScore +ProScore*", "PRS", "MetScore", "ProScore"
)

plot_data <- cindex_data_formatted %>%
  mutate(
    outcome = factor(
      outcome,
      levels = c("cad", "stroke", "hf", "af", "pad", "vte"),
      labels = c("CAD", "Stroke", "HF", "AF", "PAD", "VTE")
    ),
    model_group = factor(
      model_group,
      levels = c("Omics-based", "PANEL-based")
    ),
    comparison_model_formatted = factor(comparison_model_formatted, levels = rev(model_order_levels))
  )

# =============================================================================
# 3. CREATE THE DELTA C-INDEX FOREST PLOT
# =============================================================================
print("--- Generating delta C-index forest plot... ---")

delta_plot_data <- plot_data %>%
  mutate(
    across(
      c(point_estimate, ci_lower, ci_upper),
      ~ if_else(comparison_model_formatted %in% c("PANEL"), NA_real_, .x)
    )
  )

baseline_text_data <- delta_plot_data %>%
  filter(comparison_model_formatted %in% c("PANEL"))

color_palette <- c(
  "PANEL-based"     = "#3C5488CC"
)

delta_cindex_plot <- ggplot(
  delta_plot_data, 
  aes(x = point_estimate, y = comparison_model_formatted, color = model_group)
) +
  geom_vline(
    xintercept = 0,
    color = "#D3D3D3", 
    linetype = "dashed", 
    linewidth = 0.75
  ) +
  geom_linerange(aes(xmin = ci_lower, xmax = ci_upper), linewidth = 1) +
  geom_point(size = 1, alpha = 1) + 
  geom_text(
    data = baseline_text_data,
    aes(x = 0, label = "Baseline"),
    nudge_x = 0.005,
    size = 3.5,
    color = "black",
    hjust = 0
  ) +
  facet_grid(model_group ~ outcome, scales = "free_y", space = "free_y") +
  coord_cartesian(xlim = c(-0.01, 0.126)) +
  scale_x_continuous(breaks = c(0, 0.04, 0.08, 0.12), labels = c("0", "0.04", "0.08", "0.12")) +
  scale_color_manual(values = color_palette, name = NULL) + 
  labs(x = "\u0394 C-index (95% CI)", y = NULL) +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_markdown(size = 12, hjust = 0.5, vjust = 1, family = "Arial"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90),
    axis.ticks.y = element_blank(),
    panel.grid = element_blank(),
    legend.title = element_text(size = 12, hjust = 0.1),
    legend.text = element_text(size = 12),
    legend.position = "none",
    strip.background = element_blank(),
    strip.text.x = element_text(size = 12),
    strip.text.y = element_blank()
  )

cindex_forest_age_over_60 <- (cindex_forest_plot / delta_cindex_plot) + 
  plot_layout(heights = c(11/19, 8/19))

n_samples_value <- plot_data$n_samples[1]
formatted_n <- format(n_samples_value, big.mark = ",")
new_title <- glue("**b** Aged 60 and over (*N* = {formatted_n})")

cindex_forest_age_over_60 <- wrap_elements(cindex_forest_age_over_60) + 
  plot_annotation(
    title = new_title,
    theme = theme(plot.title = element_markdown()) 
  )

# =============================================================================
# 4. CLEAN UP ENVIRONMENT
# =============================================================================
rm(cindex_path, cindex_data_raw, cindex_data_formatted,
   plot_data, model_order_levels, delta_plot_data, baseline_text_data,
   color_palette, cindex_forest_plot, delta_cindex_plot, 
   n_samples_value, formatted_n, new_title)

print("--- Script finished and environment cleaned. ---")

```

### Male

#### C-index forest plot

```{r}

# =============================================================================
# 1. SETUP
# =============================================================================
cindex_path <- "saved/results/Cindex/Merge/cindex_subgroup_final.csv"

# =============================================================================
# 2. LOAD AND PREPARE DATA
# =============================================================================
print("--- Loading and preparing C-index data... ---")

cindex_data_raw <- read_csv(cindex_path, show_col_types = FALSE) %>% 
  filter(metric == "c_index" & subgroup == "Male")

cindex_data_raw <- read_csv(cindex_path, show_col_types = FALSE) %>% 
  filter(metric == "c_index" & subgroup == "Male" & comparison_model %in% c("PANEL", "Genomics", "Metabolomics", "Proteomics", "PANEL_Genomics", 
    "PANEL_Metabolomics", "PANEL_Proteomics", "PANEL_Genomics_Metabolomics", 
    "PANEL_Genomics_Proteomics", "PANEL_Metabolomics_Proteomics", "PANEL_Genomics_Metabolomics_Proteomics"))

model_order_levels <- c(
  "PANEL", 
  "*+PRS*", "*+MetScore*", "*+ProScore*", 
  "*+PRS +MetScore*", "*+PRS +ProScore*", "*+MetScore +ProScore*", 
  "*+PRS +MetScore +ProScore*",
  "PRS", "MetScore", "ProScore"
)

plot_data <- cindex_data_raw %>%
  mutate(
    model_group = case_when(
      str_starts(comparison_model, "PANEL") ~ "PANEL-based",
      comparison_model %in% c("Genomics", "Metabolomics", "Proteomics") ~ "Omics-based",
      TRUE ~ "Other"
    ),
    model_group = factor(
      model_group,
      levels = c("Omics-based", "PANEL-based")
    ),
    comparison_model_formatted = case_when(
      comparison_model == "PANEL" ~ "PANEL",
      comparison_model == "Genomics" ~ "PRS",
      comparison_model == "Metabolomics" ~ "MetScore",
      comparison_model == "Proteomics" ~ "ProScore",
      TRUE ~ comparison_model %>%
        str_remove("^(PANEL)_") %>%
        str_replace_all(c("Genomics" = "PRS", "Metabolomics" = "MetScore", "Proteomics" = "ProScore")) %>%
        str_replace_all("_", " +") %>%
        paste0("+", .) %>%
        paste0("*", ., "*")
    ),
    comparison_model_formatted = factor(comparison_model_formatted, levels = rev(model_order_levels)),
    outcome = factor(
      outcome,
      levels = c("cad", "stroke", "hf", "af", "pad", "vte"),
      labels = c("CAD", "Stroke", "HF", "AF", "PAD", "VTE")
    )
  )

# =============================================================================
# 4. CREATE THE FOREST PLOT
# =============================================================================
print("--- Generating forest plot... ---")

baseline_lines <- plot_data %>% 
  filter(comparison_model_formatted %in% c("AgeSex", "Clin", "PANEL")) %>%
  select(outcome, model_group, point_estimate)

color_palette <- c(
  "Omics-based"     = "#E64B35CC",
  "PANEL-based"     = "#3C5488CC"
)

cindex_forest_plot <- ggplot(
  plot_data, 
  aes(x = point_estimate, y = comparison_model_formatted, color = model_group)
) +
  geom_vline(
    data = baseline_lines,
    aes(xintercept = point_estimate),
    color = "#D3D3D3", 
    linetype = "dashed", 
    linewidth = 0.75
  ) +
  geom_linerange(aes(xmin = ci_lower, xmax = ci_upper), linewidth = 1) +
  geom_point(size = 1, alpha = 1) + 
  facet_grid(model_group ~ outcome, scales = "free_y", space = "free_y") +
  coord_cartesian(xlim = c(0.49, 1.02)) +
  scale_x_continuous(breaks = c(0.5, 0.75, 1.0), labels = c("0.5", "0.75", "1.0")) +
  scale_color_manual(values = color_palette, name = NULL) + 
  labs(x = "C-index (95% CI)", y = NULL) +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = 0, angle = 0),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90),
    axis.ticks.y = element_blank(),
    panel.grid = element_blank(),
    legend.title = element_text(size = 12, hjust = 0.1),
    legend.text = element_text(size = 12),
    legend.position = "none",
    strip.background = element_blank(),
    strip.text.x = element_text(size = 12),
    strip.text.y = element_blank()
  )

legend <- ggplot(
  plot_data, 
  aes(x = point_estimate, y = reorder_within(comparison_model_formatted, desc(comparison_model_formatted), model_group), color = model_group)
) +
  geom_linerange(aes(xmin = ci_lower, xmax = ci_upper), linewidth = 1) +
  geom_point(size = 1, alpha = 1) + 
  facet_grid(model_group ~ outcome, scales = "free_y", space = "free_y") +
  scale_color_manual(values = color_palette, name = NULL) + 
  tidytext::scale_y_reordered() +
  theme_bw() +
  theme(
    legend.title = element_text(size = 12, hjust = 0.1),
    legend.text = element_text(size = 12),
    legend.position = "bottom"
  )

# =============================================================================
# 5. CLEAN UP ENVIRONMENT
# =============================================================================
rm(cindex_path, cindex_data_raw, plot_data, model_order_levels,
   baseline_lines, color_palette)

print("--- Script finished and environment cleaned. ---")

```

#### Delta C-index

```{r}

# =============================================================================
# 1. SETUP
# =============================================================================
cindex_path <- "saved/results/Cindex/Merge/cindex_subgroup_final.csv"

# =============================================================================
# 2. LOAD AND PREPARE DATA
# =============================================================================
print("--- Loading and preparing C-index data... ---")

cindex_data_raw <- read_csv(cindex_path, show_col_types = FALSE) %>% 
  filter(metric == "delta_c_index" & subgroup == "Male")

cindex_data_raw <- read_csv(cindex_path, show_col_types = FALSE) %>% 
  filter(metric == "delta_c_index" & subgroup == "Male" & comparison_model %in% c("PANEL", "PANEL_Genomics", 
    "PANEL_Metabolomics", "PANEL_Proteomics", "PANEL_Genomics_Metabolomics", 
    "PANEL_Genomics_Proteomics", "PANEL_Metabolomics_Proteomics", "PANEL_Genomics_Metabolomics_Proteomics"))


cindex_data_formatted <- cindex_data_raw %>%
  mutate(
    model_group = case_when(
      str_starts(comparison_model, "PANEL") ~ "PANEL-based",
      comparison_model %in% c("Genomics", "Metabolomics", "Proteomics") ~ "Omics-based",
      TRUE ~ "Other"
    ),
    comparison_model_formatted = case_when(
      comparison_model %in% c("PANEL", "Genomics", "Metabolomics", "Proteomics") ~ recode(comparison_model, "Genomics"="PRS", "Metabolomics"="MetScore", "Proteomics"="ProScore"),
      TRUE ~ comparison_model %>%
        str_remove("^(PANEL)_") %>%
        str_replace_all(c("Genomics" = "PRS", "Metabolomics" = "MetScore", "Proteomics" = "ProScore")) %>%
        str_replace_all("_", " +") %>%
        paste0("+", .) %>%
        paste0("*", ., "*")
    )
  )

model_order_levels <- c(
  "PANEL", "*+PRS*", "*+MetScore*", "*+ProScore*", 
  "*+PRS +MetScore*", "*+PRS +ProScore*", "*+MetScore +ProScore*", 
  "*+PRS +MetScore +ProScore*", "PRS", "MetScore", "ProScore"
)

plot_data <- cindex_data_formatted %>%
  mutate(
    outcome = factor(
      outcome,
      levels = c("cad", "stroke", "hf", "af", "pad", "vte"),
      labels = c("CAD", "Stroke", "HF", "AF", "PAD", "VTE")
    ),
    model_group = factor(
      model_group,
      levels = c("Omics-based", "PANEL-based")
    ),
    comparison_model_formatted = factor(comparison_model_formatted, levels = rev(model_order_levels))
  )

# =============================================================================
# 3. CREATE THE DELTA C-INDEX FOREST PLOT
# =============================================================================
print("--- Generating delta C-index forest plot... ---")

delta_plot_data <- plot_data %>%
  mutate(
    across(
      c(point_estimate, ci_lower, ci_upper),
      ~ if_else(comparison_model_formatted %in% c("PANEL"), NA_real_, .x)
    )
  )

baseline_text_data <- delta_plot_data %>%
  filter(comparison_model_formatted %in% c("PANEL"))

color_palette <- c(
  "PANEL-based"     = "#3C5488CC"
)

delta_cindex_plot <- ggplot(
  delta_plot_data, 
  aes(x = point_estimate, y = comparison_model_formatted, color = model_group)
) +
  geom_vline(
    xintercept = 0,
    color = "#D3D3D3", 
    linetype = "dashed", 
    linewidth = 0.75
  ) +
  geom_linerange(aes(xmin = ci_lower, xmax = ci_upper), linewidth = 1) +
  geom_point(size = 1, alpha = 1) + 
  geom_text(
    data = baseline_text_data,
    aes(x = 0, label = "Baseline"),
    nudge_x = 0.005,
    size = 3.5,
    color = "black",
    hjust = 0
  ) +
  facet_grid(model_group ~ outcome, scales = "free_y", space = "free_y") +
  coord_cartesian(xlim = c(-0.01, 0.126)) +
  scale_x_continuous(breaks = c(0, 0.04, 0.08, 0.12), labels = c("0", "0.04", "0.08", "0.12")) +
  scale_color_manual(values = color_palette, name = NULL) + 
  labs(x = "\u0394 C-index (95% CI)", y = NULL) +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_markdown(size = 12, hjust = 0.5, vjust = 1, family = "Arial"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90),
    axis.ticks.y = element_blank(),
    panel.grid = element_blank(),
    legend.title = element_text(size = 12, hjust = 0.1),
    legend.text = element_text(size = 12),
    legend.position = "none",
    strip.background = element_blank(),
    strip.text.x = element_text(size = 12),
    strip.text.y = element_blank()
  )

cindex_forest_male <- (cindex_forest_plot / delta_cindex_plot) + 
  plot_layout(heights = c(11/19, 8/19))

n_samples_value <- plot_data$n_samples[1]
formatted_n <- format(n_samples_value, big.mark = ",")
new_title <- glue("**c** Male (*N* = {formatted_n})")

cindex_forest_male <- wrap_elements(cindex_forest_male) + 
  plot_annotation(
    title = new_title,
    theme = theme(plot.title = element_markdown()) 
  )

# =============================================================================
# 4. CLEAN UP ENVIRONMENT
# =============================================================================
rm(cindex_path, cindex_data_raw, cindex_data_formatted,
   plot_data, model_order_levels, delta_plot_data, baseline_text_data,
   color_palette, cindex_forest_plot, delta_cindex_plot, 
   n_samples_value, formatted_n, new_title)

print("--- Script finished and environment cleaned. ---")

```

### Female

#### C-index forest plot

```{r}

# =============================================================================
# 1. SETUP
# =============================================================================
cindex_path <- "saved/results/Cindex/Merge/cindex_subgroup_final.csv"

# =============================================================================
# 2. LOAD AND PREPARE DATA
# =============================================================================
print("--- Loading and preparing C-index data... ---")

cindex_data_raw <- read_csv(cindex_path, show_col_types = FALSE) %>% 
  filter(metric == "c_index" & subgroup == "Female")

cindex_data_raw <- read_csv(cindex_path, show_col_types = FALSE) %>% 
  filter(metric == "c_index" & subgroup == "Female" & comparison_model %in% c("PANEL", "Genomics", "Metabolomics", "Proteomics", "PANEL_Genomics", 
    "PANEL_Metabolomics", "PANEL_Proteomics", "PANEL_Genomics_Metabolomics", 
    "PANEL_Genomics_Proteomics", "PANEL_Metabolomics_Proteomics", "PANEL_Genomics_Metabolomics_Proteomics"))

model_order_levels <- c(
  "PANEL", 
  "*+PRS*", "*+MetScore*", "*+ProScore*", 
  "*+PRS +MetScore*", "*+PRS +ProScore*", "*+MetScore +ProScore*", 
  "*+PRS +MetScore +ProScore*",
  "PRS", "MetScore", "ProScore"
)

plot_data <- cindex_data_raw %>%
  mutate(
    model_group = case_when(
      str_starts(comparison_model, "PANEL") ~ "PANEL-based",
      comparison_model %in% c("Genomics", "Metabolomics", "Proteomics") ~ "Omics-based",
      TRUE ~ "Other"
    ),
    model_group = factor(
      model_group,
      levels = c("Omics-based", "PANEL-based")
    ),
    comparison_model_formatted = case_when(
      comparison_model == "PANEL" ~ "PANEL",
      comparison_model == "Genomics" ~ "PRS",
      comparison_model == "Metabolomics" ~ "MetScore",
      comparison_model == "Proteomics" ~ "ProScore",
      TRUE ~ comparison_model %>%
        str_remove("^(PANEL)_") %>%
        str_replace_all(c("Genomics" = "PRS", "Metabolomics" = "MetScore", "Proteomics" = "ProScore")) %>%
        str_replace_all("_", " +") %>%
        paste0("+", .) %>%
        paste0("*", ., "*")
    ),
    comparison_model_formatted = factor(comparison_model_formatted, levels = rev(model_order_levels)),
    outcome = factor(
      outcome,
      levels = c("cad", "stroke", "hf", "af", "pad", "vte"),
      labels = c("CAD", "Stroke", "HF", "AF", "PAD", "VTE")
    )
  )

# =============================================================================
# 4. CREATE THE FOREST PLOT
# =============================================================================
print("--- Generating forest plot... ---")

baseline_lines <- plot_data %>% 
  filter(comparison_model_formatted %in% c("AgeSex", "Clin", "PANEL")) %>%
  select(outcome, model_group, point_estimate)

color_palette <- c(
  "Omics-based"     = "#E64B35CC",
  "PANEL-based"     = "#3C5488CC"
)

cindex_forest_plot <- ggplot(
  plot_data, 
  aes(x = point_estimate, y = comparison_model_formatted, color = model_group)
) +
  geom_vline(
    data = baseline_lines,
    aes(xintercept = point_estimate),
    color = "#D3D3D3", 
    linetype = "dashed", 
    linewidth = 0.75
  ) +
  geom_linerange(aes(xmin = ci_lower, xmax = ci_upper), linewidth = 1) +
  geom_point(size = 1, alpha = 1) + 
  facet_grid(model_group ~ outcome, scales = "free_y", space = "free_y") +
  coord_cartesian(xlim = c(0.49, 1.02)) +
  scale_x_continuous(breaks = c(0.5, 0.75, 1.0), labels = c("0.5", "0.75", "1.0")) +
  scale_color_manual(values = color_palette, name = NULL) + 
  labs(x = "C-index (95% CI)", y = NULL) +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = 0, angle = 0),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90),
    axis.ticks.y = element_blank(),
    panel.grid = element_blank(),
    legend.title = element_text(size = 12, hjust = 0.1),
    legend.text = element_text(size = 12),
    legend.position = "none",
    strip.background = element_blank(),
    strip.text.x = element_text(size = 12),
    strip.text.y = element_blank()
  )

legend <- ggplot(
  plot_data, 
  aes(x = point_estimate, y = reorder_within(comparison_model_formatted, desc(comparison_model_formatted), model_group), color = model_group)
) +
  geom_linerange(aes(xmin = ci_lower, xmax = ci_upper), linewidth = 1) +
  geom_point(size = 1, alpha = 1) + 
  facet_grid(model_group ~ outcome, scales = "free_y", space = "free_y") +
  scale_color_manual(values = color_palette, name = NULL) + 
  tidytext::scale_y_reordered() +
  theme_bw() +
  theme(
    legend.title = element_text(size = 12, hjust = 0.1),
    legend.text = element_text(size = 12),
    legend.position = "bottom"
  )

# =============================================================================
# 5. CLEAN UP ENVIRONMENT
# =============================================================================
rm(cindex_path, cindex_data_raw, plot_data, model_order_levels,
   baseline_lines, color_palette)

print("--- Script finished and environment cleaned. ---")

```

#### Delta C-index

```{r}

# =============================================================================
# 1. SETUP
# =============================================================================
cindex_path <- "saved/results/Cindex/Merge/cindex_subgroup_final.csv"

# =============================================================================
# 2. LOAD AND PREPARE DATA
# =============================================================================
print("--- Loading and preparing C-index data... ---")

cindex_data_raw <- read_csv(cindex_path, show_col_types = FALSE) %>% 
  filter(metric == "delta_c_index" & subgroup == "Female")

cindex_data_raw <- read_csv(cindex_path, show_col_types = FALSE) %>% 
  filter(metric == "delta_c_index" & subgroup == "Female" & comparison_model %in% c("PANEL", "PANEL_Genomics", 
    "PANEL_Metabolomics", "PANEL_Proteomics", "PANEL_Genomics_Metabolomics", 
    "PANEL_Genomics_Proteomics", "PANEL_Metabolomics_Proteomics", "PANEL_Genomics_Metabolomics_Proteomics"))


cindex_data_formatted <- cindex_data_raw %>%
  mutate(
    model_group = case_when(
      str_starts(comparison_model, "PANEL") ~ "PANEL-based",
      comparison_model %in% c("Genomics", "Metabolomics", "Proteomics") ~ "Omics-based",
      TRUE ~ "Other"
    ),
    comparison_model_formatted = case_when(
      comparison_model %in% c("PANEL", "Genomics", "Metabolomics", "Proteomics") ~ recode(comparison_model, "Genomics"="PRS", "Metabolomics"="MetScore", "Proteomics"="ProScore"),
      TRUE ~ comparison_model %>%
        str_remove("^(PANEL)_") %>%
        str_replace_all(c("Genomics" = "PRS", "Metabolomics" = "MetScore", "Proteomics" = "ProScore")) %>%
        str_replace_all("_", " +") %>%
        paste0("+", .) %>%
        paste0("*", ., "*")
    )
  )

model_order_levels <- c(
  "PANEL", "*+PRS*", "*+MetScore*", "*+ProScore*", 
  "*+PRS +MetScore*", "*+PRS +ProScore*", "*+MetScore +ProScore*", 
  "*+PRS +MetScore +ProScore*", "PRS", "MetScore", "ProScore"
)

plot_data <- cindex_data_formatted %>%
  mutate(
    outcome = factor(
      outcome,
      levels = c("cad", "stroke", "hf", "af", "pad", "vte"),
      labels = c("CAD", "Stroke", "HF", "AF", "PAD", "VTE")
    ),
    model_group = factor(
      model_group,
      levels = c("Omics-based", "PANEL-based")
    ),
    comparison_model_formatted = factor(comparison_model_formatted, levels = rev(model_order_levels))
  )

# =============================================================================
# 3. CREATE THE DELTA C-INDEX FOREST PLOT
# =============================================================================
print("--- Generating delta C-index forest plot... ---")

delta_plot_data <- plot_data %>%
  mutate(
    across(
      c(point_estimate, ci_lower, ci_upper),
      ~ if_else(comparison_model_formatted %in% c("PANEL"), NA_real_, .x)
    )
  )

baseline_text_data <- delta_plot_data %>%
  filter(comparison_model_formatted %in% c("PANEL"))

color_palette <- c(
  "PANEL-based"     = "#3C5488CC"
)

delta_cindex_plot <- ggplot(
  delta_plot_data, 
  aes(x = point_estimate, y = comparison_model_formatted, color = model_group)
) +
  geom_vline(
    xintercept = 0,
    color = "#D3D3D3", 
    linetype = "dashed", 
    linewidth = 0.75
  ) +
  geom_linerange(aes(xmin = ci_lower, xmax = ci_upper), linewidth = 1) +
  geom_point(size = 1, alpha = 1) + 
  geom_text(
    data = baseline_text_data,
    aes(x = 0, label = "Baseline"),
    nudge_x = 0.005,
    size = 3.5,
    color = "black",
    hjust = 0
  ) +
  facet_grid(model_group ~ outcome, scales = "free_y", space = "free_y") +
  coord_cartesian(xlim = c(-0.01, 0.126)) +
  scale_x_continuous(breaks = c(0, 0.04, 0.08, 0.12), labels = c("0", "0.04", "0.08", "0.12")) +
  scale_color_manual(values = color_palette, name = NULL) + 
  labs(x = "\u0394 C-index (95% CI)", y = NULL) +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_markdown(size = 12, hjust = 0.5, vjust = 1, family = "Arial"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90),
    axis.ticks.y = element_blank(),
    panel.grid = element_blank(),
    legend.title = element_text(size = 12, hjust = 0.1),
    legend.text = element_text(size = 12),
    legend.position = "none",
    strip.background = element_blank(),
    strip.text.x = element_text(size = 12),
    strip.text.y = element_blank()
  )

cindex_forest_female <- (cindex_forest_plot / delta_cindex_plot) + 
  plot_layout(heights = c(11/19, 8/19))

n_samples_value <- plot_data$n_samples[1]
formatted_n <- format(n_samples_value, big.mark = ",")
new_title <- glue("**d** Female (*N* = {formatted_n})")

cindex_forest_female <- wrap_elements(cindex_forest_female) + 
  plot_annotation(
    title = new_title,
    theme = theme(plot.title = element_markdown()) 
  )

# =============================================================================
# 4. CLEAN UP ENVIRONMENT
# =============================================================================
rm(cindex_path, cindex_data_raw, cindex_data_formatted,
   plot_data, model_order_levels, delta_plot_data, baseline_text_data,
   color_palette, cindex_forest_plot, delta_cindex_plot, 
   n_samples_value, formatted_n, new_title)

print("--- Script finished and environment cleaned. ---")

```

### Lipid-lowering medication

#### C-index forest plot

```{r}

# =============================================================================
# 1. SETUP
# =============================================================================
cindex_path <- "saved/results/Cindex/Merge/cindex_subgroup_final.csv"

# =============================================================================
# 2. LOAD AND PREPARE DATA
# =============================================================================
print("--- Loading and preparing C-index data... ---")

cindex_data_raw <- read_csv(cindex_path, show_col_types = FALSE) %>% 
  filter(metric == "c_index" & subgroup == "Lipid_lowering_medication")

cindex_data_raw <- read_csv(cindex_path, show_col_types = FALSE) %>% 
  filter(metric == "c_index" & subgroup == "Lipid_lowering_medication" & comparison_model %in% c("PANEL", "Genomics", "Metabolomics", "Proteomics", "PANEL_Genomics", 
    "PANEL_Metabolomics", "PANEL_Proteomics", "PANEL_Genomics_Metabolomics", 
    "PANEL_Genomics_Proteomics", "PANEL_Metabolomics_Proteomics", "PANEL_Genomics_Metabolomics_Proteomics"))

model_order_levels <- c(
  "PANEL", 
  "*+PRS*", "*+MetScore*", "*+ProScore*", 
  "*+PRS +MetScore*", "*+PRS +ProScore*", "*+MetScore +ProScore*", 
  "*+PRS +MetScore +ProScore*",
  "PRS", "MetScore", "ProScore"
)

plot_data <- cindex_data_raw %>%
  mutate(
    model_group = case_when(
      str_starts(comparison_model, "PANEL") ~ "PANEL-based",
      comparison_model %in% c("Genomics", "Metabolomics", "Proteomics") ~ "Omics-based",
      TRUE ~ "Other"
    ),
    model_group = factor(
      model_group,
      levels = c("Omics-based", "PANEL-based")
    ),
    comparison_model_formatted = case_when(
      comparison_model == "PANEL" ~ "PANEL",
      comparison_model == "Genomics" ~ "PRS",
      comparison_model == "Metabolomics" ~ "MetScore",
      comparison_model == "Proteomics" ~ "ProScore",
      TRUE ~ comparison_model %>%
        str_remove("^(PANEL)_") %>%
        str_replace_all(c("Genomics" = "PRS", "Metabolomics" = "MetScore", "Proteomics" = "ProScore")) %>%
        str_replace_all("_", " +") %>%
        paste0("+", .) %>%
        paste0("*", ., "*")
    ),
    comparison_model_formatted = factor(comparison_model_formatted, levels = rev(model_order_levels)),
    outcome = factor(
      outcome,
      levels = c("cad", "stroke", "hf", "af", "pad", "vte"),
      labels = c("CAD", "Stroke", "HF", "AF", "PAD", "VTE")
    )
  )

# =============================================================================
# 4. CREATE THE FOREST PLOT
# =============================================================================
print("--- Generating forest plot... ---")

baseline_lines <- plot_data %>% 
  filter(comparison_model_formatted %in% c("AgeSex", "Clin", "PANEL")) %>%
  select(outcome, model_group, point_estimate)

color_palette <- c(
  "Omics-based"     = "#E64B35CC",
  "PANEL-based"     = "#3C5488CC"
)

cindex_forest_plot <- ggplot(
  plot_data, 
  aes(x = point_estimate, y = comparison_model_formatted, color = model_group)
) +
  geom_vline(
    data = baseline_lines,
    aes(xintercept = point_estimate),
    color = "#D3D3D3", 
    linetype = "dashed", 
    linewidth = 0.75
  ) +
  geom_linerange(aes(xmin = ci_lower, xmax = ci_upper), linewidth = 1) +
  geom_point(size = 1, alpha = 1) + 
  facet_grid(model_group ~ outcome, scales = "free_y", space = "free_y") +
  coord_cartesian(xlim = c(0.49, 1.02)) +
  scale_x_continuous(breaks = c(0.5, 0.75, 1.0), labels = c("0.5", "0.75", "1.0")) +
  scale_color_manual(values = color_palette, name = NULL) + 
  labs(x = "C-index (95% CI)", y = NULL) +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = 0, angle = 0),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90),
    axis.ticks.y = element_blank(),
    panel.grid = element_blank(),
    legend.title = element_text(size = 12, hjust = 0.1),
    legend.text = element_text(size = 12),
    legend.position = "none",
    strip.background = element_blank(),
    strip.text.x = element_text(size = 12),
    strip.text.y = element_blank()
  )

legend <- ggplot(
  plot_data, 
  aes(x = point_estimate, y = reorder_within(comparison_model_formatted, desc(comparison_model_formatted), model_group), color = model_group)
) +
  geom_linerange(aes(xmin = ci_lower, xmax = ci_upper), linewidth = 1) +
  geom_point(size = 1, alpha = 1) + 
  facet_grid(model_group ~ outcome, scales = "free_y", space = "free_y") +
  scale_color_manual(values = color_palette, name = NULL) + 
  tidytext::scale_y_reordered() +
  theme_bw() +
  theme(
    legend.title = element_text(size = 12, hjust = 0.1),
    legend.text = element_text(size = 12),
    legend.position = "bottom"
  )

# =============================================================================
# 5. CLEAN UP ENVIRONMENT
# =============================================================================
rm(cindex_path, cindex_data_raw, plot_data, model_order_levels,
   baseline_lines, color_palette)

print("--- Script finished and environment cleaned. ---")

```

#### Delta C-index

```{r}

# =============================================================================
# 1. SETUP
# =============================================================================
cindex_path <- "saved/results/Cindex/Merge/cindex_subgroup_final.csv"

# =============================================================================
# 2. LOAD AND PREPARE DATA
# =============================================================================
print("--- Loading and preparing C-index data... ---")

cindex_data_raw <- read_csv(cindex_path, show_col_types = FALSE) %>% 
  filter(metric == "delta_c_index" & subgroup == "Lipid_lowering_medication")

cindex_data_raw <- read_csv(cindex_path, show_col_types = FALSE) %>% 
  filter(metric == "delta_c_index" & subgroup == "Lipid_lowering_medication" & comparison_model %in% c("PANEL", "PANEL_Genomics", 
    "PANEL_Metabolomics", "PANEL_Proteomics", "PANEL_Genomics_Metabolomics", 
    "PANEL_Genomics_Proteomics", "PANEL_Metabolomics_Proteomics", "PANEL_Genomics_Metabolomics_Proteomics"))


cindex_data_formatted <- cindex_data_raw %>%
  mutate(
    model_group = case_when(
      str_starts(comparison_model, "PANEL") ~ "PANEL-based",
      comparison_model %in% c("Genomics", "Metabolomics", "Proteomics") ~ "Omics-based",
      TRUE ~ "Other"
    ),
    comparison_model_formatted = case_when(
      comparison_model %in% c("PANEL", "Genomics", "Metabolomics", "Proteomics") ~ recode(comparison_model, "Genomics"="PRS", "Metabolomics"="MetScore", "Proteomics"="ProScore"),
      TRUE ~ comparison_model %>%
        str_remove("^(PANEL)_") %>%
        str_replace_all(c("Genomics" = "PRS", "Metabolomics" = "MetScore", "Proteomics" = "ProScore")) %>%
        str_replace_all("_", " +") %>%
        paste0("+", .) %>%
        paste0("*", ., "*")
    )
  )

model_order_levels <- c(
  "PANEL", "*+PRS*", "*+MetScore*", "*+ProScore*", 
  "*+PRS +MetScore*", "*+PRS +ProScore*", "*+MetScore +ProScore*", 
  "*+PRS +MetScore +ProScore*", "PRS", "MetScore", "ProScore"
)

plot_data <- cindex_data_formatted %>%
  mutate(
    outcome = factor(
      outcome,
      levels = c("cad", "stroke", "hf", "af", "pad", "vte"),
      labels = c("CAD", "Stroke", "HF", "AF", "PAD", "VTE")
    ),
    model_group = factor(
      model_group,
      levels = c("Omics-based", "PANEL-based")
    ),
    comparison_model_formatted = factor(comparison_model_formatted, levels = rev(model_order_levels))
  )

# =============================================================================
# 3. CREATE THE DELTA C-INDEX FOREST PLOT
# =============================================================================
print("--- Generating delta C-index forest plot... ---")

delta_plot_data <- plot_data %>%
  mutate(
    across(
      c(point_estimate, ci_lower, ci_upper),
      ~ if_else(comparison_model_formatted %in% c("PANEL"), NA_real_, .x)
    )
  )

baseline_text_data <- delta_plot_data %>%
  filter(comparison_model_formatted %in% c("PANEL"))

color_palette <- c(
  "PANEL-based"     = "#3C5488CC"
)

delta_cindex_plot <- ggplot(
  delta_plot_data, 
  aes(x = point_estimate, y = comparison_model_formatted, color = model_group)
) +
  geom_vline(
    xintercept = 0,
    color = "#D3D3D3", 
    linetype = "dashed", 
    linewidth = 0.75
  ) +
  geom_linerange(aes(xmin = ci_lower, xmax = ci_upper), linewidth = 1) +
  geom_point(size = 1, alpha = 1) + 
  geom_text(
    data = baseline_text_data,
    aes(x = 0, label = "Baseline"),
    nudge_x = 0.005,
    size = 3.5,
    color = "black",
    hjust = 0
  ) +
  facet_grid(model_group ~ outcome, scales = "free_y", space = "free_y") +
  coord_cartesian(xlim = c(-0.01, 0.126)) +
  scale_x_continuous(breaks = c(0, 0.04, 0.08, 0.12), labels = c("0", "0.04", "0.08", "0.12")) +
  scale_color_manual(values = color_palette, name = NULL) + 
  labs(x = "\u0394 C-index (95% CI)", y = NULL) +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_markdown(size = 12, hjust = 0.5, vjust = 1, family = "Arial"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90),
    axis.ticks.y = element_blank(),
    panel.grid = element_blank(),
    legend.title = element_text(size = 12, hjust = 0.1),
    legend.text = element_text(size = 12),
    legend.position = "none",
    strip.background = element_blank(),
    strip.text.x = element_text(size = 12),
    strip.text.y = element_blank()
  )

cindex_forest_lipid_med <- (cindex_forest_plot / delta_cindex_plot) + 
  plot_layout(heights = c(11/19, 8/19))

n_samples_value <- plot_data$n_samples[1]
formatted_n <- format(n_samples_value, big.mark = ",")
new_title <- glue("**a** Lipid-lowering medication (*N* = {formatted_n})")

cindex_forest_lipid_med <- wrap_elements(cindex_forest_lipid_med) + 
  plot_annotation(
    title = new_title,
    theme = theme(plot.title = element_markdown()) 
  )

# =============================================================================
# 4. CLEAN UP ENVIRONMENT
# =============================================================================
rm(cindex_path, cindex_data_raw, cindex_data_formatted,
   plot_data, model_order_levels, delta_plot_data, baseline_text_data,
   color_palette, cindex_forest_plot, delta_cindex_plot, 
   n_samples_value, formatted_n, new_title)

print("--- Script finished and environment cleaned. ---")

```

### No lipid-lowering medication

#### C-index forest plot

```{r}

# =============================================================================
# 1. SETUP
# =============================================================================
cindex_path <- "saved/results/Cindex/Merge/cindex_subgroup_final.csv"

# =============================================================================
# 2. LOAD AND PREPARE DATA
# =============================================================================
print("--- Loading and preparing C-index data... ---")

cindex_data_raw <- read_csv(cindex_path, show_col_types = FALSE) %>% 
  filter(metric == "c_index" & subgroup == "No_lipid_lowering_medication")

cindex_data_raw <- read_csv(cindex_path, show_col_types = FALSE) %>% 
  filter(metric == "c_index" & subgroup == "No_lipid_lowering_medication" & comparison_model %in% c("PANEL", "Genomics", "Metabolomics", "Proteomics", "PANEL_Genomics", 
    "PANEL_Metabolomics", "PANEL_Proteomics", "PANEL_Genomics_Metabolomics", 
    "PANEL_Genomics_Proteomics", "PANEL_Metabolomics_Proteomics", "PANEL_Genomics_Metabolomics_Proteomics"))

model_order_levels <- c(
  "PANEL", 
  "*+PRS*", "*+MetScore*", "*+ProScore*", 
  "*+PRS +MetScore*", "*+PRS +ProScore*", "*+MetScore +ProScore*", 
  "*+PRS +MetScore +ProScore*",
  "PRS", "MetScore", "ProScore"
)

plot_data <- cindex_data_raw %>%
  mutate(
    model_group = case_when(
      str_starts(comparison_model, "PANEL") ~ "PANEL-based",
      comparison_model %in% c("Genomics", "Metabolomics", "Proteomics") ~ "Omics-based",
      TRUE ~ "Other"
    ),
    model_group = factor(
      model_group,
      levels = c("Omics-based", "PANEL-based")
    ),
    comparison_model_formatted = case_when(
      comparison_model == "PANEL" ~ "PANEL",
      comparison_model == "Genomics" ~ "PRS",
      comparison_model == "Metabolomics" ~ "MetScore",
      comparison_model == "Proteomics" ~ "ProScore",
      TRUE ~ comparison_model %>%
        str_remove("^(PANEL)_") %>%
        str_replace_all(c("Genomics" = "PRS", "Metabolomics" = "MetScore", "Proteomics" = "ProScore")) %>%
        str_replace_all("_", " +") %>%
        paste0("+", .) %>%
        paste0("*", ., "*")
    ),
    comparison_model_formatted = factor(comparison_model_formatted, levels = rev(model_order_levels)),
    outcome = factor(
      outcome,
      levels = c("cad", "stroke", "hf", "af", "pad", "vte"),
      labels = c("CAD", "Stroke", "HF", "AF", "PAD", "VTE")
    )
  )

# =============================================================================
# 4. CREATE THE FOREST PLOT
# =============================================================================
print("--- Generating forest plot... ---")

baseline_lines <- plot_data %>% 
  filter(comparison_model_formatted %in% c("AgeSex", "Clin", "PANEL")) %>%
  select(outcome, model_group, point_estimate)

color_palette <- c(
  "Omics-based"     = "#E64B35CC",
  "PANEL-based"     = "#3C5488CC"
)

cindex_forest_plot <- ggplot(
  plot_data, 
  aes(x = point_estimate, y = comparison_model_formatted, color = model_group)
) +
  geom_vline(
    data = baseline_lines,
    aes(xintercept = point_estimate),
    color = "#D3D3D3", 
    linetype = "dashed", 
    linewidth = 0.75
  ) +
  geom_linerange(aes(xmin = ci_lower, xmax = ci_upper), linewidth = 1) +
  geom_point(size = 1, alpha = 1) + 
  facet_grid(model_group ~ outcome, scales = "free_y", space = "free_y") +
  coord_cartesian(xlim = c(0.49, 1.02)) +
  scale_x_continuous(breaks = c(0.5, 0.75, 1.0), labels = c("0.5", "0.75", "1.0")) +
  scale_color_manual(values = color_palette, name = NULL) + 
  labs(x = "C-index (95% CI)", y = NULL) +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = 0, angle = 0),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90),
    axis.ticks.y = element_blank(),
    panel.grid = element_blank(),
    legend.title = element_text(size = 12, hjust = 0.1),
    legend.text = element_text(size = 12),
    legend.position = "none",
    strip.background = element_blank(),
    strip.text.x = element_text(size = 12),
    strip.text.y = element_blank()
  )

legend <- ggplot(
  plot_data, 
  aes(x = point_estimate, y = reorder_within(comparison_model_formatted, desc(comparison_model_formatted), model_group), color = model_group)
) +
  geom_linerange(aes(xmin = ci_lower, xmax = ci_upper), linewidth = 1) +
  geom_point(size = 1, alpha = 1) + 
  facet_grid(model_group ~ outcome, scales = "free_y", space = "free_y") +
  scale_color_manual(values = color_palette, name = NULL) + 
  tidytext::scale_y_reordered() +
  theme_bw() +
  theme(
    legend.title = element_text(size = 12, hjust = 0.1),
    legend.text = element_text(size = 12),
    legend.position = "bottom"
  )

# =============================================================================
# 5. CLEAN UP ENVIRONMENT
# =============================================================================
rm(cindex_path, cindex_data_raw, plot_data, model_order_levels,
   baseline_lines, color_palette)

print("--- Script finished and environment cleaned. ---")

```

#### Delta C-index

```{r}

# =============================================================================
# 1. SETUP
# =============================================================================
cindex_path <- "saved/results/Cindex/Merge/cindex_subgroup_final.csv"

# =============================================================================
# 2. LOAD AND PREPARE DATA
# =============================================================================
print("--- Loading and preparing C-index data... ---")

cindex_data_raw <- read_csv(cindex_path, show_col_types = FALSE) %>% 
  filter(metric == "delta_c_index" & subgroup == "No_lipid_lowering_medication")

cindex_data_raw <- read_csv(cindex_path, show_col_types = FALSE) %>% 
  filter(metric == "delta_c_index" & subgroup == "No_lipid_lowering_medication" & comparison_model %in% c("PANEL", "PANEL_Genomics", 
    "PANEL_Metabolomics", "PANEL_Proteomics", "PANEL_Genomics_Metabolomics", 
    "PANEL_Genomics_Proteomics", "PANEL_Metabolomics_Proteomics", "PANEL_Genomics_Metabolomics_Proteomics"))


cindex_data_formatted <- cindex_data_raw %>%
  mutate(
    model_group = case_when(
      str_starts(comparison_model, "PANEL") ~ "PANEL-based",
      comparison_model %in% c("Genomics", "Metabolomics", "Proteomics") ~ "Omics-based",
      TRUE ~ "Other"
    ),
    comparison_model_formatted = case_when(
      comparison_model %in% c("PANEL", "Genomics", "Metabolomics", "Proteomics") ~ recode(comparison_model, "Genomics"="PRS", "Metabolomics"="MetScore", "Proteomics"="ProScore"),
      TRUE ~ comparison_model %>%
        str_remove("^(PANEL)_") %>%
        str_replace_all(c("Genomics" = "PRS", "Metabolomics" = "MetScore", "Proteomics" = "ProScore")) %>%
        str_replace_all("_", " +") %>%
        paste0("+", .) %>%
        paste0("*", ., "*")
    )
  )

model_order_levels <- c(
  "PANEL", "*+PRS*", "*+MetScore*", "*+ProScore*", 
  "*+PRS +MetScore*", "*+PRS +ProScore*", "*+MetScore +ProScore*", 
  "*+PRS +MetScore +ProScore*", "PRS", "MetScore", "ProScore"
)

plot_data <- cindex_data_formatted %>%
  mutate(
    outcome = factor(
      outcome,
      levels = c("cad", "stroke", "hf", "af", "pad", "vte"),
      labels = c("CAD", "Stroke", "HF", "AF", "PAD", "VTE")
    ),
    model_group = factor(
      model_group,
      levels = c("Omics-based", "PANEL-based")
    ),
    comparison_model_formatted = factor(comparison_model_formatted, levels = rev(model_order_levels))
  )

# =============================================================================
# 3. CREATE THE DELTA C-INDEX FOREST PLOT
# =============================================================================
print("--- Generating delta C-index forest plot... ---")

delta_plot_data <- plot_data %>%
  mutate(
    across(
      c(point_estimate, ci_lower, ci_upper),
      ~ if_else(comparison_model_formatted %in% c("PANEL"), NA_real_, .x)
    )
  )

baseline_text_data <- delta_plot_data %>%
  filter(comparison_model_formatted %in% c("PANEL"))

color_palette <- c(
  "PANEL-based"     = "#3C5488CC"
)

delta_cindex_plot <- ggplot(
  delta_plot_data, 
  aes(x = point_estimate, y = comparison_model_formatted, color = model_group)
) +
  geom_vline(
    xintercept = 0,
    color = "#D3D3D3", 
    linetype = "dashed", 
    linewidth = 0.75
  ) +
  geom_linerange(aes(xmin = ci_lower, xmax = ci_upper), linewidth = 1) +
  geom_point(size = 1, alpha = 1) + 
  geom_text(
    data = baseline_text_data,
    aes(x = 0, label = "Baseline"),
    nudge_x = 0.005,
    size = 3.5,
    color = "black",
    hjust = 0
  ) +
  facet_grid(model_group ~ outcome, scales = "free_y", space = "free_y") +
  coord_cartesian(xlim = c(-0.01, 0.126)) +
  scale_x_continuous(breaks = c(0, 0.04, 0.08, 0.12), labels = c("0", "0.04", "0.08", "0.12")) +
  scale_color_manual(values = color_palette, name = NULL) + 
  labs(x = "\u0394 C-index (95% CI)", y = NULL) +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_markdown(size = 12, hjust = 0.5, vjust = 1, family = "Arial"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90),
    axis.ticks.y = element_blank(),
    panel.grid = element_blank(),
    legend.title = element_text(size = 12, hjust = 0.1),
    legend.text = element_text(size = 12),
    legend.position = "none",
    strip.background = element_blank(),
    strip.text.x = element_text(size = 12),
    strip.text.y = element_blank()
  )

cindex_forest_no_lipid_med <- (cindex_forest_plot / delta_cindex_plot) + 
  plot_layout(heights = c(11/19, 8/19))

n_samples_value <- plot_data$n_samples[1]
formatted_n <- format(n_samples_value, big.mark = ",")
new_title <- glue("**b** No lipid-lowering medication (*N* = {formatted_n})")

cindex_forest_no_lipid_med <- wrap_elements(cindex_forest_no_lipid_med) + 
  plot_annotation(
    title = new_title,
    theme = theme(plot.title = element_markdown()) 
  )

# =============================================================================
# 4. CLEAN UP ENVIRONMENT
# =============================================================================
rm(cindex_path, cindex_data_raw, cindex_data_formatted,
   plot_data, model_order_levels, delta_plot_data, baseline_text_data,
   color_palette, cindex_forest_plot, delta_cindex_plot, 
   n_samples_value, formatted_n, new_title)

print("--- Script finished and environment cleaned. ---")

```

### Antihypertensive medication

#### C-index forest plot

```{r}

# =============================================================================
# 1. SETUP
# =============================================================================
cindex_path <- "saved/results/Cindex/Merge/cindex_subgroup_final.csv"

# =============================================================================
# 2. LOAD AND PREPARE DATA
# =============================================================================
print("--- Loading and preparing C-index data... ---")

cindex_data_raw <- read_csv(cindex_path, show_col_types = FALSE) %>% 
  filter(metric == "c_index" & subgroup == "Antihypertensive_medication")

cindex_data_raw <- read_csv(cindex_path, show_col_types = FALSE) %>% 
  filter(metric == "c_index" & subgroup == "Antihypertensive_medication" & comparison_model %in% c("PANEL", "Genomics", "Metabolomics", "Proteomics", "PANEL_Genomics", 
    "PANEL_Metabolomics", "PANEL_Proteomics", "PANEL_Genomics_Metabolomics", 
    "PANEL_Genomics_Proteomics", "PANEL_Metabolomics_Proteomics", "PANEL_Genomics_Metabolomics_Proteomics"))

model_order_levels <- c(
  "PANEL", 
  "*+PRS*", "*+MetScore*", "*+ProScore*", 
  "*+PRS +MetScore*", "*+PRS +ProScore*", "*+MetScore +ProScore*", 
  "*+PRS +MetScore +ProScore*",
  "PRS", "MetScore", "ProScore"
)

plot_data <- cindex_data_raw %>%
  mutate(
    model_group = case_when(
      str_starts(comparison_model, "PANEL") ~ "PANEL-based",
      comparison_model %in% c("Genomics", "Metabolomics", "Proteomics") ~ "Omics-based",
      TRUE ~ "Other"
    ),
    model_group = factor(
      model_group,
      levels = c("Omics-based", "PANEL-based")
    ),
    comparison_model_formatted = case_when(
      comparison_model == "PANEL" ~ "PANEL",
      comparison_model == "Genomics" ~ "PRS",
      comparison_model == "Metabolomics" ~ "MetScore",
      comparison_model == "Proteomics" ~ "ProScore",
      TRUE ~ comparison_model %>%
        str_remove("^(PANEL)_") %>%
        str_replace_all(c("Genomics" = "PRS", "Metabolomics" = "MetScore", "Proteomics" = "ProScore")) %>%
        str_replace_all("_", " +") %>%
        paste0("+", .) %>%
        paste0("*", ., "*")
    ),
    comparison_model_formatted = factor(comparison_model_formatted, levels = rev(model_order_levels)),
    outcome = factor(
      outcome,
      levels = c("cad", "stroke", "hf", "af", "pad", "vte"),
      labels = c("CAD", "Stroke", "HF", "AF", "PAD", "VTE")
    )
  )

# =============================================================================
# 4. CREATE THE FOREST PLOT
# =============================================================================
print("--- Generating forest plot... ---")

baseline_lines <- plot_data %>% 
  filter(comparison_model_formatted %in% c("AgeSex", "Clin", "PANEL")) %>%
  select(outcome, model_group, point_estimate)

color_palette <- c(
  "Omics-based"     = "#E64B35CC",
  "PANEL-based"     = "#3C5488CC"
)

cindex_forest_plot <- ggplot(
  plot_data, 
  aes(x = point_estimate, y = comparison_model_formatted, color = model_group)
) +
  geom_vline(
    data = baseline_lines,
    aes(xintercept = point_estimate),
    color = "#D3D3D3", 
    linetype = "dashed", 
    linewidth = 0.75
  ) +
  geom_linerange(aes(xmin = ci_lower, xmax = ci_upper), linewidth = 1) +
  geom_point(size = 1, alpha = 1) + 
  facet_grid(model_group ~ outcome, scales = "free_y", space = "free_y") +
  coord_cartesian(xlim = c(0.49, 1.02)) +
  scale_x_continuous(breaks = c(0.5, 0.75, 1.0), labels = c("0.5", "0.75", "1.0")) +
  scale_color_manual(values = color_palette, name = NULL) + 
  labs(x = "C-index (95% CI)", y = NULL) +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = 0, angle = 0),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90),
    axis.ticks.y = element_blank(),
    panel.grid = element_blank(),
    legend.title = element_text(size = 12, hjust = 0.1),
    legend.text = element_text(size = 12),
    legend.position = "none",
    strip.background = element_blank(),
    strip.text.x = element_text(size = 12),
    strip.text.y = element_blank()
  )

legend <- ggplot(
  plot_data, 
  aes(x = point_estimate, y = reorder_within(comparison_model_formatted, desc(comparison_model_formatted), model_group), color = model_group)
) +
  geom_linerange(aes(xmin = ci_lower, xmax = ci_upper), linewidth = 1) +
  geom_point(size = 1, alpha = 1) + 
  facet_grid(model_group ~ outcome, scales = "free_y", space = "free_y") +
  scale_color_manual(values = color_palette, name = NULL) + 
  tidytext::scale_y_reordered() +
  theme_bw() +
  theme(
    legend.title = element_text(size = 12, hjust = 0.1),
    legend.text = element_text(size = 12),
    legend.position = "bottom"
  )

# =============================================================================
# 5. CLEAN UP ENVIRONMENT
# =============================================================================
rm(cindex_path, cindex_data_raw, plot_data, model_order_levels,
   baseline_lines, color_palette)

print("--- Script finished and environment cleaned. ---")

```

#### Delta C-index

```{r}

# =============================================================================
# 1. SETUP
# =============================================================================
cindex_path <- "saved/results/Cindex/Merge/cindex_subgroup_final.csv"

# =============================================================================
# 2. LOAD AND PREPARE DATA
# =============================================================================
print("--- Loading and preparing C-index data... ---")

cindex_data_raw <- read_csv(cindex_path, show_col_types = FALSE) %>% 
  filter(metric == "delta_c_index" & subgroup == "Antihypertensive_medication")

cindex_data_raw <- read_csv(cindex_path, show_col_types = FALSE) %>% 
  filter(metric == "delta_c_index" & subgroup == "Antihypertensive_medication" & comparison_model %in% c("PANEL", "PANEL_Genomics", 
    "PANEL_Metabolomics", "PANEL_Proteomics", "PANEL_Genomics_Metabolomics", 
    "PANEL_Genomics_Proteomics", "PANEL_Metabolomics_Proteomics", "PANEL_Genomics_Metabolomics_Proteomics"))


cindex_data_formatted <- cindex_data_raw %>%
  mutate(
    model_group = case_when(
      str_starts(comparison_model, "PANEL") ~ "PANEL-based",
      comparison_model %in% c("Genomics", "Metabolomics", "Proteomics") ~ "Omics-based",
      TRUE ~ "Other"
    ),
    comparison_model_formatted = case_when(
      comparison_model %in% c("PANEL", "Genomics", "Metabolomics", "Proteomics") ~ recode(comparison_model, "Genomics"="PRS", "Metabolomics"="MetScore", "Proteomics"="ProScore"),
      TRUE ~ comparison_model %>%
        str_remove("^(PANEL)_") %>%
        str_replace_all(c("Genomics" = "PRS", "Metabolomics" = "MetScore", "Proteomics" = "ProScore")) %>%
        str_replace_all("_", " +") %>%
        paste0("+", .) %>%
        paste0("*", ., "*")
    )
  )

model_order_levels <- c(
  "PANEL", "*+PRS*", "*+MetScore*", "*+ProScore*", 
  "*+PRS +MetScore*", "*+PRS +ProScore*", "*+MetScore +ProScore*", 
  "*+PRS +MetScore +ProScore*", "PRS", "MetScore", "ProScore"
)

plot_data <- cindex_data_formatted %>%
  mutate(
    outcome = factor(
      outcome,
      levels = c("cad", "stroke", "hf", "af", "pad", "vte"),
      labels = c("CAD", "Stroke", "HF", "AF", "PAD", "VTE")
    ),
    model_group = factor(
      model_group,
      levels = c("Omics-based", "PANEL-based")
    ),
    comparison_model_formatted = factor(comparison_model_formatted, levels = rev(model_order_levels))
  )

# =============================================================================
# 3. CREATE THE DELTA C-INDEX FOREST PLOT
# =============================================================================
print("--- Generating delta C-index forest plot... ---")

delta_plot_data <- plot_data %>%
  mutate(
    across(
      c(point_estimate, ci_lower, ci_upper),
      ~ if_else(comparison_model_formatted %in% c("PANEL"), NA_real_, .x)
    )
  )

baseline_text_data <- delta_plot_data %>%
  filter(comparison_model_formatted %in% c("PANEL"))

color_palette <- c(
  "PANEL-based"     = "#3C5488CC"
)

delta_cindex_plot <- ggplot(
  delta_plot_data, 
  aes(x = point_estimate, y = comparison_model_formatted, color = model_group)
) +
  geom_vline(
    xintercept = 0,
    color = "#D3D3D3", 
    linetype = "dashed", 
    linewidth = 0.75
  ) +
  geom_linerange(aes(xmin = ci_lower, xmax = ci_upper), linewidth = 1) +
  geom_point(size = 1, alpha = 1) + 
  geom_text(
    data = baseline_text_data,
    aes(x = 0, label = "Baseline"),
    nudge_x = 0.005,
    size = 3.5,
    color = "black",
    hjust = 0
  ) +
  facet_grid(model_group ~ outcome, scales = "free_y", space = "free_y") +
  coord_cartesian(xlim = c(-0.01, 0.126)) +
  scale_x_continuous(breaks = c(0, 0.04, 0.08, 0.12), labels = c("0", "0.04", "0.08", "0.12")) +
  scale_color_manual(values = color_palette, name = NULL) + 
  labs(x = "\u0394 C-index (95% CI)", y = NULL) +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_markdown(size = 12, hjust = 0.5, vjust = 1, family = "Arial"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90),
    axis.ticks.y = element_blank(),
    panel.grid = element_blank(),
    legend.title = element_text(size = 12, hjust = 0.1),
    legend.text = element_text(size = 12),
    legend.position = "none",
    strip.background = element_blank(),
    strip.text.x = element_text(size = 12),
    strip.text.y = element_blank()
  )

cindex_forest_ht_med <- (cindex_forest_plot / delta_cindex_plot) + 
  plot_layout(heights = c(11/19, 8/19))

n_samples_value <- plot_data$n_samples[1]
formatted_n <- format(n_samples_value, big.mark = ",")
new_title <- glue("**c** Antihypertensive medication (*N* = {formatted_n})")

cindex_forest_ht_med <- wrap_elements(cindex_forest_ht_med) + 
  plot_annotation(
    title = new_title,
    theme = theme(plot.title = element_markdown()) 
  )

# =============================================================================
# 4. CLEAN UP ENVIRONMENT
# =============================================================================
rm(cindex_path, cindex_data_raw, cindex_data_formatted,
   plot_data, model_order_levels, delta_plot_data, baseline_text_data,
   color_palette, cindex_forest_plot, delta_cindex_plot, 
   n_samples_value, formatted_n, new_title)

print("--- Script finished and environment cleaned. ---")

```

### No antihypertensive medication

#### C-index forest plot

```{r}

# =============================================================================
# 1. SETUP
# =============================================================================
cindex_path <- "saved/results/Cindex/Merge/cindex_subgroup_final.csv"

# =============================================================================
# 2. LOAD AND PREPARE DATA
# =============================================================================
print("--- Loading and preparing C-index data... ---")

cindex_data_raw <- read_csv(cindex_path, show_col_types = FALSE) %>% 
  filter(metric == "c_index" & subgroup == "No_antihypertensive_medication")

cindex_data_raw <- read_csv(cindex_path, show_col_types = FALSE) %>% 
  filter(metric == "c_index" & subgroup == "No_antihypertensive_medication" & comparison_model %in% c("PANEL", "Genomics", "Metabolomics", "Proteomics", "PANEL_Genomics", 
    "PANEL_Metabolomics", "PANEL_Proteomics", "PANEL_Genomics_Metabolomics", 
    "PANEL_Genomics_Proteomics", "PANEL_Metabolomics_Proteomics", "PANEL_Genomics_Metabolomics_Proteomics"))

model_order_levels <- c(
  "PANEL", 
  "*+PRS*", "*+MetScore*", "*+ProScore*", 
  "*+PRS +MetScore*", "*+PRS +ProScore*", "*+MetScore +ProScore*", 
  "*+PRS +MetScore +ProScore*",
  "PRS", "MetScore", "ProScore"
)

plot_data <- cindex_data_raw %>%
  mutate(
    model_group = case_when(
      str_starts(comparison_model, "PANEL") ~ "PANEL-based",
      comparison_model %in% c("Genomics", "Metabolomics", "Proteomics") ~ "Omics-based",
      TRUE ~ "Other"
    ),
    model_group = factor(
      model_group,
      levels = c("Omics-based", "PANEL-based")
    ),
    comparison_model_formatted = case_when(
      comparison_model == "PANEL" ~ "PANEL",
      comparison_model == "Genomics" ~ "PRS",
      comparison_model == "Metabolomics" ~ "MetScore",
      comparison_model == "Proteomics" ~ "ProScore",
      TRUE ~ comparison_model %>%
        str_remove("^(PANEL)_") %>%
        str_replace_all(c("Genomics" = "PRS", "Metabolomics" = "MetScore", "Proteomics" = "ProScore")) %>%
        str_replace_all("_", " +") %>%
        paste0("+", .) %>%
        paste0("*", ., "*")
    ),
    comparison_model_formatted = factor(comparison_model_formatted, levels = rev(model_order_levels)),
    outcome = factor(
      outcome,
      levels = c("cad", "stroke", "hf", "af", "pad", "vte"),
      labels = c("CAD", "Stroke", "HF", "AF", "PAD", "VTE")
    )
  )

# =============================================================================
# 4. CREATE THE FOREST PLOT
# =============================================================================
print("--- Generating forest plot... ---")

baseline_lines <- plot_data %>% 
  filter(comparison_model_formatted %in% c("AgeSex", "Clin", "PANEL")) %>%
  select(outcome, model_group, point_estimate)

color_palette <- c(
  "Omics-based"     = "#E64B35CC",
  "PANEL-based"     = "#3C5488CC"
)

cindex_forest_plot <- ggplot(
  plot_data, 
  aes(x = point_estimate, y = comparison_model_formatted, color = model_group)
) +
  geom_vline(
    data = baseline_lines,
    aes(xintercept = point_estimate),
    color = "#D3D3D3", 
    linetype = "dashed", 
    linewidth = 0.75
  ) +
  geom_linerange(aes(xmin = ci_lower, xmax = ci_upper), linewidth = 1) +
  geom_point(size = 1, alpha = 1) + 
  facet_grid(model_group ~ outcome, scales = "free_y", space = "free_y") +
  coord_cartesian(xlim = c(0.49, 1.02)) +
  scale_x_continuous(breaks = c(0.5, 0.75, 1.0), labels = c("0.5", "0.75", "1.0")) +
  scale_color_manual(values = color_palette, name = NULL) + 
  labs(x = "C-index (95% CI)", y = NULL) +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = 0, angle = 0),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90),
    axis.ticks.y = element_blank(),
    panel.grid = element_blank(),
    legend.title = element_text(size = 12, hjust = 0.1),
    legend.text = element_text(size = 12),
    legend.position = "none",
    strip.background = element_blank(),
    strip.text.x = element_text(size = 12),
    strip.text.y = element_blank()
  )

legend <- ggplot(
  plot_data, 
  aes(x = point_estimate, y = reorder_within(comparison_model_formatted, desc(comparison_model_formatted), model_group), color = model_group)
) +
  geom_linerange(aes(xmin = ci_lower, xmax = ci_upper), linewidth = 1) +
  geom_point(size = 1, alpha = 1) + 
  facet_grid(model_group ~ outcome, scales = "free_y", space = "free_y") +
  scale_color_manual(values = color_palette, name = NULL) + 
  tidytext::scale_y_reordered() +
  theme_bw() +
  theme(
    legend.title = element_text(size = 12, hjust = 0.1),
    legend.text = element_text(size = 12),
    legend.position = "bottom"
  )

# =============================================================================
# 5. CLEAN UP ENVIRONMENT
# =============================================================================
rm(cindex_path, cindex_data_raw, plot_data, model_order_levels,
   baseline_lines, color_palette)

print("--- Script finished and environment cleaned. ---")

```

#### Delta C-index

```{r}

# =============================================================================
# 1. SETUP
# =============================================================================
cindex_path <- "saved/results/Cindex/Merge/cindex_subgroup_final.csv"

# =============================================================================
# 2. LOAD AND PREPARE DATA
# =============================================================================
print("--- Loading and preparing C-index data... ---")

cindex_data_raw <- read_csv(cindex_path, show_col_types = FALSE) %>% 
  filter(metric == "delta_c_index" & subgroup == "No_antihypertensive_medication")

cindex_data_raw <- read_csv(cindex_path, show_col_types = FALSE) %>% 
  filter(metric == "delta_c_index" & subgroup == "No_antihypertensive_medication" & comparison_model %in% c("PANEL", "PANEL_Genomics", 
    "PANEL_Metabolomics", "PANEL_Proteomics", "PANEL_Genomics_Metabolomics", 
    "PANEL_Genomics_Proteomics", "PANEL_Metabolomics_Proteomics", "PANEL_Genomics_Metabolomics_Proteomics"))


cindex_data_formatted <- cindex_data_raw %>%
  mutate(
    model_group = case_when(
      str_starts(comparison_model, "PANEL") ~ "PANEL-based",
      comparison_model %in% c("Genomics", "Metabolomics", "Proteomics") ~ "Omics-based",
      TRUE ~ "Other"
    ),
    comparison_model_formatted = case_when(
      comparison_model %in% c("PANEL", "Genomics", "Metabolomics", "Proteomics") ~ recode(comparison_model, "Genomics"="PRS", "Metabolomics"="MetScore", "Proteomics"="ProScore"),
      TRUE ~ comparison_model %>%
        str_remove("^(PANEL)_") %>%
        str_replace_all(c("Genomics" = "PRS", "Metabolomics" = "MetScore", "Proteomics" = "ProScore")) %>%
        str_replace_all("_", " +") %>%
        paste0("+", .) %>%
        paste0("*", ., "*")
    )
  )

model_order_levels <- c(
  "PANEL", "*+PRS*", "*+MetScore*", "*+ProScore*", 
  "*+PRS +MetScore*", "*+PRS +ProScore*", "*+MetScore +ProScore*", 
  "*+PRS +MetScore +ProScore*", "PRS", "MetScore", "ProScore"
)

plot_data <- cindex_data_formatted %>%
  mutate(
    outcome = factor(
      outcome,
      levels = c("cad", "stroke", "hf", "af", "pad", "vte"),
      labels = c("CAD", "Stroke", "HF", "AF", "PAD", "VTE")
    ),
    model_group = factor(
      model_group,
      levels = c("Omics-based", "PANEL-based")
    ),
    comparison_model_formatted = factor(comparison_model_formatted, levels = rev(model_order_levels))
  )

# =============================================================================
# 3. CREATE THE DELTA C-INDEX FOREST PLOT
# =============================================================================
print("--- Generating delta C-index forest plot... ---")

delta_plot_data <- plot_data %>%
  mutate(
    across(
      c(point_estimate, ci_lower, ci_upper),
      ~ if_else(comparison_model_formatted %in% c("PANEL"), NA_real_, .x)
    )
  )

baseline_text_data <- delta_plot_data %>%
  filter(comparison_model_formatted %in% c("PANEL"))

color_palette <- c(
  "PANEL-based"     = "#3C5488CC"
)

delta_cindex_plot <- ggplot(
  delta_plot_data, 
  aes(x = point_estimate, y = comparison_model_formatted, color = model_group)
) +
  geom_vline(
    xintercept = 0,
    color = "#D3D3D3", 
    linetype = "dashed", 
    linewidth = 0.75
  ) +
  geom_linerange(aes(xmin = ci_lower, xmax = ci_upper), linewidth = 1) +
  geom_point(size = 1, alpha = 1) + 
  geom_text(
    data = baseline_text_data,
    aes(x = 0, label = "Baseline"),
    nudge_x = 0.005,
    size = 3.5,
    color = "black",
    hjust = 0
  ) +
  facet_grid(model_group ~ outcome, scales = "free_y", space = "free_y") +
  coord_cartesian(xlim = c(-0.01, 0.126)) +
  scale_x_continuous(breaks = c(0, 0.04, 0.08, 0.12), labels = c("0", "0.04", "0.08", "0.12")) +
  scale_color_manual(values = color_palette, name = NULL) + 
  labs(x = "\u0394 C-index (95% CI)", y = NULL) +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_markdown(size = 12, hjust = 0.5, vjust = 1, family = "Arial"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90),
    axis.ticks.y = element_blank(),
    panel.grid = element_blank(),
    legend.title = element_text(size = 12, hjust = 0.1),
    legend.text = element_text(size = 12),
    legend.position = "none",
    strip.background = element_blank(),
    strip.text.x = element_text(size = 12),
    strip.text.y = element_blank()
  )

cindex_forest_no_ht_med <- (cindex_forest_plot / delta_cindex_plot) + 
  plot_layout(heights = c(11/19, 8/19))

n_samples_value <- plot_data$n_samples[1]
formatted_n <- format(n_samples_value, big.mark = ",")
new_title <- glue("**d** No antihypertensive medication (*N* = {formatted_n})")

cindex_forest_no_ht_med <- wrap_elements(cindex_forest_no_ht_med) + 
  plot_annotation(
    title = new_title,
    theme = theme(plot.title = element_markdown()) 
  )

# =============================================================================
# 4. CLEAN UP ENVIRONMENT
# =============================================================================
rm(cindex_path, cindex_data_raw, cindex_data_formatted,
   plot_data, model_order_levels, delta_plot_data, baseline_text_data,
   color_palette, cindex_forest_plot, delta_cindex_plot, 
   n_samples_value, formatted_n, new_title)

print("--- Script finished and environment cleaned. ---")

```

### Pool

#### By demographics

```{r}

# =============================================================================
# 1. COMBINE PLOTS
# =============================================================================
cindex_subgroup_plot <- (wrap_elements(cindex_forest_age_under_60) + wrap_elements(cindex_forest_age_over_60)) / (wrap_elements(cindex_forest_male) + wrap_elements(cindex_forest_female))

cindex_subgroup_plot <- wrap_elements(cindex_subgroup_plot) / ggpubr::get_legend(legend) +
  plot_layout(heights = c(0.99, 0.01))

# =============================================================================
# 2. SAVE AND CLEAN UP
# =============================================================================
print("--- Saving final plot in all formats... ---")

ggsave(str_c(getwd(), "/results/Figure/Performance_comparison_subgroup_by_demographics.svg"), plot = cindex_subgroup_plot, width = 28, height = 18, unit = "in", dpi = 300, device = "svg")

rm(cindex_forest_age_under_60, cindex_forest_age_over_60, cindex_forest_male, cindex_forest_female, cindex_subgroup_plot)

```

#### By Medications

```{r}

# =============================================================================
# 1. COMBINE PLOTS
# =============================================================================
cindex_subgroup_plot <- (wrap_elements(cindex_forest_lipid_med) + wrap_elements(cindex_forest_no_lipid_med)) / (wrap_elements(cindex_forest_ht_med) + wrap_elements(cindex_forest_no_ht_med))

cindex_subgroup_plot <- wrap_elements(cindex_subgroup_plot) / ggpubr::get_legend(legend) +
  plot_layout(heights = c(0.99, 0.01))

# =============================================================================
# 2. SAVE AND CLEAN UP
# =============================================================================
print("--- Saving final plot in all formats... ---")

ggsave(str_c(getwd(), "/results/Figure/Performance_comparison_subgroup_by_medications.svg"), plot = cindex_subgroup_plot, width = 28, height = 18, unit = "in", dpi = 300, device = "svg")

rm(cindex_forest_lipid_med, cindex_forest_no_lipid_med, cindex_forest_ht_med, cindex_forest_no_ht_med, legend, cindex_subgroup_plot)

```

## Exclude events within the first 2 years

### C-index forest plot

```{r}

# =============================================================================
# 1. SETUP
# =============================================================================
cindex_path <- "saved/results/Cindex/Merge/cindex_event_2yrs_final.csv"

# =============================================================================
# 2. LOAD AND PREPARE DATA
# =============================================================================
print("--- Loading and preparing C-index data... ---")

cindex_data_raw <- read_csv(cindex_path, show_col_types = FALSE) %>%
  filter(metric == "c_index")

model_order_levels <- c(
  "PANEL", 
  "*+PRS*", "*+MetScore*", "*+ProScore*", 
  "*+PRS +MetScore*", "*+PRS +ProScore*", "*+MetScore +ProScore*", 
  "*+PRS +MetScore +ProScore*",
  "PRS", "MetScore", "ProScore"
)

plot_data <- cindex_data_raw %>%
  mutate(
    model_group = case_when(
      str_starts(comparison_model, "PANEL") ~ "PANEL-based",
      comparison_model %in% c("Genomics", "Metabolomics", "Proteomics") ~ "Omics-based",
      TRUE ~ "Other"
    ),
    model_group = factor(model_group, levels = c("Omics-based", "PANEL-based")),
    comparison_model_formatted = case_when(
      comparison_model == "PANEL" ~ "PANEL",
      comparison_model == "Genomics" ~ "PRS",
      comparison_model == "Metabolomics" ~ "MetScore",
      comparison_model == "Proteomics" ~ "ProScore",
      TRUE ~ comparison_model %>%
        str_remove("^(PANEL)_") %>%
        str_replace_all(c("Genomics" = "PRS", "Metabolomics" = "MetScore", "Proteomics" = "ProScore")) %>%
        str_replace_all("_", " +") %>%
        paste0("+", .) %>%
        paste0("*", ., "*")
    ),
    comparison_model_formatted = factor(comparison_model_formatted, levels = rev(model_order_levels)),
    outcome = factor(
      outcome,
      levels = c("cad", "stroke", "hf", "af", "pad", "vte"),
      labels = c("CAD", "Stroke", "HF", "AF", "PAD", "VTE")
    )
  )

# =============================================================================
# 3. CREATE THE FOREST PLOT
# =============================================================================
print("--- Generating forest plot... ---")

baseline_lines <- plot_data %>% 
  filter(comparison_model_formatted %in% c("PANEL")) %>%
  select(outcome, model_group, point_estimate)

color_palette <- c(
  "Omics-based"     = "#E64B35CC",
  "PANEL-based"     = "#3C5488CC"
)

cindex_forest_plot <- ggplot(
  plot_data, 
  aes(x = point_estimate, y = comparison_model_formatted, color = model_group)
) +
  geom_vline(
    data = baseline_lines,
    aes(xintercept = point_estimate),
    color = "#D3D3D3", 
    linetype = "dashed", 
    linewidth = 0.75
  ) +
  geom_linerange(aes(xmin = ci_lower, xmax = ci_upper), linewidth = 1) +
  geom_point(size = 1, alpha = 1) + 
  facet_grid(model_group ~ outcome, scales = "free_y", space = "free_y") +
  coord_cartesian(xlim = c(0.49, 1.02)) +
  scale_x_continuous(breaks = c(0.5, 0.75, 1.0), labels = c("0.5", "0.75", "1.0")) +
  scale_color_manual(values = color_palette, name = NULL) + 
  labs(x = "C-index (95% CI)", y = NULL) +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = 0, angle = 0),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90),
    axis.ticks.y = element_blank(),
    panel.grid = element_blank(),
    legend.title = element_text(size = 12, hjust = 0.1),
    legend.text = element_text(size = 12),
    legend.position = "none",
    strip.background = element_blank(),
    strip.text.x = element_text(size = 12),
    strip.text.y = element_blank()
  )

legend <- ggplot(
  plot_data, 
  aes(x = point_estimate, y = reorder_within(comparison_model_formatted, desc(comparison_model_formatted), model_group), color = model_group)
) +
  geom_linerange(aes(xmin = ci_lower, xmax = ci_upper), linewidth = 1) +
  geom_point(size = 1, alpha = 1) + 
  facet_grid(model_group ~ outcome, scales = "free_y", space = "free_y") +
  scale_color_manual(values = color_palette, name = NULL) + 
  tidytext::scale_y_reordered() +
  theme_bw() +
  theme(
    legend.title = element_text(size = 12, hjust = 0.1),
    legend.text = element_text(size = 12),
    legend.position = "bottom"
  )

# =============================================================================
# 5. CLEAN UP ENVIRONMENT
# =============================================================================
rm(cindex_path, cindex_data_raw, plot_data, model_order_levels, baseline_lines, color_palette)

print("--- Script finished and environment cleaned. ---")

```

### Delta C-index

```{r}

# =============================================================================
# 1. SETUP
# =============================================================================
cindex_path <- "saved/results/Cindex/Merge/cindex_event_2yrs_final.csv"

# =============================================================================
# 2. LOAD AND PREPARE DATA (Data wrangling is the same as before)
# =============================================================================
print("--- Loading and preparing C-index data... ---")
cindex_data_raw <- read_csv(cindex_path, show_col_types = FALSE) %>% 
  filter(metric == "delta_c_index")

model_order_levels <- c(
  "PANEL", "*+PRS*", "*+MetScore*", "*+ProScore*", 
  "*+PRS +MetScore*", "*+PRS +ProScore*", "*+MetScore +ProScore*", 
  "*+PRS +MetScore +ProScore*", "PRS", "MetScore", "ProScore"
)

plot_data <- cindex_data_raw %>%
  mutate(
    model_group = case_when(
      str_starts(comparison_model, "PANEL") ~ "PANEL-based",
      comparison_model %in% c("Genomics", "Metabolomics", "Proteomics") ~ "Omics-based",
      TRUE ~ "Other"
    ),
    model_group = factor(model_group, levels = c("Omics-based", "PANEL-based")),
    comparison_model_formatted = case_when(
      comparison_model %in% c("AgeSex", "Clinical", "PANEL", "Genomics", "Metabolomics", "Proteomics") ~ 
        recode(comparison_model, "Genomics"="PRS", "Metabolomics"="MetScore", "Proteomics"="ProScore", "Clinical"="Clin"),
      TRUE ~ comparison_model %>%
        str_remove("^(AgeSex|Clinical|PANEL)_") %>%
        str_replace_all(c("Genomics" = "PRS", "Metabolomics" = "MetScore", "Proteomics" = "ProScore")) %>%
        str_replace_all("_", " +") %>%
        paste0("+", .) %>%
        paste0("*", ., "*")
    ),
    comparison_model_formatted = factor(comparison_model_formatted, levels = rev(model_order_levels)),
    outcome = factor(
      outcome,
      levels = c("cad", "stroke", "hf", "af", "pad", "vte"),
      labels = c("CAD", "Stroke", "HF", "AF", "PAD", "VTE")
    )
  )

# =============================================================================
# 3. CREATE THE DELTA C-INDEX FOREST PLOT
# =============================================================================
print("--- Generating delta C-index forest plot... ---")

delta_plot_data <- plot_data %>%
  filter(model_group != "Omics-based") %>%
  mutate(
    across(
      c(point_estimate, ci_lower, ci_upper),
      ~ if_else(comparison_model_formatted %in% c("PANEL"), NA_real_, .x)
    )
  )

baseline_text_data <- delta_plot_data %>%
  filter(comparison_model_formatted %in% c("PANEL"))

color_palette <- c(
  "Omics-based"     = "#E64B35CC", 
  "PANEL-based"     = "#3C5488CC"
)

delta_cindex_plot <- ggplot(
  delta_plot_data, 
  aes(x = point_estimate, y = comparison_model_formatted, color = model_group)
) +
  geom_vline(
    xintercept = 0,
    color = "#D3D3D3", 
    linetype = "dashed", 
    linewidth = 0.75
  ) +
  geom_linerange(aes(xmin = ci_lower, xmax = ci_upper), linewidth = 1) +
  geom_point(size = 1, alpha = 1) + 
  geom_text(
    data = baseline_text_data,
    aes(x = 0, label = "Baseline"),
    nudge_x = 0.005,
    size = 3.5,
    color = "black",
    hjust = 0
  ) +
  facet_grid(model_group ~ outcome, scales = "free_y", space = "free_y") +
  coord_cartesian(xlim = c(-0.01, 0.07)) +
  scale_x_continuous(breaks = c(0, 0.03, 0.06), labels = c("0", "0.03", "0.06")) +
  scale_color_manual(values = color_palette, name = NULL) + 
  labs(x = "\u0394 C-index (95% CI)", y = NULL) +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_markdown(size = 12, hjust = 0.5, vjust = 1, family = "Arial"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90),
    axis.ticks.y = element_blank(),
    panel.grid = element_blank(),
    legend.title = element_text(size = 12, hjust = 0.1),
    legend.text = element_text(size = 12),
    legend.position = "none",
    strip.background = element_blank(),
    strip.text.x = element_text(size = 12),
    strip.text.y = element_blank()
  )

# =============================================================================
# 4. CLEAN UP ENVIRONMENT
# =============================================================================
rm(cindex_path, cindex_data_raw, plot_data, model_order_levels, delta_plot_data, baseline_text_data, color_palette)

print("--- Script finished and environment cleaned. ---")

```

### Pool

```{r}

# =============================================================================
# 1. COMBINE PLOTS
# =============================================================================
cindex_plot <- (cindex_forest_plot / delta_cindex_plot) + 
  plot_layout(heights = c(11/19, 8/19)) +
  plot_annotation(tag_levels = "a") &
  theme(plot.tag = element_text(face = "bold"))

cindex_plot <- wrap_elements(cindex_plot) / ggpubr::get_legend(legend) +
  plot_layout(heights = c(0.95, 0.05))

# =============================================================================
# 2. SAVE AND CLEAN UP
# =============================================================================
print("--- Saving final plot in all formats... ---")

ggsave(str_c(getwd(), "/results/Figure/Performance_comparison_event_2yrs.svg"), plot = cindex_plot, width = 14, height = 10, unit = "in", dpi = 300, device = "svg")

rm(cindex_forest_plot, delta_cindex_plot, legend, cindex_plot)

```

## Competing risk (Fine & Gray)

### C-index forest plot

```{r}

# =============================================================================
# 1. SETUP
# =============================================================================
cindex_path <- "saved/results/Cindex/Merge/cindex_competing_risk_final.csv"

# =============================================================================
# 2. LOAD AND PREPARE DATA
# =============================================================================
print("--- Loading and preparing C-index data... ---")

cindex_data_raw <- read_csv(cindex_path, show_col_types = FALSE) %>%
  filter(metric == "c_index")

model_order_levels <- c(
  "PANEL", 
  "*+PRS*", "*+MetScore*", "*+ProScore*", 
  "*+PRS +MetScore*", "*+PRS +ProScore*", "*+MetScore +ProScore*", 
  "*+PRS +MetScore +ProScore*",
  "PRS", "MetScore", "ProScore"
)

plot_data <- cindex_data_raw %>%
  mutate(
    model_group = case_when(
      str_starts(comparison_model, "PANEL") ~ "PANEL-based",
      comparison_model %in% c("Genomics", "Metabolomics", "Proteomics") ~ "Omics-based",
      TRUE ~ "Other"
    ),
    model_group = factor(model_group, levels = c("Omics-based", "PANEL-based")),
    comparison_model_formatted = case_when(
      comparison_model == "PANEL" ~ "PANEL",
      comparison_model == "Genomics" ~ "PRS",
      comparison_model == "Metabolomics" ~ "MetScore",
      comparison_model == "Proteomics" ~ "ProScore",
      TRUE ~ comparison_model %>%
        str_remove("^(PANEL)_") %>%
        str_replace_all(c("Genomics" = "PRS", "Metabolomics" = "MetScore", "Proteomics" = "ProScore")) %>%
        str_replace_all("_", " +") %>%
        paste0("+", .) %>%
        paste0("*", ., "*")
    ),
    comparison_model_formatted = factor(comparison_model_formatted, levels = rev(model_order_levels)),
    outcome = factor(
      outcome,
      levels = c("cad", "stroke", "hf", "af", "pad", "vte"),
      labels = c("CAD", "Stroke", "HF", "AF", "PAD", "VTE")
    )
  )

# =============================================================================
# 3. CREATE THE FOREST PLOT
# =============================================================================
print("--- Generating forest plot... ---")

baseline_lines <- plot_data %>% 
  filter(comparison_model_formatted %in% c("PANEL")) %>%
  select(outcome, model_group, point_estimate)

color_palette <- c(
  "Omics-based"     = "#E64B35CC",
  "PANEL-based"     = "#3C5488CC"
)

cindex_forest_plot <- ggplot(
  plot_data, 
  aes(x = point_estimate, y = comparison_model_formatted, color = model_group)
) +
  geom_vline(
    data = baseline_lines,
    aes(xintercept = point_estimate),
    color = "#D3D3D3", 
    linetype = "dashed", 
    linewidth = 0.75
  ) +
  geom_linerange(aes(xmin = ci_lower, xmax = ci_upper), linewidth = 1) +
  geom_point(size = 1, alpha = 1) + 
  facet_grid(model_group ~ outcome, scales = "free_y", space = "free_y") +
  coord_cartesian(xlim = c(0.49, 1.02)) +
  scale_x_continuous(breaks = c(0.5, 0.75, 1.0), labels = c("0.5", "0.75", "1.0")) +
  scale_color_manual(values = color_palette, name = NULL) + 
  labs(x = "C-index (95% CI)", y = NULL) +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = 0, angle = 0),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90),
    axis.ticks.y = element_blank(),
    panel.grid = element_blank(),
    legend.title = element_text(size = 12, hjust = 0.1),
    legend.text = element_text(size = 12),
    legend.position = "none",
    strip.background = element_blank(),
    strip.text.x = element_text(size = 12),
    strip.text.y = element_blank()
  )

legend <- ggplot(
  plot_data, 
  aes(x = point_estimate, y = reorder_within(comparison_model_formatted, desc(comparison_model_formatted), model_group), color = model_group)
) +
  geom_linerange(aes(xmin = ci_lower, xmax = ci_upper), linewidth = 1) +
  geom_point(size = 1, alpha = 1) + 
  facet_grid(model_group ~ outcome, scales = "free_y", space = "free_y") +
  scale_color_manual(values = color_palette, name = NULL) + 
  tidytext::scale_y_reordered() +
  theme_bw() +
  theme(
    legend.title = element_text(size = 12, hjust = 0.1),
    legend.text = element_text(size = 12),
    legend.position = "bottom"
  )

# =============================================================================
# 5. CLEAN UP ENVIRONMENT
# =============================================================================
rm(cindex_path, cindex_data_raw, plot_data, model_order_levels, baseline_lines, color_palette)

print("--- Script finished and environment cleaned. ---")

```

### Delta C-index

```{r}

# =============================================================================
# 1. SETUP
# =============================================================================
cindex_path <- "saved/results/Cindex/Merge/cindex_competing_risk_final.csv"

# =============================================================================
# 2. LOAD AND PREPARE DATA (Data wrangling is the same as before)
# =============================================================================
print("--- Loading and preparing C-index data... ---")
cindex_data_raw <- read_csv(cindex_path, show_col_types = FALSE) %>% 
  filter(metric == "delta_c_index")

model_order_levels <- c(
  "PANEL", "*+PRS*", "*+MetScore*", "*+ProScore*", 
  "*+PRS +MetScore*", "*+PRS +ProScore*", "*+MetScore +ProScore*", 
  "*+PRS +MetScore +ProScore*", "PRS", "MetScore", "ProScore"
)

plot_data <- cindex_data_raw %>%
  mutate(
    model_group = case_when(
      str_starts(comparison_model, "PANEL") ~ "PANEL-based",
      comparison_model %in% c("Genomics", "Metabolomics", "Proteomics") ~ "Omics-based",
      TRUE ~ "Other"
    ),
    model_group = factor(model_group, levels = c("Omics-based", "PANEL-based")),
    comparison_model_formatted = case_when(
      comparison_model %in% c("AgeSex", "Clinical", "PANEL", "Genomics", "Metabolomics", "Proteomics") ~ 
        recode(comparison_model, "Genomics"="PRS", "Metabolomics"="MetScore", "Proteomics"="ProScore", "Clinical"="Clin"),
      TRUE ~ comparison_model %>%
        str_remove("^(AgeSex|Clinical|PANEL)_") %>%
        str_replace_all(c("Genomics" = "PRS", "Metabolomics" = "MetScore", "Proteomics" = "ProScore")) %>%
        str_replace_all("_", " +") %>%
        paste0("+", .) %>%
        paste0("*", ., "*")
    ),
    comparison_model_formatted = factor(comparison_model_formatted, levels = rev(model_order_levels)),
    outcome = factor(
      outcome,
      levels = c("cad", "stroke", "hf", "af", "pad", "vte"),
      labels = c("CAD", "Stroke", "HF", "AF", "PAD", "VTE")
    )
  )

# =============================================================================
# 3. CREATE THE DELTA C-INDEX FOREST PLOT
# =============================================================================
print("--- Generating delta C-index forest plot... ---")

delta_plot_data <- plot_data %>%
  filter(model_group != "Omics-based") %>%
  mutate(
    across(
      c(point_estimate, ci_lower, ci_upper),
      ~ if_else(comparison_model_formatted %in% c("PANEL"), NA_real_, .x)
    )
  )

baseline_text_data <- delta_plot_data %>%
  filter(comparison_model_formatted %in% c("PANEL"))

color_palette <- c(
  "Omics-based"     = "#E64B35CC", 
  "PANEL-based"     = "#3C5488CC"
)

delta_cindex_plot <- ggplot(
  delta_plot_data, 
  aes(x = point_estimate, y = comparison_model_formatted, color = model_group)
) +
  geom_vline(
    xintercept = 0,
    color = "#D3D3D3", 
    linetype = "dashed", 
    linewidth = 0.75
  ) +
  geom_linerange(aes(xmin = ci_lower, xmax = ci_upper), linewidth = 1) +
  geom_point(size = 1, alpha = 1) + 
  geom_text(
    data = baseline_text_data,
    aes(x = 0, label = "Baseline"),
    nudge_x = 0.005,
    size = 3.5,
    color = "black",
    hjust = 0
  ) +
  facet_grid(model_group ~ outcome, scales = "free_y", space = "free_y") +
  coord_cartesian(xlim = c(-0.01, 0.07)) +
  scale_x_continuous(breaks = c(0, 0.03, 0.06), labels = c("0", "0.03", "0.06")) +
  scale_color_manual(values = color_palette, name = NULL) + 
  labs(x = "\u0394 C-index (95% CI)", y = NULL) +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", angle = 0),
    axis.text.y = element_markdown(size = 12, colour = "black", hjust = 1, vjust = .5, angle = 0),
    axis.title.x = element_markdown(size = 12, hjust = 0.5, vjust = 1, family = "Arial"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90),
    axis.ticks.y = element_blank(),
    panel.grid = element_blank(),
    legend.title = element_text(size = 12, hjust = 0.1),
    legend.text = element_text(size = 12),
    legend.position = "none",
    strip.background = element_blank(),
    strip.text.x = element_text(size = 12),
    strip.text.y = element_blank()
  )

# =============================================================================
# 4. CLEAN UP ENVIRONMENT
# =============================================================================
rm(cindex_path, cindex_data_raw, plot_data, model_order_levels, delta_plot_data, baseline_text_data, color_palette)

print("--- Script finished and environment cleaned. ---")

```

### Pool

```{r}

# =============================================================================
# 1. COMBINE PLOTS
# =============================================================================
cindex_plot <- (cindex_forest_plot / delta_cindex_plot) + 
  plot_layout(heights = c(11/19, 8/19)) +
  plot_annotation(tag_levels = "a") &
  theme(plot.tag = element_text(face = "bold"))

cindex_plot <- wrap_elements(cindex_plot) / ggpubr::get_legend(legend) +
  plot_layout(heights = c(0.95, 0.05))

# =============================================================================
# 2. SAVE AND CLEAN UP
# =============================================================================
print("--- Saving final plot in all formats... ---")

ggsave(str_c(getwd(), "/results/Figure/Performance_comparison_competing_risk.svg"), plot = cindex_plot, width = 14, height = 10, unit = "in", dpi = 300, device = "svg")

rm(cindex_forest_plot, delta_cindex_plot, legend, cindex_plot)

```

------------------------------------------------------------------------------------

# Calibration and decision curve analysis

## Calibration

### AgeSex-based

```{r}

# =============================================================================
# 1. SETUP
# =============================================================================
base_path <- "saved/results/Incident_Probabilities"

outcomes <- c("cad", "stroke", "hf", "af", "pad", "vte")
model_features <- c("Genomics", "Metabolomics", "Proteomics")

model_suffixes <- c(
  "AgeSex",
  unlist(map(1:length(model_features), ~ combn(model_features, .x, FUN = paste, collapse = "_"))) %>%
    paste("AgeSex", ., sep = "_")
)

# =============================================================================
# 2. LOAD & WRANGLE: Combine all 48 data files into one
# =============================================================================
print("--- Loading and combining all prediction files... ---")

files_to_load <- expand_grid(outcome = outcomes, model_suffix = model_suffixes) %>%
  mutate(
    full_path = file.path(base_path, outcome, paste0("incident_prob_", model_suffix, ".csv"))
  )

all_predictions <- pmap_dfr(
  .l = files_to_load,
  .f = function(outcome, model_suffix, full_path) {
    read_csv(full_path, col_types = cols(.default = "d")) %>%
      mutate(
        outcome = outcome,
        model = model_suffix
      )
  }
)

model_levels <- c("AgeSex", "*+PRS*", "*+MetScore*", "*+ProScore*", "*+PRS +MetScore*", "*+PRS +ProScore*", "*+MetScore +ProScore*", "*+PRS +MetScore +ProScore*")

all_predictions_formatted <- all_predictions %>%
  mutate(
    model = model %>%
      str_replace_all("Genomics", "+PRS") %>%
      str_replace_all("Metabolomics", "+MetScore") %>%
      str_replace_all("Proteomics", "+ProScore") %>%
      str_replace("AgeSex_", "*") %>%
      str_replace_all("_", " ") %>%
      {if_else(. != "AgeSex", paste0(., "*"), .)},
    model = factor(model, levels = model_levels),
    outcome = factor(
      outcome,
      levels = c("cad", "stroke", "hf", "af", "pad", "vte"),
      labels = c("CAD", "Stroke", "HF", "AF", "PAD", "VTE")
    )
  )

print("--- Data loading and formatting complete. ---")

# =============================================================================
# 3. CALCULATION: Create the calibration data
# =============================================================================
print("--- Calculating calibration statistics... ---")

calibration_data <- all_predictions_formatted %>%
  group_by(outcome, model) %>%
  mutate(
    risk_group = ntile(risk_15y, 10),
    event_15 = case_when(
      event == 0 ~ 0,
      event == 1 & duration > 15 ~ 0,
      event == 1 & duration <= 15 ~ 1
    )
  ) %>%
  ungroup() %>%
  group_by(outcome, model, risk_group) %>% 
  summarise(
    mean_risk = mean(risk_15y, na.rm = TRUE), 
    mean_events = mean(event_15, na.rm = TRUE),
    .groups = "drop"
  )

# =============================================================================
# 4. PLOTTING: Define helpers and create the calibration plot
# =============================================================================
print("--- Generating calibration plot... ---")

cal_plot_agesex <- ggplot(
  calibration_data, 
  aes(x = mean_risk * 100, y = mean_events * 100, color = model)
) + 
  geom_abline(intercept = 0, slope = 1, color = "gray", alpha = 1, linewidth = 0.75, linetype = "dashed") +
  geom_line(linewidth = 0.75) +
  theme_classic() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black"),
    axis.text.y = element_text(size = 12, colour = "black"),
    axis.title.x = element_text(size = 12, colour = "black"),
    axis.title.y = element_text(size = 12, colour = "black"),
    legend.title = element_blank(),
    legend.text = element_markdown(size = 12), 
    legend.position = "none",
    strip.background = element_blank(),
    strip.text = element_text(size = 12),
    panel.spacing = unit(1, "lines")
  ) +
  scale_colour_manual(values = ggsci::pal_npg("nrc", alpha = 0.9)(8)) + 
  coord_cartesian(xlim = c(0, NA), ylim = c(0, NA)) +
  facet_wrap_equal(~ outcome, scales = "free") + 
  labs(
    x = "Predicted risk (%)", 
    y = "Observed event rate (%)", 
    color = ""
  )

legend_agesex <- ggplot(
  calibration_data, 
  aes(x = mean_risk * 100, y = mean_events * 100, color = model)
) + 
  geom_line(linewidth = 0.75) +
  theme_classic() +
  theme(
    legend.title = element_blank(),
    legend.text = element_markdown(size = 12), 
    legend.position = "right"
  ) +
  scale_colour_manual(values = ggsci::pal_npg("nrc", alpha = 0.9)(8)) + 
  facet_wrap_equal(~ outcome, scales = "free")

# =============================================================================
# 5. CLEAN UP ENVIRONMENT
# =============================================================================
rm(base_path, outcomes, model_features, model_suffixes, files_to_load, all_predictions, model_levels, all_predictions_formatted, calibration_data)

print("--- Script finished and environment cleaned. ---")

```

### Clinical-based

```{r}

# =============================================================================
# 1. SETUP
# =============================================================================
base_path <- "saved/results/Incident_Probabilities"

outcomes <- c("cad", "stroke", "hf", "af", "pad", "vte")
model_features <- c("Genomics", "Metabolomics", "Proteomics")

model_suffixes <- c(
  "Clinical",
  unlist(map(1:length(model_features), ~ combn(model_features, .x, FUN = paste, collapse = "_"))) %>%
    paste("Clinical", ., sep = "_")
)

# =============================================================================
# 2. LOAD & WRANGLE: Combine all 48 data files into one
# =============================================================================
print("--- Loading and combining all prediction files... ---")

files_to_load <- expand_grid(outcome = outcomes, model_suffix = model_suffixes) %>%
  mutate(
    full_path = file.path(base_path, outcome, paste0("incident_prob_", model_suffix, ".csv"))
  )

all_predictions <- pmap_dfr(
  .l = files_to_load,
  .f = function(outcome, model_suffix, full_path) {
    read_csv(full_path, col_types = cols(.default = "d")) %>%
      mutate(
        outcome = outcome,
        model = model_suffix
      )
  }
)

model_levels <- c("Clin", "*+PRS*", "*+MetScore*", "*+ProScore*", "*+PRS +MetScore*", "*+PRS +ProScore*", "*+MetScore +ProScore*", "*+PRS +MetScore +ProScore*")

all_predictions_formatted <- all_predictions %>%
  mutate(
    model = model %>%
      str_replace("Clinical", "Clin") %>%
      str_replace_all("Genomics", "+PRS") %>%
      str_replace_all("Metabolomics", "+MetScore") %>%
      str_replace_all("Proteomics", "+ProScore") %>%
      str_replace("Clin_", "*") %>%
      str_replace_all("_", " ") %>%
      {if_else(. != "Clin", paste0(., "*"), .)},
    model = factor(model, levels = model_levels),
    outcome = factor(
      outcome,
      levels = c("cad", "stroke", "hf", "af", "pad", "vte"),
      labels = c("CAD", "Stroke", "HF", "AF", "PAD", "VTE")
    )
  )

print("--- Data loading and formatting complete. ---")

# =============================================================================
# 3. CALCULATION: Create the calibration data
# =============================================================================
print("--- Calculating calibration statistics... ---")

calibration_data <- all_predictions_formatted %>%
  group_by(outcome, model) %>%
  mutate(
    risk_group = ntile(risk_15y, 10),
    event_15 = case_when(
      event == 0 ~ 0,
      event == 1 & duration > 15 ~ 0,
      event == 1 & duration <= 15 ~ 1
    )
  ) %>%
  ungroup() %>%
  group_by(outcome, model, risk_group) %>% 
  summarise(
    mean_risk = mean(risk_15y, na.rm = TRUE), 
    mean_events = mean(event_15, na.rm = TRUE),
    .groups = "drop"
  )

# =============================================================================
# 4. PLOTTING: Define helpers and create the calibration plot
# =============================================================================
print("--- Generating calibration plot... ---")

cal_plot_clin <- ggplot(
  calibration_data, 
  aes(x = mean_risk * 100, y = mean_events * 100, color = model)
) + 
  geom_abline(intercept = 0, slope = 1, color = "gray", alpha = 1, linewidth = 0.75, linetype = "dashed") +
  geom_line(linewidth = 0.75) +
  theme_classic() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black"),
    axis.text.y = element_text(size = 12, colour = "black"),
    axis.title.x = element_text(size = 12, colour = "black"),
    axis.title.y = element_text(size = 12, colour = "black"),
    legend.title = element_blank(),
    legend.text = element_markdown(size = 12), 
    legend.position = "none",
    strip.background = element_blank(),
    strip.text = element_text(size = 12),
    panel.spacing = unit(1, "lines")
  ) +
  scale_colour_manual(values = ggsci::pal_npg("nrc", alpha = 0.9)(8)) + 
  coord_cartesian(xlim = c(0, NA), ylim = c(0, NA)) +
  facet_wrap_equal(~ outcome, scales = "free") + 
  labs(
    x = "Predicted risk (%)", 
    y = "Observed event rate (%)", 
    color = ""
  )

legend_clin <- ggplot(
  calibration_data, 
  aes(x = mean_risk * 100, y = mean_events * 100, color = model)
) + 
  geom_line(linewidth = 0.75) +
  theme_classic() +
  theme(
    legend.title = element_blank(),
    legend.text = element_markdown(size = 12), 
    legend.position = "right"
  ) +
  scale_colour_manual(values = ggsci::pal_npg("nrc", alpha = 0.9)(8)) + 
  facet_wrap_equal(~ outcome, scales = "free")

# =============================================================================
# 5. CLEAN UP ENVIRONMENT
# =============================================================================
rm(base_path, outcomes, model_features, model_suffixes, files_to_load, all_predictions, model_levels, all_predictions_formatted, calibration_data)

print("--- Script finished and environment cleaned. ---")

```

### PANEL-based

```{r}

# =============================================================================
# 1. SETUP
# =============================================================================
base_path <- "saved/results/Incident_Probabilities"

outcomes <- c("cad", "stroke", "hf", "af", "pad", "vte")
model_features <- c("Genomics", "Metabolomics", "Proteomics")

model_suffixes <- c(
  "PANEL",
  unlist(map(1:length(model_features), ~ combn(model_features, .x, FUN = paste, collapse = "_"))) %>%
    paste("PANEL", ., sep = "_")
)

# =============================================================================
# 2. LOAD & WRANGLE: Combine all 48 data files into one
# =============================================================================
print("--- Loading and combining all prediction files... ---")

files_to_load <- expand_grid(outcome = outcomes, model_suffix = model_suffixes) %>%
  mutate(
    full_path = file.path(base_path, outcome, paste0("incident_prob_", model_suffix, ".csv"))
  )

all_predictions <- pmap_dfr(
  .l = files_to_load,
  .f = function(outcome, model_suffix, full_path) {
    read_csv(full_path, col_types = cols(.default = "d")) %>%
      mutate(
        outcome = outcome,
        model = model_suffix
      )
  }
)

model_levels <- c("PANEL", "*+PRS*", "*+MetScore*", "*+ProScore*", "*+PRS +MetScore*", "*+PRS +ProScore*", "*+MetScore +ProScore*", "*+PRS +MetScore +ProScore*")

all_predictions_formatted <- all_predictions %>%
  mutate(
    model = model %>%
      str_replace_all("Genomics", "+PRS") %>%
      str_replace_all("Metabolomics", "+MetScore") %>%
      str_replace_all("Proteomics", "+ProScore") %>%
      str_replace("PANEL_", "*") %>%
      str_replace_all("_", " ") %>%
      {if_else(. != "PANEL", paste0(., "*"), .)},
    model = factor(model, levels = model_levels),
    outcome = factor(
      outcome,
      levels = c("cad", "stroke", "hf", "af", "pad", "vte"),
      labels = c("CAD", "Stroke", "HF", "AF", "PAD", "VTE")
    )
  )

print("--- Data loading and formatting complete. ---")

# =============================================================================
# 3. CALCULATION: Create the calibration data
# =============================================================================
print("--- Calculating calibration statistics... ---")

calibration_data <- all_predictions_formatted %>%
  group_by(outcome, model) %>%
  mutate(
    risk_group = ntile(risk_15y, 10),
    event_15 = case_when(
      event == 0 ~ 0,
      event == 1 & duration > 15 ~ 0,
      event == 1 & duration <= 15 ~ 1
    )
  ) %>%
  ungroup() %>%
  group_by(outcome, model, risk_group) %>% 
  summarise(
    mean_risk = mean(risk_15y, na.rm = TRUE), 
    mean_events = mean(event_15, na.rm = TRUE),
    .groups = "drop"
  )

# =============================================================================
# 4. PLOTTING: Define helpers and create the calibration plot
# =============================================================================
print("--- Generating calibration plot... ---")

cal_plot_panel <- ggplot(
  calibration_data, 
  aes(x = mean_risk * 100, y = mean_events * 100, color = model)
) + 
  geom_abline(intercept = 0, slope = 1, color = "gray", alpha = 1, linewidth = 0.75, linetype = "dashed") +
  geom_line(linewidth = 0.75) +
  theme_classic() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black"),
    axis.text.y = element_text(size = 12, colour = "black"),
    axis.title.x = element_text(size = 12, colour = "black"),
    axis.title.y = element_text(size = 12, colour = "black"),
    legend.title = element_blank(),
    legend.text = element_markdown(size = 12), 
    legend.position = "none",
    strip.background = element_blank(),
    strip.text = element_text(size = 12),
    panel.spacing = unit(1, "lines")
  ) +
  scale_colour_manual(values = ggsci::pal_npg("nrc", alpha = 0.9)(8)) + 
  coord_cartesian(xlim = c(0, NA), ylim = c(0, NA)) +
  facet_wrap_equal(~ outcome, scales = "free") + 
  labs(
    x = "Predicted risk (%)", 
    y = "Observed event rate (%)", 
    color = ""
  )

legend_panel <- ggplot(
  calibration_data, 
  aes(x = mean_risk * 100, y = mean_events * 100, color = model)
) + 
  geom_line(linewidth = 0.75) +
  theme_classic() +
  theme(
    legend.title = element_blank(),
    legend.text = element_markdown(size = 12), 
    legend.position = "right"
  ) +
  scale_colour_manual(values = ggsci::pal_npg("nrc", alpha = 0.9)(8)) + 
  facet_wrap_equal(~ outcome, scales = "free")

example_plot <- ggplot(
  calibration_data %>% filter(outcome == "AF"), 
  aes(x = mean_risk * 100, y = mean_events * 100, color = model)
) + 
  geom_abline(intercept = 0, slope = 1, color = "gray", alpha = 1, linewidth = 0.75, linetype = "dashed") +
  geom_line(linewidth = 0.75) +
  theme_classic() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black"),
    axis.text.y = element_text(size = 12, colour = "black"),
    axis.title.x = element_text(size = 12, colour = "black"),
    axis.title.y = element_text(size = 12, colour = "black"),
    legend.title = element_blank(),
    legend.text = element_markdown(size = 12), 
    legend.position = "none",
    strip.background = element_blank(),
    strip.text = element_text(size = 12),
    panel.spacing = unit(1, "lines")
  ) +
  scale_colour_manual(values = ggsci::pal_npg("nrc", alpha = 0.9)(8)) + 
  coord_cartesian(xlim = c(0, NA), ylim = c(0, NA)) +
  labs(
    x = "Predicted risk (%)", 
    y = "Observed event rate (%)", 
    color = ""
  )

ggsave(str_c(getwd(), "/results/Figure/Model_calibration_example.png"), plot = example_plot, width = 4, height = 3, unit = "in", dpi = 300, device = "png")

# =============================================================================
# 5. CLEAN UP ENVIRONMENT
# =============================================================================
rm(base_path, outcomes, model_features, model_suffixes, files_to_load, all_predictions, model_levels, all_predictions_formatted, calibration_data, example_plot)

print("--- Script finished and environment cleaned. ---")

```


## Decision curve analysis

### AgeSex-based

```{r}

# =============================================================================
# 1. SETUP
# =============================================================================
base_path <- "saved/results/Incident_Probabilities"

outcomes <- c("cad", "stroke", "hf", "af", "pad", "vte")
model_features <- c("Genomics", "Metabolomics", "Proteomics")

model_suffixes <- c(
  "AgeSex",
  unlist(map(1:length(model_features), ~ combn(model_features, .x, FUN = paste, collapse = "_"))) %>%
    paste("AgeSex", ., sep = "_")
)

# =============================================================================
# 2. LOAD & WRANGLE: Combine all 48 data files into one
# =============================================================================
print("--- Loading and combining all prediction files... ---")

files_to_load <- expand_grid(outcome = outcomes, model_suffix = model_suffixes) %>%
  mutate(
    full_path = file.path(base_path, outcome, paste0("incident_prob_", model_suffix, ".csv"))
  )

all_predictions <- pmap_dfr(
  .l = files_to_load,
  .f = function(outcome, model_suffix, full_path) {
    read_csv(full_path, col_types = cols(.default = "d")) %>%
      mutate(
        outcome = outcome,
        model = model_suffix
      )
  }
)

model_levels <- c("AgeSex", "*+PRS*", "*+MetScore*", "*+ProScore*", "*+PRS +MetScore*", "*+PRS +ProScore*", "*+MetScore +ProScore*", "*+PRS +MetScore +ProScore*")

all_predictions_formatted <- all_predictions %>%
  mutate(
    model = model %>%
      str_replace_all("Genomics", "+PRS") %>%
      str_replace_all("Metabolomics", "+MetScore") %>%
      str_replace_all("Proteomics", "+ProScore") %>%
      str_replace("AgeSex_", "*") %>%
      str_replace_all("_", " ") %>%
      {if_else(. != "AgeSex", paste0(., "*"), .)},
    model = factor(model, levels = model_levels),
    outcome = factor(
      outcome,
      levels = c("cad", "stroke", "hf", "af", "pad", "vte"),
      labels = c("CAD", "Stroke", "HF", "AF", "PAD", "VTE")
    )
  )

print("--- Data loading and formatting complete. ---")

# =============================================================================
# 4. RESHAPE DATA TO WIDE FORMAT
# =============================================================================
print("--- Reshaping data to wide format for DCA... ---")

dat_wide <- all_predictions_formatted %>%
  select(eid, outcome, model, risk_15y, event, duration) %>%
  pivot_wider(names_from = model, values_from = risk_15y)

# =============================================================================
# 5. CALCULATE DCA VALUES FOR ALL OUTCOMES
# =============================================================================
print("--- Performing Decision Curve Analysis... (This may take a few minutes) ---")

model_names <- levels(all_predictions_formatted$model)
dca_formula <- as.formula(
  paste("Surv(duration, event) ~", paste(paste0("`", model_names, "`"), collapse = " + "))
)

dat_dca <- tibble()
outcomes_list <- levels(all_predictions_formatted$outcome)
tic("Decision Curve Analysis for all outcomes")
for(outcome_name in outcomes_list){

  print(paste("Running DCA for:", outcome_name, "..."))

  dca_result <- dca(
    formula = dca_formula,
    data = dat_wide %>% filter(outcome == outcome_name),
    time = 15,
    thresholds = seq(0, 0.5, by = 0.001)
  ) %>%
    standardized_net_benefit()
  
  dat_dca <- bind_rows(dat_dca, dca_result$dca %>% mutate(outcome = outcome_name))
  
  rm(dca_result)
}
toc()

# =============================================================================
# 6. CALCULATE THE DIFFERENCE IN AREA UNDER THE NET BENEFIT CURVE (A-NBC)
# =============================================================================
print("--- Calculating A-NBC differences... ---")

diff_nb <- dat_dca %>%
  filter(
    !is.na(standardized_net_benefit) & 
    label %in% c("AgeSex", "*+PRS*", "*+MetScore*", "*+ProScore*", "*+PRS +MetScore*", "*+PRS +ProScore*", "*+MetScore +ProScore*", "*+PRS +MetScore +ProScore*")
  ) %>%
  arrange(label, outcome, threshold) %>%
  group_by(outcome, label) %>%
  summarise(anbc = trapz(threshold*100, standardized_net_benefit*100), .groups = "drop") %>%
  group_by(outcome) %>%
  mutate(diff_anbc = anbc - anbc[label == "AgeSex"]) %>%
  ungroup() %>%
  rename(model = label)

# =============================================================================
# 4. PREPARE FINAL DATA FOR PLOTTING
# =============================================================================
threshold_ranges <- tibble(
  outcome = c("CAD", "Stroke", "HF", "AF", "PAD", "VTE"),
  xmin = c(0, 0, 0, 0, 0, 0),
  xmax = c(0.40, 0.15, 0.35, 0.45, 0.15, 0.15)
)

dat_plot <- dat_dca %>%
  rename(model = label) %>%
  inner_join(threshold_ranges, by = "outcome") %>%
  filter(threshold >= xmin & threshold <= xmax) %>%
  select(-xmin, -xmax) %>%
  left_join(diff_nb, by = c("outcome", "model")) %>%
  mutate(outcome = factor(outcome, levels = c("CAD", "Stroke", "HF", "AF", "PAD", "VTE")))

dat_label <- dat_plot %>%
  filter(!is.na(standardized_net_benefit) & !model %in% c("Treat All", "Treat None", "AgeSex")) %>%
  mutate(diff_anbc = sprintf("%0.2f", diff_anbc)) %>%
  group_by(outcome, model) %>%
  slice_head(n = 1) %>%
  ungroup() %>%
  mutate(title = "A-NBC difference:")

label_positions <- tibble(
    model = levels(all_predictions_formatted$model)[-1],
    y_pos = seq(from = 90, to = 30, length.out = 7)
)
dat_label <- dat_label %>% left_join(label_positions, by="model")


# =============================================================================
# 5. VISUALIZATION: Create the DCA Plot
# =============================================================================
print("--- Generating final DCA plot... ---")

model_color_palette <- c(
  "AgeSex" = "#E64B35E5",
  "*+PRS*" = "#4DBBD5E5",
  "*+MetScore*" = "#00A087E5",
  "*+ProScore*" = "#3C5488E5",
  "*+PRS +MetScore*" = "#F39B7FE5",
  "*+PRS +ProScore*" = "#8491B4E5",
  "*+MetScore +ProScore*" = "#91D1C2E5",
  "*+PRS +MetScore +ProScore*" = "#DC0000E5"
)

dca_plot_agesex <- dat_plot %>% 
  filter(!is.na(standardized_net_benefit) & !model %in% c("Treat All", "Treat None")) %>%
  ggplot(aes(x = threshold * 100, y = standardized_net_benefit * 100, color = model)) +
  geom_line(
    data = dat_plot %>% filter(model == "Treat All"), color = "gray", linetype = "dashed", linewidth = 0.75
  ) +
  geom_line(
    data = dat_plot %>% filter(model == "Treat None"), color = "gray", linetype = "dashed", linewidth = 0.75
  ) +
  geom_line(linewidth = 0.8) + 
  theme_classic() +
  theme(
    axis.text = element_text(size = 12, colour = "black"),
    axis.title = element_text(size = 12, colour = "black"),
    legend.title = element_blank(),
    legend.text = element_markdown(size = 12),
    legend.position = "none",
    strip.background = element_blank(),
    strip.text = element_text(size = 12),
    panel.spacing = unit(1, "lines")
  ) +
  scale_colour_manual(values = model_color_palette) + 
  coord_cartesian(ylim = c(-5, 102)) +
  facet_wrap(~ outcome, scales = "free") + 
  labs(
    x = "Threshold probability (%)", 
    y = "Standardized net benefit", 
    color = ""
  ) +
  geom_text(
    data = dat_label %>% group_by(outcome) %>% slice(1) %>% ungroup(),
    mapping = aes(x = Inf, y = 100, label = title),
    inherit.aes = FALSE,
    size = 4, hjust = 1.05, vjust = 1
  ) +
  geom_text(
    data = dat_label,
    mapping = aes(x = Inf, y = y_pos, label = diff_anbc, color = model),
    inherit.aes = FALSE,
    size = 4, hjust = 1.1, vjust = 0.8
  )

# =============================================================================
# 8. CLEAN UP ENVIRONMENT
# =============================================================================
rm(base_path, outcomes, model_features, model_suffixes, files_to_load, all_predictions, model_levels, all_predictions_formatted, dat_wide, model_names, dca_formula, outcomes_list, dat_dca, outcome_name, diff_nb, threshold_ranges, dat_plot, dat_label, label_positions, model_color_palette)
   
print("--- Script finished and environment cleaned. ---")

```

### Clinical-based

```{r}

# =============================================================================
# 1. SETUP
# =============================================================================
base_path <- "saved/results/Incident_Probabilities"

outcomes <- c("cad", "stroke", "hf", "af", "pad", "vte")
model_features <- c("Genomics", "Metabolomics", "Proteomics")

model_suffixes <- c(
  "Clinical",
  unlist(map(1:length(model_features), ~ combn(model_features, .x, FUN = paste, collapse = "_"))) %>%
    paste("Clinical", ., sep = "_")
)

# =============================================================================
# 2. LOAD & WRANGLE: Combine all 48 data files into one
# =============================================================================
print("--- Loading and combining all prediction files... ---")

files_to_load <- expand_grid(outcome = outcomes, model_suffix = model_suffixes) %>%
  mutate(
    full_path = file.path(base_path, outcome, paste0("incident_prob_", model_suffix, ".csv"))
  )

all_predictions <- pmap_dfr(
  .l = files_to_load,
  .f = function(outcome, model_suffix, full_path) {
    read_csv(full_path, col_types = cols(.default = "d")) %>%
      mutate(
        outcome = outcome,
        model = model_suffix
      )
  }
)

model_levels <- c("Clin", "*+PRS*", "*+MetScore*", "*+ProScore*", "*+PRS +MetScore*", "*+PRS +ProScore*", "*+MetScore +ProScore*", "*+PRS +MetScore +ProScore*")

all_predictions_formatted <- all_predictions %>%
  mutate(
    model = model %>%
      str_replace("Clinical", "Clin") %>%
      str_replace_all("Genomics", "+PRS") %>%
      str_replace_all("Metabolomics", "+MetScore") %>%
      str_replace_all("Proteomics", "+ProScore") %>%
      str_replace("Clin_", "*") %>%
      str_replace_all("_", " ") %>%
      {if_else(. != "Clin", paste0(., "*"), .)},
    model = factor(model, levels = model_levels),
    outcome = factor(
      outcome,
      levels = c("cad", "stroke", "hf", "af", "pad", "vte"),
      labels = c("CAD", "Stroke", "HF", "AF", "PAD", "VTE")
    )
  )

print("--- Data loading and formatting complete. ---")

# =============================================================================
# 4. RESHAPE DATA TO WIDE FORMAT
# =============================================================================
print("--- Reshaping data to wide format for DCA... ---")

dat_wide <- all_predictions_formatted %>%
  select(eid, outcome, model, risk_15y, event, duration) %>%
  pivot_wider(names_from = model, values_from = risk_15y)

# =============================================================================
# 5. CALCULATE DCA VALUES FOR ALL OUTCOMES
# =============================================================================
print("--- Performing Decision Curve Analysis... (This may take a few minutes) ---")

model_names <- levels(all_predictions_formatted$model)
dca_formula <- as.formula(
  paste("Surv(duration, event) ~", paste(paste0("`", model_names, "`"), collapse = " + "))
)

dat_dca <- tibble()
outcomes_list <- levels(all_predictions_formatted$outcome)
tic("Decision Curve Analysis for all outcomes")
for(outcome_name in outcomes_list){

  print(paste("Running DCA for:", outcome_name, "..."))

  dca_result <- dca(
    formula = dca_formula,
    data = dat_wide %>% filter(outcome == outcome_name),
    time = 15,
    thresholds = seq(0, 0.5, by = 0.001)
  ) %>%
    standardized_net_benefit()
  
  dat_dca <- bind_rows(dat_dca, dca_result$dca %>% mutate(outcome = outcome_name))
  
  rm(dca_result)
}
toc()

# =============================================================================
# 6. CALCULATE THE DIFFERENCE IN AREA UNDER THE NET BENEFIT CURVE (A-NBC)
# =============================================================================
print("--- Calculating A-NBC differences... ---")

diff_nb <- dat_dca %>%
  filter(
    !is.na(standardized_net_benefit) & 
    label %in% c("Clin", "*+PRS*", "*+MetScore*", "*+ProScore*", "*+PRS +MetScore*", "*+PRS +ProScore*", "*+MetScore +ProScore*", "*+PRS +MetScore +ProScore*")
  ) %>%
  arrange(label, outcome, threshold) %>%
  group_by(outcome, label) %>%
  summarise(anbc = trapz(threshold*100, standardized_net_benefit*100), .groups = "drop") %>%
  group_by(outcome) %>%
  mutate(diff_anbc = anbc - anbc[label == "Clin"]) %>%
  ungroup() %>%
  rename(model = label)

# =============================================================================
# 4. PREPARE FINAL DATA FOR PLOTTING
# =============================================================================
threshold_ranges <- tibble(
  outcome = c("CAD", "Stroke", "HF", "AF", "PAD", "VTE"),
  xmin = c(0, 0, 0, 0, 0, 0),
  xmax = c(0.40, 0.15, 0.35, 0.45, 0.20, 0.15)
)

dat_plot <- dat_dca %>%
  rename(model = label) %>%
  inner_join(threshold_ranges, by = "outcome") %>%
  filter(threshold >= xmin & threshold <= xmax) %>%
  select(-xmin, -xmax) %>%
  left_join(diff_nb, by = c("outcome", "model")) %>%
  mutate(outcome = factor(outcome, levels = c("CAD", "Stroke", "HF", "AF", "PAD", "VTE")))

dat_label <- dat_plot %>%
  filter(!is.na(standardized_net_benefit) & !model %in% c("Treat All", "Treat None", "Clin")) %>%
  mutate(diff_anbc = sprintf("%0.2f", diff_anbc)) %>%
  group_by(outcome, model) %>%
  slice_head(n = 1) %>%
  ungroup() %>%
  mutate(title = "A-NBC difference:")

label_positions <- tibble(
    model = levels(all_predictions_formatted$model)[-1],
    y_pos = seq(from = 90, to = 30, length.out = 7)
)
dat_label <- dat_label %>% left_join(label_positions, by="model")

# =============================================================================
# 5. VISUALIZATION: Create the DCA Plot
# =============================================================================
print("--- Generating final DCA plot... ---")

model_color_palette <- c(
  "AgeSex" = "#E64B35E5",
  "*+PRS*" = "#4DBBD5E5",
  "*+MetScore*" = "#00A087E5",
  "*+ProScore*" = "#3C5488E5",
  "*+PRS +MetScore*" = "#F39B7FE5",
  "*+PRS +ProScore*" = "#8491B4E5",
  "*+MetScore +ProScore*" = "#91D1C2E5",
  "*+PRS +MetScore +ProScore*" = "#DC0000E5"
)

dca_plot_clin <- dat_plot %>% 
  filter(!is.na(standardized_net_benefit) & !model %in% c("Treat All", "Treat None")) %>%
  ggplot(aes(x = threshold * 100, y = standardized_net_benefit * 100, color = model)) +
  geom_line(
    data = dat_plot %>% filter(model == "Treat All"), color = "gray", linetype = "dashed", linewidth = 0.75
  ) +
  geom_line(
    data = dat_plot %>% filter(model == "Treat None"), color = "gray", linetype = "dashed", linewidth = 0.75
  ) +
  geom_line(linewidth = 0.8) + 
  theme_classic() +
  theme(
    axis.text = element_text(size = 12, colour = "black"),
    axis.title = element_text(size = 12, colour = "black"),
    legend.title = element_blank(),
    legend.text = element_markdown(size = 12),
    legend.position = "none",
    strip.background = element_blank(),
    strip.text = element_text(size = 12),
    panel.spacing = unit(1, "lines")
  ) +
  scale_colour_manual(values = model_color_palette) + 
  coord_cartesian(ylim = c(-5, 102)) +
  facet_wrap(~ outcome, scales = "free") + 
  labs(
    x = "Threshold probability (%)", 
    y = "Standardized net benefit", 
    color = ""
  ) +
  geom_text(
    data = dat_label %>% group_by(outcome) %>% slice(1) %>% ungroup(),
    mapping = aes(x = Inf, y = 100, label = title),
    inherit.aes = FALSE,
    size = 4, hjust = 1.05, vjust = 1
  ) +
  geom_text(
    data = dat_label,
    mapping = aes(x = Inf, y = y_pos, label = diff_anbc, color = model),
    inherit.aes = FALSE,
    size = 4, hjust = 1.1, vjust = 0.8
  )

# =============================================================================
# 8. CLEAN UP ENVIRONMENT
# =============================================================================
rm(base_path, outcomes, model_features, model_suffixes, files_to_load, all_predictions, model_levels, all_predictions_formatted, dat_wide, model_names, dca_formula, outcomes_list, dat_dca, outcome_name, diff_nb, threshold_ranges, dat_plot, dat_label, label_positions, model_color_palette)
   
print("--- Script finished and environment cleaned. ---")

```

### PANEL-based

```{r}

# =============================================================================
# 1. SETUP
# =============================================================================
base_path <- "saved/results/Incident_Probabilities"

outcomes <- c("cad", "stroke", "hf", "af", "pad", "vte")
model_features <- c("Genomics", "Metabolomics", "Proteomics")

model_suffixes <- c(
  "PANEL",
  unlist(map(1:length(model_features), ~ combn(model_features, .x, FUN = paste, collapse = "_"))) %>%
    paste("PANEL", ., sep = "_")
)

# =============================================================================
# 2. LOAD & WRANGLE: Combine all 48 data files into one
# =============================================================================
print("--- Loading and combining all prediction files... ---")

files_to_load <- expand_grid(outcome = outcomes, model_suffix = model_suffixes) %>%
  mutate(
    full_path = file.path(base_path, outcome, paste0("incident_prob_", model_suffix, ".csv"))
  )

all_predictions <- pmap_dfr(
  .l = files_to_load,
  .f = function(outcome, model_suffix, full_path) {
    read_csv(full_path, col_types = cols(.default = "d")) %>%
      mutate(
        outcome = outcome,
        model = model_suffix
      )
  }
)

model_levels <- c("PANEL", "*+PRS*", "*+MetScore*", "*+ProScore*", "*+PRS +MetScore*", "*+PRS +ProScore*", "*+MetScore +ProScore*", "*+PRS +MetScore +ProScore*")

all_predictions_formatted <- all_predictions %>%
  mutate(
    model = model %>%
      str_replace_all("Genomics", "+PRS") %>%
      str_replace_all("Metabolomics", "+MetScore") %>%
      str_replace_all("Proteomics", "+ProScore") %>%
      str_replace("PANEL_", "*") %>%
      str_replace_all("_", " ") %>%
      {if_else(. != "PANEL", paste0(., "*"), .)},
    model = factor(model, levels = model_levels),
    outcome = factor(
      outcome,
      levels = c("cad", "stroke", "hf", "af", "pad", "vte"),
      labels = c("CAD", "Stroke", "HF", "AF", "PAD", "VTE")
    )
  )

print("--- Data loading and formatting complete. ---")

# =============================================================================
# 4. RESHAPE DATA TO WIDE FORMAT
# =============================================================================
print("--- Reshaping data to wide format for DCA... ---")

dat_wide <- all_predictions_formatted %>%
  select(eid, outcome, model, risk_15y, event, duration) %>%
  pivot_wider(names_from = model, values_from = risk_15y)

# =============================================================================
# 5. CALCULATE DCA VALUES FOR ALL OUTCOMES
# =============================================================================
print("--- Performing Decision Curve Analysis... (This may take a few minutes) ---")

model_names <- levels(all_predictions_formatted$model)
dca_formula <- as.formula(
  paste("Surv(duration, event) ~", paste(paste0("`", model_names, "`"), collapse = " + "))
)

dat_dca <- tibble()
outcomes_list <- levels(all_predictions_formatted$outcome)
tic("Decision Curve Analysis for all outcomes")
for(outcome_name in outcomes_list){

  print(paste("Running DCA for:", outcome_name, "..."))

  dca_result <- dca(
    formula = dca_formula,
    data = dat_wide %>% filter(outcome == outcome_name),
    time = 15,
    thresholds = seq(0, 0.5, by = 0.001)
  ) %>%
    standardized_net_benefit()
  
  dat_dca <- bind_rows(dat_dca, dca_result$dca %>% mutate(outcome = outcome_name))
  
  rm(dca_result)
}
toc()

# =============================================================================
# 6. CALCULATE THE DIFFERENCE IN AREA UNDER THE NET BENEFIT CURVE (A-NBC)
# =============================================================================
print("--- Calculating A-NBC differences... ---")

diff_nb <- dat_dca %>%
  filter(
    !is.na(standardized_net_benefit) & 
    label %in% c("PANEL", "*+PRS*", "*+MetScore*", "*+ProScore*", "*+PRS +MetScore*", "*+PRS +ProScore*", "*+MetScore +ProScore*", "*+PRS +MetScore +ProScore*")
  ) %>%
  arrange(label, outcome, threshold) %>%
  group_by(outcome, label) %>%
  summarise(anbc = trapz(threshold*100, standardized_net_benefit*100), .groups = "drop") %>%
  group_by(outcome) %>%
  mutate(diff_anbc = anbc - anbc[label == "PANEL"]) %>%
  ungroup() %>%
  rename(model = label)


# =============================================================================
# 4. PREPARE FINAL DATA FOR PLOTTING
# =============================================================================
threshold_ranges <- tibble(
  outcome = c("CAD", "Stroke", "HF", "AF", "PAD", "VTE"),
  xmin = c(0, 0, 0, 0, 0, 0),
  xmax = c(0.40, 0.15, 0.35, 0.45, 0.20, 0.15)
)

dat_plot <- dat_dca %>%
  rename(model = label) %>%
  inner_join(threshold_ranges, by = "outcome") %>%
  filter(threshold >= xmin & threshold <= xmax) %>%
  select(-xmin, -xmax) %>%
  left_join(diff_nb, by = c("outcome", "model")) %>%
  mutate(outcome = factor(outcome, levels = c("CAD", "Stroke", "HF", "AF", "PAD", "VTE")))

dat_label <- dat_plot %>%
  filter(!is.na(standardized_net_benefit) & !model %in% c("Treat All", "Treat None", "PANEL")) %>%
  mutate(diff_anbc = sprintf("%0.2f", diff_anbc)) %>%
  group_by(outcome, model) %>%
  slice_head(n = 1) %>%
  ungroup() %>%
  mutate(title = "A-NBC difference:")

label_positions <- tibble(
    model = levels(all_predictions_formatted$model)[-1],
    y_pos = seq(from = 90, to = 30, length.out = 7)
)
dat_label <- dat_label %>% left_join(label_positions, by="model")


# =============================================================================
# 5. VISUALIZATION: Create the DCA Plot
# =============================================================================
print("--- Generating final DCA plot... ---")

model_color_palette <- c(
  "AgeSex" = "#E64B35E5",
  "*+PRS*" = "#4DBBD5E5",
  "*+MetScore*" = "#00A087E5",
  "*+ProScore*" = "#3C5488E5",
  "*+PRS +MetScore*" = "#F39B7FE5",
  "*+PRS +ProScore*" = "#8491B4E5",
  "*+MetScore +ProScore*" = "#91D1C2E5",
  "*+PRS +MetScore +ProScore*" = "#DC0000E5"
)

dca_plot_panel <- dat_plot %>% 
  filter(!is.na(standardized_net_benefit) & !model %in% c("Treat All", "Treat None")) %>%
  ggplot(aes(x = threshold * 100, y = standardized_net_benefit * 100, color = model)) +
  geom_line(
    data = dat_plot %>% filter(model == "Treat All"), color = "gray", linetype = "dashed", linewidth = 0.75
  ) +
  geom_line(
    data = dat_plot %>% filter(model == "Treat None"), color = "gray", linetype = "dashed", linewidth = 0.75
  ) +
  geom_line(linewidth = 0.8) + 
  theme_classic() +
  theme(
    axis.text = element_text(size = 12, colour = "black"),
    axis.title = element_text(size = 12, colour = "black"),
    legend.title = element_blank(),
    legend.text = element_markdown(size = 12),
    legend.position = "none",
    strip.background = element_blank(),
    strip.text = element_text(size = 12),
    panel.spacing = unit(1, "lines")
  ) +
  scale_colour_manual(values = model_color_palette) + 
  coord_cartesian(ylim = c(-5, 102)) +
  facet_wrap(~ outcome, scales = "free") + 
  labs(
    x = "Threshold probability (%)", 
    y = "Standardized net benefit", 
    color = ""
  ) +
  geom_text(
    data = dat_label %>% group_by(outcome) %>% slice(1) %>% ungroup(),
    mapping = aes(x = Inf, y = 100, label = title),
    inherit.aes = FALSE,
    size = 4, hjust = 1.05, vjust = 1
  ) +
  geom_text(
    data = dat_label,
    mapping = aes(x = Inf, y = y_pos, label = diff_anbc, color = model),
    inherit.aes = FALSE,
    size = 4, hjust = 1.1, vjust = 0.8
  )

example_plot <- dat_plot %>% 
  filter(outcome == "AF" & !is.na(standardized_net_benefit) & !model %in% c("Treat All", "Treat None")) %>%
  ggplot(aes(x = threshold * 100, y = standardized_net_benefit * 100, color = model)) +
  geom_line(
    data = dat_plot %>% filter(outcome == "AF" & model == "Treat All"), color = "gray", linetype = "dashed", linewidth = 0.75
  ) +
  geom_line(
    data = dat_plot %>% filter(outcome == "AF" & model == "Treat None"), color = "gray", linetype = "dashed", linewidth = 0.75
  ) +
  geom_line(linewidth = 0.8) + 
  theme_classic() +
  theme(
    axis.text = element_text(size = 12, colour = "black"),
    axis.title = element_text(size = 12, colour = "black"),
    legend.title = element_blank(),
    legend.text = element_markdown(size = 12),
    legend.position = "none",
    strip.background = element_blank(),
    strip.text = element_text(size = 12),
    panel.spacing = unit(1, "lines")
  ) +
  scale_colour_manual(values = model_color_palette) + 
  coord_cartesian(ylim = c(-5, 102)) +
  labs(
    x = "Threshold probability (%)", 
    y = "Standardized net benefit", 
    color = ""
  )

ggsave(str_c(getwd(), "/results/Figure/Model_decision_curve_example.png"), plot = example_plot, width = 4, height = 3, unit = "in", dpi = 300, device = "png")

# =============================================================================
# 8. CLEAN UP ENVIRONMENT
# =============================================================================
rm(base_path, outcomes, model_features, model_suffixes, files_to_load, all_predictions, model_levels, all_predictions_formatted, dat_wide, model_names, dca_formula, outcomes_list, dat_dca, outcome_name, diff_nb, threshold_ranges, dat_plot, dat_label, label_positions, model_color_palette, example_plot)
   
print("--- Script finished and environment cleaned. ---")

```

## Pool

```{r}

# =============================================================================
# 1. DEFINE A REUSABLE FUNCTION FOR PLOT ASSEMBLY AND SAVING
# =============================================================================
assemble_and_save_figure <- function(cal_plot, dca_plot, legend_obj, file_basename, formats_to_save = c("svg", "png", "pdf", "tiff")) {
  
  print(paste("--- Assembling and saving:", basename(file_basename), "---"))
  
  # --- Step 1: Combine the main plots vertically and add tags ---
  plots_tagged <- (cal_plot / dca_plot) +
    plot_annotation(tag_levels = "a") &
    theme(plot.tag = element_text(face = "bold"))
  
  # --- Step 2: Extract the legend ---
  legend_grob <- ggpubr::get_legend(legend_obj)
  
  # --- Step 3: Combine plots and legend using spacers and a 4-column layout ---
  final_layout <- wrap_elements(plots_tagged) +
    plot_spacer() +
    wrap_elements(legend_grob) +
    plot_spacer() +
    plot_layout(
      ncol = 4,
      widths = c(1, 0.05, 0.15, 0.05) 
    )

  # --- Step 4: Save the final figure in the requested formats ---
  dir.create(dirname(file_basename), showWarnings = FALSE, recursive = TRUE)
  
  if ("png" %in% formats_to_save) {
    ggsave(
      paste0(file_basename, ".png"), 
      plot = final_layout, width = 13, height = 12, unit = "in", dpi = 300, device = "png"
    )
  }
  if ("svg" %in% formats_to_save) {
    ggsave(
      paste0(file_basename, ".svg"), 
      plot = final_layout, width = 13, height = 12, unit = "in", dpi = 300, device = "svg"
    )
  }
  if ("pdf" %in% formats_to_save) {
    ggsave(
      paste0(file_basename, ".pdf"), 
      plot = final_layout, width = 13, height = 12, unit = "in", dpi = 300, device = "pdf"
    )
  }
  if ("tiff" %in% formats_to_save) {
    ggsave(
      paste0(file_basename, ".tiff"), 
      plot = final_layout, width = 13, height = 12, unit = "in", dpi = 300, device = "tiff"
    )
  }
}

# =============================================================================
# 2. EXECUTION: Call the function for each model set
# =============================================================================
# ---  AgeSex ---
assemble_and_save_figure(
  cal_plot = cal_plot_agesex,
  dca_plot = dca_plot_agesex,
  legend_obj = legend_agesex,
  file_basename = "results/Figure/Model_calibration_decision_curve_AgeSex",
  formats_to_save = c("svg")
)

# --- Clin ---
assemble_and_save_figure(
  cal_plot = cal_plot_clin,
  dca_plot = dca_plot_clin,
  legend_obj = legend_clin, 
  file_basename = "results/Figure/Model_calibration_decision_curve_Clin",
  formats_to_save = c("svg")
)

# --- PANEL ---
assemble_and_save_figure(
  cal_plot = cal_plot_panel,
  dca_plot = dca_plot_panel,
  legend_obj = legend_panel,
  file_basename = "results/Figure/Model_calibration_decision_curve_PANEL",
  formats_to_save = c("svg", "pdf")
)

# =============================================================================
# 4. CLEAN UP ENVIRONMENT
# =============================================================================
rm(assemble_and_save_figure, cal_plot_agesex, dca_plot_agesex, legend_agesex, cal_plot_clin, dca_plot_clin, legend_clin, cal_plot_panel, dca_plot_panel, legend_panel)

print("--- Script finished and environment cleaned. ---")

```

------------------------------------------------------------------------------------

# SHAP importance

## Mean absolute SHAP value

### Overall

#### Metabolomics

```{r}

# =============================================================================
# 1. SETUP
# =============================================================================
folder_path <- "saved/results/SHAP/OmicsNet/Metabolomics/Final"
nmr_info_path <- "data/dictionary/nmr_info.rda"
outcomes <- c("cad", "stroke", "hf", "af", "pad", "vte")

# =============================================================================
# 2. PROCESS SHAP FILES: Calculate mean absolute SHAP values
# =============================================================================
print("--- Loading dictionary and processing SHAP files... ---")
load(nmr_info_path)
mean_abs_shap_met <- tibble()
for (outcome_name in outcomes) {
  file_path <- file.path(folder_path, paste0("shap_", outcome_name, ".parquet"))
  shap_data <- read_parquet(file_path)
  mean_abs_shap <- shap_data %>%
    summarise(across(-eid, ~ mean(abs(.))))
  reshaped_data <- tibble(
    biomarker = names(mean_abs_shap),
    outcome = outcome_name,
    shap = as.numeric(mean_abs_shap[1, ])
  )
  mean_abs_shap_met <- bind_rows(mean_abs_shap_met, reshaped_data)
}
print("--- SHAP processing complete. ---")

# =============================================================================
# 3. IDENTIFY TOP BIOMARKERS & DEFINE ORDERING
# =============================================================================
top_biomarkers <- mean_abs_shap_met %>%
  group_by(outcome) %>%
  top_n(50, shap) %>%
  ungroup() %>%
  distinct(biomarker)
print(paste("Total number of unique top biomarkers selected:", nrow(top_biomarkers)))

top_five_biomarkers <- mean_abs_shap_met %>%
  group_by(outcome) %>%
  top_n(5, shap) %>%
  ungroup() %>%
  distinct(biomarker)
print("Top 5 biomarkers across diseases:")
print(top_five_biomarkers$biomarker)

top_five_biomarkers <- mean_abs_shap_met %>%
  group_by(outcome) %>%
  top_n(5, shap) %>%
  ungroup() %>%
  arrange(outcome, desc(shap))
print("Top 5 biomarkers across diseases:")
print(top_five_biomarkers)

biomarker_levels <- mean_abs_shap_met %>%
  filter(outcome == "cad") %>%
  arrange(desc(shap)) %>%
  pull(biomarker)

# =============================================================================
# 4. PREPARE FINAL DATA FOR PLOTTING
# =============================================================================
dat_heatmap <- mean_abs_shap_met %>%
  # Rescale SHAP values to 0-1 FOR EACH outcome
  group_by(outcome) %>%
  mutate(shap_rescaled = rescale(shap, to = c(0, 1))) %>%
  ungroup() %>%
  # Keep only the top biomarkers
  filter(biomarker %in% top_biomarkers$biomarker) %>%
  mutate(
    outcome = factor(
      outcome, 
      levels = c("cad", "stroke", "hf", "af", "pad", "vte"),
      labels = c("CAD", "Stroke", "HF", "AF", "PAD", "VTE")
    ),
    biomarker = factor(biomarker, levels = rev(biomarker_levels))
  )

# =============================================================================
# 5. VISUALIZATION: Create the Heatmap
# =============================================================================
print("--- Generating heatmap... ---")

heatmap_met <- ggplot(dat_heatmap, aes(x = outcome, y = biomarker, fill = shap_rescaled)) +
  geom_tile(colour = "white", linewidth = 0.25) + 
  theme_void() +
  scale_fill_gradientn(
    colors = met.brewer("Cassatt1", direction = -1),
    limit = c(0, 1),
    breaks = c(0, 0.5, 1),
    labels = c("0", "0.5", "1"),
    name = "Normalized mean |SHAP|") +
  guides(
    fill = guide_colorbar(
      title.position = "top",
      title.hjust = 0.5,
      barwidth = unit(10, "lines"),
      barheight = unit(0.5, "lines")
    )
  ) +
  theme(
    axis.text.y = element_text(size = 12, colour = "black", hjust = 1),
    axis.text.x = element_text(size = 12, colour = "black", angle = 45, hjust = 1),
    legend.title = element_text(size = 12),
    legend.text = element_text(size = 12)
  )

# =============================================================================
# 6. CREATE AND SAVE TOP 5 BIOMARKER SUMMARY
# =============================================================================
print("--- Creating summary table for top 5 biomarkers... ---")
top_5_summary <- nmr_info %>%
  filter(Biomarker %in% top_five_biomarkers$biomarker) %>%
  mutate(
    Sub.Group = if_else(Sub.Group == "", Group, Sub.Group),
    Sub.Group = sub("\\s*\\(.*\\)", "", Sub.Group)
  ) %>%
  select(
    Biomarker, 
    Description, 
    Sub.Group
  ) %>%
  rename(
    `Full name` = Description,
    Category = Sub.Group
  )

write_csv(top_5_summary, "results/Table/top_5_metabolites_summary.csv")

print("--- Top 5 biomarker summary table saved successfully. ---")

# =============================================================================
# 7. CLEAN UP ENVIRONMENT
# =============================================================================
rm(folder_path, outcomes, mean_abs_shap_met, top_biomarkers, top_five_biomarkers, biomarker_levels, dat_heatmap, outcome_name, file_path, shap_data, mean_abs_shap, reshaped_data, nmr_info_path, nmr_info, top_5_summary)

print("--- Script finished and environment cleaned. ---")

```

#### Proteomics

```{r}

# =============================================================================
# 1. SETUP
# =============================================================================
folder_path <- "saved/results/SHAP/OmicsNet/Proteomics/Final"
outcomes <- c("cad", "stroke", "hf", "af", "pad", "vte")

olink_info_path <- "data/dictionary/olink_assay.dat"
olink_assay <- read_delim(olink_info_path, show_col_types = FALSE, quote = "\t")

# =============================================================================
# 2. PROCESS SHAP FILES: Calculate mean absolute SHAP values
# =============================================================================
print("--- Processing SHAP files... ---")
mean_abs_shap_pro <- tibble()
for (outcome_name in outcomes) {
  file_path <- file.path(folder_path, paste0("shap_", outcome_name, ".parquet"))
  shap_data <- read_parquet(file_path)
  mean_abs_shap <- shap_data %>%
    summarise(across(-eid, ~ mean(abs(.))))
  reshaped_data <- tibble(
    biomarker = names(mean_abs_shap),
    outcome = outcome_name,
    shap = as.numeric(mean_abs_shap[1, ])
  )
  mean_abs_shap_pro <- bind_rows(mean_abs_shap_pro, reshaped_data)
}
print("--- SHAP processing complete. ---")

# =============================================================================
# 3. IDENTIFY TOP BIOMARKERS & DEFINE ORDERING
# =============================================================================
top_biomarkers <- mean_abs_shap_pro %>%
  group_by(outcome) %>%
  top_n(25, shap) %>%
  ungroup() %>%
  distinct(biomarker)
print(paste("Total number of unique top biomarkers selected:", nrow(top_biomarkers)))

top_five_biomarkers <- mean_abs_shap_pro %>%
  group_by(outcome) %>%
  top_n(5, shap) %>%
  ungroup() %>%
  distinct(biomarker)
print("Top 5 biomarkers across diseases:")
print(top_five_biomarkers$biomarker)

top_five_biomarkers <- mean_abs_shap_pro %>%
  group_by(outcome) %>%
  top_n(5, shap) %>%
  ungroup() %>%
  arrange(outcome, desc(shap))
print("Top 5 biomarkers across diseases:")
print(top_five_biomarkers)

biomarker_levels <- mean_abs_shap_pro %>%
  filter(outcome == "cad") %>%
  arrange(desc(shap)) %>%
  pull(biomarker)

# =============================================================================
# 4. PREPARE FINAL DATA FOR PLOTTING
# =============================================================================
dat_heatmap <- mean_abs_shap_pro %>%
  # Rescale SHAP values to 0-1 FOR EACH outcome
  group_by(outcome) %>%
  mutate(shap_rescaled = rescale(shap, to = c(0, 1))) %>%
  ungroup() %>%
  filter(biomarker %in% top_biomarkers$biomarker) %>%
  mutate(
    outcome = factor(
      outcome, 
      levels = c("cad", "stroke", "hf", "af", "pad", "vte"),
      labels = c("CAD", "Stroke", "HF", "AF", "PAD", "VTE")
    ),
    biomarker = factor(biomarker, levels = rev(biomarker_levels))
  )

# =============================================================================
# 5. VISUALIZATION: Create the Heatmap
# =============================================================================
print("--- Generating heatmap... ---")

heatmap_pro <- ggplot(dat_heatmap, aes(x = outcome, y = biomarker, fill = shap_rescaled)) +
  geom_tile(colour = "white", linewidth = 0.25) + 
  theme_void() +
  scale_fill_gradientn(
    colors = met.brewer("Cassatt1", direction = -1),
    limit = c(0, 1),
    breaks = c(0, 0.5, 1),
    labels = c("0", "0.5", "1"),
    name = "Normalized mean |SHAP|") +
  guides(
    fill = guide_colorbar(
      title.position = "top",
      title.hjust = 0.5,
      barwidth = unit(10, "lines"),
      barheight = unit(0.5, "lines")
    )
  ) +
  theme(
    axis.text.y = element_text(size = 12, colour = "black", hjust = 1),
    axis.text.x = element_text(size = 12, colour = "black", angle = 45, hjust = 1),
    legend.title = element_text(size = 12),
    legend.text = element_text(size = 12)
  )

# =============================================================================
# 6. CREATE AND SAVE TOP 5 BIOMARKER SUMMARY
# =============================================================================
print("--- Creating summary table for top 5 biomarkers... ---")
panel_order <- c(
  "Cardiometabolic", "Cardiometabolic II", "Inflammation", "Inflammation II", 
  "Neurology", "Neurology II", "Oncology", "Oncology II"
)
top_5_summary <- olink_assay %>%
  filter(Assay %in% top_five_biomarkers$biomarker) %>%
  select(
    Assay, 
    UniProt, 
    Panel
  ) %>%
  rename(
    Biomarker = Assay,
    UniProt = UniProt,
    Category = Panel
  ) %>%
  mutate(Category = factor(Category, levels = panel_order)) %>%
  arrange(Category)
write_csv(top_5_summary, "results/Table/top_5_proteins_summary.csv")
print("--- Top 5 biomarker summary table saved successfully. ---")

# =============================================================================
# 7. CLEAN UP ENVIRONMENT
# =============================================================================
rm(folder_path, outcomes, mean_abs_shap_pro, top_biomarkers, top_five_biomarkers, biomarker_levels, dat_heatmap, outcome_name, file_path, shap_data, mean_abs_shap, reshaped_data, top_5_summary, olink_info_path, olink_assay)

print("--- Script finished and environment cleaned. ---")

```

#### Pool

```{r}

# =============================================================================
# 1. COMBINE PLOTS
# =============================================================================
shap_heatmap <- (heatmap_met + heatmap_pro) + 
  plot_annotation(tag_levels = "a") +
  plot_layout(guides = "collect") & 
  theme(
    plot.tag = element_text(face = "bold"), 
    legend.position = "bottom"
  )

# =============================================================================
# 2. SAVE AND CLEAN UP
# =============================================================================
ggsave(file.path("results", "Figure", "SHAP_heatmap.pdf"), plot = shap_heatmap, width = 8, height = 16, unit = "in", dpi = 300, device = "pdf")

ggsave(file.path("results", "Figure", "SHAP_heatmap.svg"), plot = shap_heatmap, width = 8, height = 16, unit = "in", dpi = 300, device = "svg")

print("--- Combined SHAP heatmap saved successfully. ---")

rm(heatmap_pro, heatmap_met, shap_heatmap)

print("--- Script finished and environment cleaned. ---")

```

### Metabolomics no statins

```{r}

# =============================================================================
# 1. SETUP
# =============================================================================
folder_path <- "saved/results/SHAP/OmicsNet/Metabolomics_no_statins/Final"
outcomes <- c("cad", "stroke", "hf", "af", "pad", "vte")

# =============================================================================
# 2. PROCESS SHAP FILES: Calculate mean absolute SHAP values
# =============================================================================
print("--- Processing SHAP files... ---")

mean_abs_shap_met <- tibble()
for (outcome_name in outcomes) {
  file_path <- file.path(folder_path, paste0("shap_", outcome_name, ".parquet"))
  shap_data <- read_parquet(file_path)
  mean_abs_shap <- shap_data %>%
    summarise(across(-eid, ~ mean(abs(.))))
  reshaped_data <- tibble(
    biomarker = names(mean_abs_shap),
    outcome = outcome_name,
    shap = as.numeric(mean_abs_shap[1, ])
  )
  mean_abs_shap_met <- bind_rows(mean_abs_shap_met, reshaped_data)
}

print("--- SHAP processing complete. ---")

# =============================================================================
# 3. IDENTIFY TOP BIOMARKERS & DEFINE ORDERING
# =============================================================================
top_biomarkers <- mean_abs_shap_met %>%
  group_by(outcome) %>%
  top_n(50, shap) %>%
  ungroup() %>%
  distinct(biomarker)
print(paste("Total number of unique top biomarkers selected:", nrow(top_biomarkers)))

top_five_biomarkers <- mean_abs_shap_met %>%
  group_by(outcome) %>%
  top_n(5, shap) %>%
  ungroup() %>%
  distinct(biomarker)
print("Top 5 biomarkers across diseases:")
print(top_five_biomarkers$biomarker)

biomarker_levels <- mean_abs_shap_met %>%
  filter(outcome == "cad") %>%
  arrange(desc(shap)) %>%
  pull(biomarker)

# =============================================================================
# 4. PREPARE FINAL DATA FOR PLOTTING
# =============================================================================
dat_heatmap <- mean_abs_shap_met %>%
  group_by(outcome) %>%
  mutate(shap_rescaled = rescale(shap, to = c(0, 1))) %>%
  ungroup() %>%
  filter(biomarker %in% top_biomarkers$biomarker) %>%
  mutate(
    outcome = factor(
      outcome, 
      levels = c("cad", "stroke", "hf", "af", "pad", "vte"),
      labels = c("CAD", "Stroke", "HF", "AF", "PAD", "VTE")
    ),
    biomarker = factor(biomarker, levels = rev(biomarker_levels))
  )

# =============================================================================
# 5. VISUALIZATION: Create the Heatmap
# =============================================================================
print("--- Generating heatmap... ---")

heatmap_met <- ggplot(dat_heatmap, aes(x = outcome, y = biomarker, fill = shap_rescaled)) +
  geom_tile(colour = "white", linewidth = 0.25) + 
  theme_void() +
  scale_fill_gradientn(
    colors = met.brewer("Cassatt1", direction = -1),
    limit = c(0, 1),
    breaks = c(0, 0.5, 1),
    labels = c("0", "0.5", "1"),
    name = "Normalized mean |SHAP|") +
  guides(
    fill = guide_colorbar(
      title.position = "top",
      title.hjust = 0.5,
      barwidth = unit(10, "lines"),
      barheight = unit(0.5, "lines")
    )
  ) +
  theme(
    axis.text.y = element_text(size = 12, colour = "black", hjust = 1),
    axis.text.x = element_text(size = 12, colour = "black", angle = 45, hjust = 1),
    legend.title = element_text(size = 10),
    legend.text = element_text(size = 9),
    legend.position = "bottom"
  )

# =============================================================================
# 6. SAVE and CLEAN UP ENVIRONMENT
# =============================================================================
ggsave(
  file.path("results", "Figure", "SHAP_heatmap_met_no_statins.svg"), 
  plot = wrap_elements(heatmap_met), 
  width = 4, height = 16, unit = "in", dpi = 300, device = "svg"
)

rm(folder_path, outcomes, mean_abs_shap_met, top_biomarkers, top_five_biomarkers, biomarker_levels, dat_heatmap, outcome_name, file_path, shap_data, mean_abs_shap, reshaped_data, heatmap_met)

print("--- Script finished and environment cleaned. ---")

```

## SHAP beeswarm plot

### Metabolomics

```{r}

# =============================================================================
# 1. SETUP
# =============================================================================
shap_folder_path <- "saved/results/SHAP/OmicsNet/Metabolomics/Final"
level_data_path <- "data/split_seed-250901/X_external_test_Metabolomics.feather"
nmr_info_path <- "data/dictionary/nmr_info.rda"

outcomes <- c("cad", "stroke", "hf", "af", "pad", "vte")

# =============================================================================
# 2. GLOBAL DATA LOADING
# =============================================================================
print("--- Loading all necessary data... ---")

level_data <- arrow::read_feather(level_data_path)

load(nmr_info_path)

all_shap_data <- outcomes %>%
  set_names() %>%
  map_dfr(~ read_parquet(file.path(shap_folder_path, paste0("shap_", .x, ".parquet"))), .id = "outcome")

print("--- All data loaded successfully. ---")

# =============================================================================
# 3. FUNCTION TO CREATE A BEESWARM PLOT
# =============================================================================
create_shap_beeswarm_plot <- function(outcome_name, full_shap_data, full_level_data, dict_nmr_info, legend=FALSE) {
  
  print(paste("--- Generating plot for:", toupper(outcome_name), "---"))
  
  # --- Step 1: Filter data for the current outcome ---
  shap_data_filtered <- full_shap_data %>% filter(outcome == outcome_name)
  
  # --- Step 2: Prepare SHAP & Level Data for Plotting (same logic as before) ---
  subgroup_order <- c(
    "Amino acids", "Branched-chain amino acids", "Aromatic amino acids", "Fluid balance", 
    "Inflammation", "Fatty acids", "Glycolysis related metabolites", "Ketone bodies",
    "Total lipids", "Cholesterol", "Free cholesterol", "Cholesteryl esters", 
    "Phospholipids", "Triglycerides", "Other lipids", "Lipoprotein particle sizes", 
    "Lipoprotein particle concentrations", "Chylomicrons and extremely large VLDL", 
    "Very large VLDL", "Large VLDL", "Medium VLDL", "Small VLDL", "Very small VLDL",
    "Large LDL", "Medium LDL", "Small LDL", "IDL", "Very large HDL", "Large HDL", 
    "Medium HDL", "Small HDL", "Apolipoproteins"
  )
  level_data_long <- level_data %>%
    pivot_longer(cols = -eid, names_to = "biomarker", values_to = "level")
  
  shap_data_long <- shap_data_filtered %>%
    select(-outcome) %>%
    pivot_longer(cols = -eid, names_to = "biomarker", values_to = "shap") %>%
    left_join(level_data_long, by = c("eid", "biomarker")) %>%
    merge(., dict_nmr_info %>% select(Biomarker, Group, Sub.Group), by.x = "biomarker", by.y = "Biomarker", all.x = TRUE) %>%
    mutate(
      Sub.Group = if_else(Sub.Group == "", Group, Sub.Group),
      Sub.Group = sub("\\s*\\(.*\\)", "", Sub.Group),
      Sub.Group = factor(Sub.Group, levels = subgroup_order)
    ) %>%
    group_by(biomarker) %>%
    mutate(shap_quantile = ntile(shap, 100)) %>%
    ungroup()
  
  # --- Step 3: Prepare Annotation Data ---
  text_data <- shap_data_long %>%
    distinct(biomarker, Sub.Group) %>%
    arrange(Sub.Group, biomarker) %>%
    group_by(Sub.Group) %>%
    group_modify(~ add_row(.x, biomarker = "")) %>%
    ungroup() %>%
    mutate(id = row_number() + 1)
  
  text_data_v1 <- text_data %>% filter(biomarker != "")
  text_data_v2 <- text_data_v1 %>% 
    group_by(Sub.Group) %>% 
    summarise(id = mean(id)) %>%
    ungroup() %>%
    mutate(
      Sub.Group = case_when(
        Sub.Group == "Branched-chain amino acids" ~ "Branched-chain",
        Sub.Group == "Glycolysis related metabolites" ~ "Glycolysis related",
        Sub.Group == "Lipoprotein particle sizes" ~ "Lipoprotein particle ",
        Sub.Group == "Lipoprotein particle concentrations" ~ "Lipoprotein particle",
        Sub.Group == "Chylomicrons and extremely large VLDL" ~ "Chylomicrons and",
        TRUE ~ Sub.Group
      )
    ) %>%
    bind_rows(.,
      tibble(
        Sub.Group = c("amino acids", "metabolites", "sizes", "concentrations", "extremely large VLDL"),
        id = c(9.5, 32.5, 80, 84.2, 91)
        )
      )
  subgroup_lines <- text_data_v1 %>% group_by(Sub.Group) %>% summarise(start_id = min(id), end_id = max(id))
  
  # --- Step 4: Create the Final Plotting Data ---
  # Core data wrangling step:
  # 1. Convert SHAP values to a long format.
  # 2. Join with feature levels and dictionary information.
  # 3. Create 100 quantiles of SHAP values for each biomarker to reduce the number of points for plotting, improving performance and visual clarity.
  # Ref: 
  # - https://www.nature.com/articles/s41591-022-01980-3/figures/5 (legend)
  # - https://github.com/YanLuoCityU/MetabolomicsCommonDiseases/blob/main/2_analysis/Figure6_Attributions_3_Suns.ipynb
  plot_data <- shap_data_long %>%
    group_by(biomarker, Sub.Group, shap_quantile) %>%
    summarise(mean_shap = mean(shap, na.rm = TRUE), mean_level = mean(level, na.rm = TRUE), .groups = "drop") %>%
    left_join(text_data %>% select(-Sub.Group), by = "biomarker") %>%
    mutate(
      mean_level_truncated = case_when(mean_level < -2 ~ -2, mean_level > 2 ~ 2, TRUE ~ mean_level),
      jitter_factor = 1 - rescale(abs(mean_shap), to = c(0, 1)),
      id_jitter = id + runif(n(), min = -0.2 * jitter_factor, max = 0.2 * jitter_factor)
    )
    
  # --- Step 5: Build the plot ---
  y_limit <- round(max(abs(plot_data$mean_shap), na.rm = TRUE), 1) + 0.1

  beeswarm_plot <- ggplot(plot_data) +
    geom_point(aes(x = id_jitter, y = mean_shap, colour = mean_level_truncated), size = 1, alpha = 0.5) +
    geom_textpath(data = text_data_v1, aes(x = id, label = biomarker, y = y_limit*0.3), color = "black", size = 1.5, angle = 90, hjust = 0, vjust = 0.5) +
    geom_segment(data = subgroup_lines, aes(x = start_id, xend = end_id, y = y_limit*0.3-0.01, yend = y_limit*0.3-0.01), color = "grey50", linewidth = 0.25) +
    geom_hline(yintercept = 0, color = "grey50", linetype = "solid", linewidth = 0.5) +
    geom_hline(yintercept = -y_limit*0.5, color = "grey50", linetype = "dashed", linewidth = 0.5)
  
  if (outcome_name == "cad") {
    beeswarm_plot <- beeswarm_plot +
      geom_textpath(data = text_data_v2, aes(x = id, label = Sub.Group, y = y_limit*0.6+0.04), color = "black", size = 2, fontface = "bold", angle = 90, hjust = 0, vjust = 0.5) +
      geom_segment(data = subgroup_lines, aes(x = start_id, xend = end_id, y = y_limit*0.6+0.03, yend = y_limit*0.6+0.03), color = "grey50", linewidth = 0.25)
  } else {
    beeswarm_plot <- beeswarm_plot +
      geom_textpath(data = text_data_v2, aes(x = id, label = Sub.Group, y = y_limit*0.6), color = "black", size = 2, fontface = "bold", angle = 90, hjust = 0, vjust = 0.5) +
      geom_segment(data = subgroup_lines, aes(x = start_id, xend = end_id, y = y_limit*0.6-0.01, yend = y_limit*0.6-0.01), color = "grey50", linewidth = 0.25)
  }
  
  beeswarm_plot <- beeswarm_plot +
    coord_polar(clip = "off") +
    theme_classic() +
    theme(
      axis.text.x = element_blank(), axis.text.y = element_blank(),
      axis.ticks = element_blank(), axis.line = element_blank(),
      legend.position = "none", panel.background = element_blank(),
      panel.grid  = element_blank(),
      plot.margin = unit(c(t = 0, r = 0, b = 0, l = 0), "cm")
    ) +
    scale_x_continuous(limits = c(0.5, max(text_data$id, na.rm=TRUE))) +
    scale_y_continuous(limits = c(-y_limit, y_limit)) +
    scale_colour_gradientn(
      colors = rev(c("#A90C38FF", "#DB4446FF", "#F78171FF", "#FFBFB2FF", "#FFFFFFFF", "#B4D2E9FF", "#7BA8CCFF", "#5180ACFF", "#2E5A87FF")),
      values = rescale(c(-2, -1, -0.75, -0.5, -0.25, 0, 0.25, 0.5, 0.75, 1, 2))
    ) +
    labs(x = NULL, y = NULL, title = NULL) +
    annotate("text", label = toupper(outcome_name), x = -Inf, y = -y_limit, size = 8, colour = "black")
  
    legend_plot <- ggplot(plot_data) +
      geom_point(aes(x = id_jitter, y = mean_shap, colour = mean_level_truncated), size = 1, alpha = 0.5) +
      theme_classic() +
      theme(
        axis.text.x = element_blank(), axis.text.y = element_blank(),
        axis.ticks = element_blank(), axis.line = element_blank(),
        legend.position = "bottom", panel.background = element_blank(),
        legend.title = element_text(size = 10),
        legend.text = element_text(size = 10),
        panel.grid  = element_blank(),
        plot.margin = unit(c(t = 0, r = 0, b = 0, l = 0), "cm")
      ) +
      scale_colour_gradientn(
        colors = rev(c("#A90C38FF", "#DB4446FF", "#F78171FF", "#FFBFB2FF", "#FFFFFFFF", "#B4D2E9FF", "#7BA8CCFF", "#5180ACFF", "#2E5A87FF")),
        values = rescale(c(-2, -1, -0.75, -0.5, -0.25, 0, 0.25, 0.5, 0.75, 1, 2)),
        breaks = c(-2, 2),
        labels = c("Low", "High"),
        name = "Biomarker value"
      ) +
      guides(
        colour = guide_colorbar(
          title.position = "top",
          title.hjust = 0.5
        )
      )
  
  if (legend == FALSE) {
    return(beeswarm_plot)
  } else {
    return(legend_plot)
  }
}

# =============================================================================
# 4. EXECUTION: Loop through outcomes and generate all plots
# =============================================================================
list_of_plots <- outcomes %>%
  set_names() %>%
  map(~ create_shap_beeswarm_plot(
        outcome_name = .x,
        full_shap_data = all_shap_data,
        full_level_data = level_data,
        dict_nmr_info = nmr_info
      ))

list2env(
  setNames(list_of_plots, paste0("met_beeswarm_plot_", names(list_of_plots))),
  .GlobalEnv
)

legend <- create_shap_beeswarm_plot(outcome = "cad", full_shap_data = all_shap_data, full_level_data = level_data, dict_nmr_info = nmr_info, legend = TRUE)

print("--- All plot objects have been created in your environment. ---")

# =============================================================================
# 5. CLEAN UP ENVIRONMENT
# =============================================================================
rm(all_shap_data, level_data, nmr_info, list_of_plots,
   shap_folder_path, level_data_path, nmr_info_path, outcomes)

print("--- Metabolomics data objects have been removed from the environment. ---")

```

### Proteomics

```{r}

# =============================================================================
# 1. SETUP
# =============================================================================
shap_folder_path <- "saved/results/SHAP/OmicsNet/Proteomics/Final"
level_data_path <- "data/split_seed-250901/X_external_test_Proteomics.feather"
olink_info_path <- "data/dictionary/olink_assay.dat"

outcomes <- c("cad", "stroke", "hf", "af", "pad", "vte")

# =============================================================================
# 2. GLOBAL DATA LOADING
# =============================================================================
print("--- Loading all necessary Proteomics data... ---")

level_data_pro <- read_feather(level_data_path)
olink_assay <- read_delim(olink_info_path, show_col_types = FALSE, quote = "\t")
all_shap_data_pro <- outcomes %>%
  set_names() %>%
  map_dfr(~ read_parquet(file.path(shap_folder_path, paste0("shap_", .x, ".parquet"))), .id = "outcome")

print("--- All data loaded successfully. ---")

# =============================================================================
# 3. IDENTIFY TOP BIOMARKERS (Using the new specified logic)
# =============================================================================
mean_abs_shap_pro <- all_shap_data_pro %>%
  group_by(outcome) %>%
  summarise(across(-eid, ~ mean(abs(.)))) %>%
  pivot_longer(-outcome, names_to = "biomarker", values_to = "shap")

top_biomarkers_pro <- mean_abs_shap_pro %>%
  group_by(outcome) %>%
  top_n(50, shap) %>% 
  ungroup() %>%
  distinct(biomarker) %>%
  pull(biomarker)
print(paste("Total number of unique top biomarkers selected:", length(top_biomarkers_pro)))

# =============================================================================
# 4. FUNCTION TO CREATE A BEESWARM PLOT
# =============================================================================
create_pro_shap_beeswarm_plot <- function(outcome_name, full_shap_data, full_level_data, dict_olink, top_biomarkers_list) {
  
  print(paste("--- Generating plot for:", toupper(outcome_name), "---"))
  
  # --- Step 1: Filter data for the current outcome ---
  shap_data_filtered <- full_shap_data %>% filter(outcome == outcome_name)
  
  # --- Step 2: Prepare SHAP & Level Data for Plotting ---
  subgroup_order <- c("Cardiometabolic", "Cardiometabolic II", "Inflammation", "Inflammation II", "Neurology", "Neurology II", "Oncology", "Oncology II")
  
  level_data_long <- full_level_data %>%
    pivot_longer(cols = -eid, names_to = "biomarker", values_to = "level")
  
  shap_data_long <- shap_data_filtered %>%
    select(eid, any_of(top_biomarkers_list)) %>%
    pivot_longer(cols = -eid, names_to = "biomarker", values_to = "shap") %>%
    left_join(level_data_long, by = c("eid", "biomarker")) %>%
    merge(., dict_olink %>% select(Assay, Panel), by.x = "biomarker", by.y = "Assay") %>%
    mutate(Panel = factor(Panel, levels = subgroup_order)) %>%
    group_by(biomarker) %>%
    mutate(shap_quantile = ntile(shap, 100)) %>%
    ungroup()
  
  # --- Step 3: Prepare Annotation Data ---
  text_data <- shap_data_long %>%
    distinct(biomarker, Panel) %>%
    arrange(Panel, biomarker) %>%
    group_by(Panel) %>%
    group_modify(~ add_row(.x, biomarker = "")) %>%
    ungroup() %>%
    mutate(id = row_number() + 1)
  
  text_data_v1 <- text_data %>% filter(biomarker != "")
  text_data_v2 <- text_data_v1 %>% group_by(Panel) %>% summarise(id = mean(id))
  subgroup_lines <- text_data_v1 %>% group_by(Panel) %>% summarise(start_id = min(id), end_id = max(id))
  
  # --- Step 4: Create the Final Plotting Data ---
  plot_data <- shap_data_long %>%
    group_by(biomarker, Panel, shap_quantile) %>%
    summarise(mean_shap = mean(shap, na.rm = TRUE), mean_level = mean(level, na.rm = TRUE), .groups = "drop") %>%
    left_join(text_data %>% select(-Panel), by = "biomarker") %>%
    mutate(
      mean_level_truncated = case_when(mean_level < -2 ~ -2, mean_level > 2 ~ 2, TRUE ~ mean_level),
      jitter_factor = 1 - rescale(abs(mean_shap), to = c(0, 1)),
      id_jitter = id + runif(n(), min = -0.2 * jitter_factor, max = 0.2 * jitter_factor)
    )
    
  # --- Step 5: Build the plot (same plotting details) ---
  y_limit <- round(max(abs(plot_data$mean_shap), na.rm = TRUE), 1) + 0.1
  
  beeswarm_plot <- ggplot(plot_data) +
    geom_point(aes(x = id_jitter, y = mean_shap, colour = mean_level_truncated), size = 1, alpha = 0.5) +
    geom_textpath(data = text_data_v1, aes(x = id, label = biomarker, y = y_limit*0.3), color = "black", size = 1.5, angle = 90, hjust = 0, vjust = 0.5) +
    geom_textpath(data = text_data_v2, aes(x = id, label = Panel, y = y_limit*0.7), color = "black", size = 2, fontface = "bold", angle = 90, hjust = 0, vjust = 0.5) +
    geom_segment(data = subgroup_lines, aes(x = start_id, xend = end_id, y = y_limit*0.3-0.01, yend = y_limit*0.3-0.01), color = "grey50", linewidth = 0.25) +
    geom_segment(data = subgroup_lines, aes(x = start_id, xend = end_id, y = y_limit*0.7-0.01, yend = y_limit*0.7-0.01), color = "grey50", linewidth = 0.25) +
    geom_hline(yintercept = 0, color = "grey50", linetype = "solid", linewidth = 0.5) +
    geom_hline(yintercept = -y_limit*0.5, color = "grey50", linetype = "dashed", linewidth = 0.5) +
    coord_polar(clip = "off") +
    theme_classic() +
    theme(
      axis.text.x = element_blank(), axis.text.y = element_blank(),
      axis.ticks = element_blank(), axis.line = element_blank(),
      legend.position = "none", panel.grid  = element_blank(),
      plot.margin = unit(c(t = 0, r = 0, b = 0, l = 0), "cm")
    ) +
    scale_x_continuous(limits = c(0.5, max(text_data$id, na.rm=TRUE))) +
    scale_y_continuous(limits = c(-y_limit, y_limit)) +
    scale_colour_gradientn(
      colors = rev(c("#A90C38FF", "#DB4446FF", "#F78171FF", "#FFBFB2FF", "#FFFFFFFF", "#B4D2E9FF", "#7BA8CCFF", "#5180ACFF", "#2E5A87FF")),
      values = rescale(c(-2, -1, -0.75, -0.5, -0.25, 0, 0.25, 0.5, 0.75, 1, 2))
    ) +
    labs(x = NULL, y = NULL, title = NULL) +
    annotate("text", label = toupper(outcome_name), x = -Inf, y = -y_limit, size = 8, colour = "black")
    
  return(beeswarm_plot)
}

# =============================================================================
# 5. EXECUTION: Loop through outcomes and generate all plots
# =============================================================================
list_of_plots <- outcomes %>%
  set_names() %>%
  map(~ create_pro_shap_beeswarm_plot(
        outcome_name = .x,
        full_shap_data = all_shap_data_pro,
        full_level_data = level_data_pro,
        dict_olink = olink_assay,
        top_biomarkers_list = top_biomarkers_pro
      ))

list2env(
  setNames(list_of_plots, paste0("pro_beeswarm_plot_", names(list_of_plots))),
  .GlobalEnv
)

print("--- All Proteomics plot objects have been created in your environment. ---")

# =============================================================================
# 6. CLEAN UP ENVIRONMENT
# =============================================================================
rm(all_shap_data_pro, level_data_pro, olink_assay, mean_abs_shap_pro,
   top_biomarkers_pro, list_of_plots, shap_folder_path, level_data_path,
   olink_info_path, outcomes)

print("--- Proteomics data objects have been removed from the environment. ---")

```

### Pool

#### CAD

```{r}

# --- Part 1: Create the custom direction legend ---
arrow_data <- data.frame(
  x = c(0.5, 0.75),
  y = c(1, 0.75),
  xend = c(1, 0.85),
  yend = c(0.5, 1.2)
)

direction_legend <- ggplot() +
  geom_curve(data = arrow_data[1,], aes(x = x, y = y, xend = xend, yend = yend), curvature = -0.4, color = "black") +
  geom_segment(data = arrow_data[2,], aes(x = x, y = y, xend = xend, yend = yend), arrow = arrow(length = unit(0.2, "cm")), color = "black") +
  geom_segment(data = arrow_data[2,], aes(x = xend, y = yend, xend = x, yend = y), arrow = arrow(length = unit(0.2, "cm")), color = "black") +
  annotate("text", x = 0.55, y = 1.3, label = "Positive contribution", size = 3, hjust = 0) +
  annotate("text", x = 0.5, y = 0.65, label = "Negative contribution", size = 3, hjust = 0) +
  theme_void()

# --- Part 2: Combine plots ---
met_beeswarm_plot_cad_final <- met_beeswarm_plot_cad + 
  labs(title = "a") +
  theme(
    plot.title = element_text(size = 12, face = "bold", hjust = 0.1, vjust = -20),
    plot.margin = margin(r = -5, l = -5, t = -1, b = -1, unit = "cm")
  )

pro_beeswarm_plot_cad_final <- pro_beeswarm_plot_cad + 
  labs(title = "b") +
  theme(
    plot.title = element_text(size = 12, face = "bold", hjust = 0.1, vjust = -20),
    plot.margin = margin(l = -5, r = -5, t = -1, b = -1, unit = "cm")
  )

main_legend <- ggpubr::get_legend(legend)

combined_layout <- (wrap_elements(met_beeswarm_plot_cad_final) + wrap_elements(pro_beeswarm_plot_cad_final))

final_plot <- wrap_elements(combined_layout) +
  inset_element(
    direction_legend,
    left = 0.44,
    right = 0.56,
    bottom = 0.70,
    top = 0.87
  ) +
  inset_element(
    main_legend,
    left = 0.44,
    right = 0.56,
    bottom = 0.05,
    top = 0.15
  )

# --- Part 3: Save the final combined plot ---
ggsave(str_c(getwd(), "/results/Figure/Beeswarm_pro_cad.pdf"), plot = final_plot, width = 14, height = 7, unit = "in", dpi = 300, device = "pdf")

ggsave(str_c(getwd(), "/results/Figure/Beeswarm_pro_cad.svg"), plot = final_plot, width = 14, height = 7, unit = "in", dpi = 300, device = "svg")

print("--- Final combined plot saved successfully. ---")

# =============================================================================
# 5. CLEAN UP ENVIRONMENT
# =============================================================================
rm(arrow_data, direction_legend, met_beeswarm_plot_cad_final, pro_beeswarm_plot_cad_final, main_legend, combined_layout, final_plot)

print("--- Script finished and environment cleaned. ---")

```

#### Other CVDs

```{r}

# =============================================================================
# 2. PREPARE SHARED FIGURE COMPONENTS
# =============================================================================
# --- Part 2a: Create the custom direction legend ---
arrow_data <- data.frame(
  x = c(0.5, 0.7), y = c(1, 0.75),
  xend = c(1, 0.95), yend = c(0.5, 1)
)
direction_legend <- ggplot() +
  geom_curve(data = arrow_data[1,], aes(x = x, y = y, xend = xend, yend = yend), curvature = -0.4, color = "black") +
  geom_segment(data = arrow_data[2,], aes(x = x, y = y, xend = xend, yend = yend), arrow = arrow(length = unit(0.2, "cm")), color = "black") +
  geom_segment(data = arrow_data[2,], aes(x = xend, y = yend, xend = x, yend = y), arrow = arrow(length = unit(0.2, "cm")), color = "black") +
  annotate("text", x = 0.725, y = 1.05, label = "Positive contribution", size = 3.5, hjust = 0) +
  annotate("text", x = 0.5, y = 0.7, label = "Negative contribution", size = 3.5, hjust = 0) +
  theme_void()

# --- Part 2b: Extract the main color legend ---
main_legend <- ggpubr::get_legend(legend)

# =============================================================================
# 3. ASSEMBLE AND SAVE METABOLOMICS FIGURE
# =============================================================================
print("--- Assembling Metabolomics figure... ---")

met_stroke_wrap <- wrap_elements(met_beeswarm_plot_stroke + plot_annotation(title = "a", theme = theme(plot.title = element_text(size = 12, face = "bold"))))
met_hf_wrap     <- wrap_elements(met_beeswarm_plot_hf     + plot_annotation(title = "b", theme = theme(plot.title = element_text(size = 12, face = "bold"))))
met_af_wrap     <- wrap_elements(met_beeswarm_plot_af     + plot_annotation(title = "c", theme = theme(plot.title = element_text(size = 12, face = "bold"))))
met_pad_wrap    <- wrap_elements(met_beeswarm_plot_pad    + plot_annotation(title = "d", theme = theme(plot.title = element_text(size = 12, face = "bold"))))
met_vte_wrap    <- wrap_elements(met_beeswarm_plot_vte    + plot_annotation(title = "e", theme = theme(plot.title = element_text(size = 12, face = "bold"))))

met_layout <- 
  (met_stroke_wrap | met_hf_wrap | met_af_wrap) / 
  (met_pad_wrap    | met_vte_wrap | main_legend)

# Add the inset legend
final_met_plot <- wrap_elements(met_layout) +
  inset_element(
    direction_legend,
    left = 0.775, right = 0.875, bottom = 0, top = 0.2
  )

# Save the final plot
ggsave(str_c(getwd(), "/results/Figure/Beeswarm_met_cvds.svg"), plot = final_met_plot, width = 24, height = 16, unit = "in", dpi = 300, device = "svg")
print("--- Metabolomics figure saved successfully. ---")

# =============================================================================
# 4. ASSEMBLE AND SAVE PROTEOMICS FIGURE
# =============================================================================
print("--- Assembling Proteomics figure... ---")

pro_stroke_wrap <- wrap_elements(pro_beeswarm_plot_stroke + plot_annotation(title = "a", theme = theme(plot.title = element_text(size = 12, face = "bold"))))
pro_hf_wrap     <- wrap_elements(pro_beeswarm_plot_hf     + plot_annotation(title = "b", theme = theme(plot.title = element_text(size = 12, face = "bold"))))
pro_af_wrap     <- wrap_elements(pro_beeswarm_plot_af     + plot_annotation(title = "c", theme = theme(plot.title = element_text(size = 12, face = "bold"))))
pro_pad_wrap    <- wrap_elements(pro_beeswarm_plot_pad    + plot_annotation(title = "d", theme = theme(plot.title = element_text(size = 12, face = "bold"))))
pro_vte_wrap    <- wrap_elements(pro_beeswarm_plot_vte    + plot_annotation(title = "e", theme = theme(plot.title = element_text(size = 12, face = "bold"))))

pro_layout <- 
  (pro_stroke_wrap | pro_hf_wrap | pro_af_wrap) / 
  (pro_pad_wrap    | pro_vte_wrap | main_legend)

final_pro_plot <- wrap_elements(pro_layout) +
  inset_element(
    direction_legend,
    left = 0.775, right = 0.875, bottom = 0, top = 0.2
  )

# Save the final plot
ggsave(str_c(getwd(), "/results/Figure/Beeswarm_pro_cvds.svg"), plot = final_pro_plot, width = 24, height = 16, unit = "in", dpi = 300, device = "svg")
print("--- Proteomics figure saved successfully. ---")

# =============================================================================
# 5. CLEAN UP ENVIRONMENT
# =============================================================================
rm(arrow_data, direction_legend, main_legend,
   met_layout, final_met_plot, met_stroke_wrap, met_hf_wrap, met_af_wrap, met_pad_wrap, met_vte_wrap,
   pro_layout, final_pro_plot, pro_stroke_wrap, pro_hf_wrap, pro_af_wrap, pro_pad_wrap, pro_vte_wrap,
   legend,
   met_beeswarm_plot_af, met_beeswarm_plot_cad, met_beeswarm_plot_hf,
   met_beeswarm_plot_pad, met_beeswarm_plot_stroke, met_beeswarm_plot_vte,
   pro_beeswarm_plot_af, pro_beeswarm_plot_cad, pro_beeswarm_plot_hf,
   pro_beeswarm_plot_pad, pro_beeswarm_plot_stroke, pro_beeswarm_plot_vte)

print("--- Script finished and environment cleaned. ---")

```

